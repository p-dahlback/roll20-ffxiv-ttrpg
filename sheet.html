<link rel="stylesheet" href="sheet.css" />

<!-- Character name and race -->

<div class="top section">
    <div class="type">
        <img src="Images/WAR_Symbol_Token.png" width="50" />
    </div>

    <div class="name content vertical">
        <label class="small">Name</label>
        <input class="medium" name="attr_character_name" type="text" value="Kokopoko">
    </div>
    
    <div class="race content vertical">
        <label class="small">Race</label>
        <input class="medium" name="attr_character_race" type="text" value="Lalafell">
    </div>
</div>

<!-- Tab buttons -->

<input type="hidden" class="tabstoggle" name="attr_sheetTab" value="character" />
<div class="tab">
    <button type="action" name="act_character" class="sheet-button0">Character</button>
    <button type="action" name="act_items" class="sheet-button1">Inventory</button>
    <button type="action" name="act_abilities" class="sheet-button2">Abilities</button>
    <button type="action" name="act_override" class="sheet-button3 floatRight">...</button>
</div>

<!-- Profile page -->
<div class="character">
    <div class="grid">

        <!-- Profile page, Level and Profile -->

        <div class="left section">
            <div class="basic-info horizontal">
                <div class="level flex horizontal tight">
                    <label class="large">LV</label>
                    <input name="attr_level" type="number" value="30">
                </div>
                <div class="job vertical">
                    <label class="small">Role / Job</label>
                    <input class="job-input medium" name="attr_job" type="text" value="TANK / WARRIOR">
                </div>
            </div>
        
            <div class="image section">
                <img name="attr_character_avatar">
            </div>

            <!-- Profile -->

            <div class="profile section">
                <h3 class="small">Profile</h3>

                <!-- Trait -->

                <div class="trait horizontal">
                    <label class="mini">Trait:</label>
                    <input class="mini" name="attr_trait" type="text" value="Indomitable" />
                </div>
                <div class="traitEffect" list>
                    <label class="mini">Effect:</label>
                    <textarea class="mini" name="attr_traitEffect" placeholder="The effect provided by your trait">You've slipped from death more times than you can count. Receive one advantage die on checks to endure pain or push your body beyond its natural limits.</textarea>
                </div>

                <!-- Title  -->

                <div class="title horizontal">
                    <label class="mini">Title:</label>
                    <input class="mini" readonly name="attr_selectedTitle" type="text" />
                </div>
                <div class="title-effect list">
                    <label class="mini">Effect:</label>
                    <textarea class="mini" readonly name="attr_selectedTitleEffect" placeholder="Select a Title from Inventory"></textarea>
                </div>

                <!-- Minion -->
                 
                <div class="minion horizontal">
                    <label class="mini">Minion:</label>
                    <input class="mini" readonly name="attr_selectedMinion" type="text"/>
                </div>
                <div class="minion-effect list">
                    <label class="mini">Effect:</label>
                    <textarea class="mini" readonly name="attr_selectedMinionEffect" placeholder="Select a Minion from your Inventory"></textarea>
                </div>

            </div>
        </div>
        
        <!-- Profile page, Attributes -->

        <div class="right section">
            <div class="advantage">
                <label class="large">Advantage</label>
                <input name="attr_advantage" type="number" min="-2" max="2" value="0" />
            </div>
            <div class="stat section horizontal">

                <!-- Primary -->

                <div class="main-stat list">
                    <h3 class="medium">Primary Attributes</h3>
                    <div class="stat-block">
                        <button class="medium" name="roll_strength" type="roll" value="/roll @{d20} + @{str}">STR</button>
                        <input class="stat" name="attr_str" type="number" value="5">
                    </div>
                    
                    <div class="stat-block">
                        <button class="medium" name="roll_dexterity" type="roll" value="&{template:default} {{name=Dexterity}} {{Result=[[@{d20}+(@{dex})]]}}">DEX</button>
                        <input class="stat" name="attr_dex" type="number" value="4">
                    </div>
                    
                    <div class="stat-block">
                        <button class="medium" name="roll_vitality" type="roll" value="&{template:default} {{name=Vitality}} {{Result=[[@{d20}+(@{vit})]]}}">VIT</button>
                        <input class="stat" name="attr_vit" type="number" value="3">
                    </div>
                    
                    <div class="stat-block">
                        <button class="medium" name="roll_intelligence" type="roll" value="&{template:default} {{name=Intelligence}} {{Result=[[@{d20}+(@{int})]]}}">INT</button>
                        <input class="stat" name="attr_int" type="number" value="2">
                    </div>
                    
                    <div class="stat-block">
                        <button class="medium" name="roll_mind" type="roll" value="&{template:default} {{name=Mind}} {{Result=[[@{d20}+(@{mnd})]]}}">MND</button>
                        <input class="stat" name="attr_mnd" type="number" value="1">
                    </div>
                </div>
                
                <!-- Secondary -->

                <div class="sub-stat list">
                    <h3 class="medium standard">Secondary Attributes</h3>
                    <div class="stat-block">
                        <label class="medium oneline">Defense</label>
                        <input class="stat" name="attr_defense" type="number" value="15">
                    </div>
                    
                    <div class="stat-block">
                        <label class="medium oneline">Magic Defense</label>
                        <input class="stat" name="attr_magicDefense" type="number" value="12">
                    </div>
                    
                    <div class="stat-block">
                        <label class="medium oneline">Vigilance</label>
                        <input class="stat" name="attr_vigilance" type="number" value="11">
                    </div>
                    
                    <div class="stat-block">
                        <label class="medium oneline">Speed</label>
                        <input class="stat" name="attr_speed" type="number" value="5">
                    </div>
                </div>
            </div> 
        
            <!-- Active stats -->

            <div class="active-stat section">

                <!-- HP -->

                <div class="hit-point section">
                    <label class="text large" style="width: 1em">HP</label>
                    <div class="flex horizontal tight right-aligned">
                        <input class="stat" name="attr_hitPoints" type="number" min="0" value="30"> /
                        <input class="stat max" name="attr_hitPoints_max" type="number" min="0" value="30">
                    </div>
                    <div class="barrier list right-aligned">
                        <label class="mini">Barrier</label>
                        <input class="stat" name="attr_barrierPoints" type="number" min="0" value="10">
                    </div>
                </div>
                
                <!-- MP -->

                <div class="magic-point section">
                    <label class="large" style="width: 1em">MP</label>
                    <div class="current list">
                        <label class="mini">Recover 2MP at the end of the (Adventurer Step)</label>
                        <div class="flex horizontal tight right-aligned">
                            <input class="stat" name="attr_magicPoints" type="number" min="0" value="5"> /
                            <input class="stat max" name="attr_magicPoints_max" type="number" min="0" value="5">
                        </div>
                    </div>
                    <div class="bonus-mp list right-aligned">
                        <label class="mini">Extra</label>
                        <input class="stat" name="attr_bonusMp" type="number" min="0" value="1">
                    </div>
                </div>
            </div>

            <!-- Fortune -->

            <div class="fortune section">
                <div class="flex horizontal tight right-aligned">
                <label class="text large">Fortune</label>
                    <input class="stat" name="attr_fortune" type="number" min="0" value="3">
                </div>
            </div>

            <!-- Effects -->

            <div class="effects section horizontal">
                <div class="buffs">

                </div>
                <div class="enfeeblements">
                    
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Items page -->

<div class="items">
    <div class="section grid">
        <div class="section list">

            <!-- Title List -->

            <h3 class="small">Titles</h3> 
            <fieldset class="repeating_titles">
                <div class="expandable-section grid">
                    <input class="mini" name="attr_title" type="text" placeholder="Enter the title name" />
                    <input class="expand-checkbox" type="checkbox" name="attr_expandItem" value="1" />
                    <div class="expanded-view span2">
                        <div class="title-effect list">
                            <label class="mini">Effect:</label>
                            <textarea class="mini" name="attr_effect" placeholder="The effect provided by your title"></textarea>
                            <button type="action" class="select" name="act_select">Set as current Title</button>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- Minion List -->

            <h3 class="small">Minions</h3>
            <fieldset class="repeating_minions">
                <div class="expandable-section grid">
                    <input class="mini" name="attr_title" type="text" placeholder="Enter the title name" />
                    <input class="expand-checkbox" type="checkbox" name="attr_expandItem" value="1" />
                    <div class="expanded-view span2">
                        <div class="title-effect list">
                            <label class="mini">Effect:</label>
                            <textarea class="mini" name="attr_effect" placeholder="The effect provided by your title"></textarea>
                            <button type="action" class="select" name="act_select">Set as current Title</button>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>

        <!-- Item List -->

        <div class="section list vertical-span2">
            <h3 class="small">Items</h3>
            <fieldset class="repeating_items">
                <div class="expandable-section grid">
                    <div class="item-input">
                        <input class="mini" name="attr_title" type="text" placeholder="Enter the title name" />
                        <input class="mini" name="attr_count" type="number" value="1" />
                    </div>
                    <input class="expand-checkbox" type="checkbox" name="attr_expandItem" value="1" />
                    <div class="expanded-view span2">
                        <div class="title-effect list">
                            <label class="mini">Effect:</label>
                            <textarea class="mini" name="attr_effect" placeholder="The effect provided by your title"></textarea>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>
    </div>
</div>

<!-- Abilities page -->

<div class="abilities">
    <div class="top">

        <!-- Shortcut for HP/MP -->

        <div class="stat-shortcut">

        </div>

        <!-- Limit Break -->
        <div class="limit">

        </div>
    </div>

    <!-- Top abilities (Bard songs) -->
    <input class="job-type" type="hidden" name="attr_job">

    <div class="top-abilities">
        <h3>Song Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_song">

        </fieldset>
    </div>

    <!-- Primary abilities -->

    <details class="primary-abilities">
        <summary>
            <h3>Primary Abilities</h3>
        </summary>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_primary">
            <div class="ability">
                <div class="header list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />

                    <span class="mini flagTitle floatLeft">Title flag:</span>
                    <input type="text" class="titleFlag mini-input floatLeft" name="attr_hasTitle" title="Type flag" placeholder="'e' for editable" />
                    <span class="mini flagTitle floatLeft">Type flag:</span>
                    <input type="text" class="typeFlag mini-input floatLeft" name="attr_hasType" title="Type flag" placeholder="'e' for editable" />
                    <span class="mini flagTitle floatLeft">Cost flag:</span>
                    <input type="text" class="costFlag mini-input floatLeft" name="attr_hasCost" title="Cost flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle floatLeft">Condition flag:</span>
                    <input type="text" class="conditionFlag mini-input" name="attr_hasCondition" title="Condition flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle floatLeft">Trigger flag:</span>
                    <input type="text" class="triggerFlag mini-input" name="attr_hasTrigger" title="Trigger flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle floatLeft">Target flag:</span>
                    <input type="text" class="targetFlag mini-input" name="attr_hasTarget" title="Target flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle floatLeft">Check flag:</span>
                    <input type="text" class="checkFlag mini-input" name="attr_hasCheck" title="Check flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle floatLeft">Uses flag:</span>
                    <input type="text" class="usesFlag mini-input" name="attr_hasUses" title="Uses flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle floatLeft">Icon source:</span>
                    <input type="text" class="iconSource mini-input" name="attr_icon" title="Icon" placeholder="icon source" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_expandItem" />

                    <div class="uses">
                        <input type="hidden" class="usesFlag" name="attr_hasUses" />
                        <input class="max mini-input floatRight" type="number" name="attr_uses_max" min="0" value="1" />
                        <span class="floatRight">/</span>
                        <input class="mini-input floatRight" type="number" name="attr_uses" min="0" value="1" />
                    </div>

                    <div class="header-title">
                        <img class="ability-icon" name="attr_icon" />
                        <div class="title adaptive adaptive--text">
                            <input type="hidden" class="titleFlag" name="attr_hasType" />
                            <span class="bold adaptive--text__span"  name="attr_title">Paladin Combo (Fast Blade + Riot Blade)</span>
                            <textarea class="adaptive--text__textarea" type="text" name="attr_title">Paladin Combo (Fast Blade + Riot Blade)</textarea>
                        </div>
                    </div>

                    <div class="ability-controls">
                        <button type="action" class="ability-action-trigger" name="act_trigger">t</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                        <button type="action" class="ability-action" name="act_share">q</button>
                    </div>

                    <div class="type expanded-view">
                        <span class="mini-title floatLeft">Type:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="typeFlag" name="attr_hasType" />
                            <span class="mini-input italic adaptive--input__span"  name="attr_type">Primary, Physical</span>
                            <input class="mini-input italic adaptive--input__input" type="text" name="attr_type" value="Primary, Physical" />
                        </div>
                    </div>
                    <div class="cost expanded-view">
                        <span class="mini-title floatLeft">Cost:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="costFlag" name="attr_hasCost" />
                            <span class="mini-input adaptive--input__span"  name="attr_cost">2</span>
                            <input class="mini-input adaptive--input__input" type="number" name="attr_cost" value="2" />
                        </div>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="costFlag" name="attr_hasCost" />
                            <span class="mini-input adaptive--input__span"  name="attr_resource">Conviction</span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_resource" value="Conviction" />
                        </div>
                    </div>
                    <div class="condition expanded-view">
                        <span class="mini-title floatLeft">Condition:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="conditionFlag" name="attr_hasCondition" />
                            <span class="mini-input adaptive--text__span"  name="attr_condition">Under the effect of Fang and Claw Bared / Wheel in Motion Ready</span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_condition">Under the effect of Fang and Claw Bared / Wheel in Motion Ready</textarea>
                        </div>
                    </div>
                    <div class="trigger expanded-view">
                        <span class="mini-title floatLeft">Trigger:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="triggerFlag" name="attr_hasTrigger" />
                            <span class="mini-input adaptive--text__span"  name="attr_trigger">Immediately after an ability check for an ability that targets you</span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_trigger">Immediately after an ability check for an ability that targets you</textarea>
                        </div>
                    </div>
                    <div class="target expanded-view">
                        <span class="mini-title floatLeft">Target:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="targetFlag" name="attr_hasTarget" />
                            <span class="mini-input adaptive--text__span"  name="attr_target">Single</span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_target">Single</textarea>
                        </div>
                    </div>
                    <div class="range expanded-view">
                        <span class="mini-title floatLeft">Range:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="targetFlag" name="attr_hasTarget" />
                            <span class="mini-input adaptive--text__span"  name="attr_range">1 square</span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_range">1 square</textarea>
                        </div>
                    </div>
                    <div class="check expanded-view">
                        <span class="mini-title floatLeft">Check:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="checkFlag" name="attr_hasCheck" />
                            <span class="mini-input bold adaptive--input__span"  name="attr_check">STR (d20 + 6)</span>
                            <input class="mini-input bold adaptive--input__input" type="text" name="attr_check" value="STR (d20 + 6)" />
                        </div>
                    </div>
                    <div class="cr expanded-view">
                        <span class="mini-title floatLeft">CR:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="checkFlag" name="attr_hasCheck" />
                            <span class="mini-input adaptive--input__span"  name="attr_cr">Target's Defense</span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_cr" value="Target's Defense" />
                        </div>
                    </div>
                </div>

                <div class="body list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_expandItem" />

                    <span class="mini flagTitle floatLeft">Base effect flag:</span>
                    <input type="text" class="baseEffectFlag mini-input" name="attr_hasBaseEffect" title="Base effect flag" placeholder="'e' for editable"/>
                    <span class="mini flagTitle floatLeft">Direct hit flag:</span>
                    <input type="text" class="directHitFlag mini-input" name="attr_hasDirectHit" title="Direct hit flag" placeholder="'1' to display, 'e' for editable"/>
                    <span class="mini flagTitle floatLeft">Limitation flag:</span>
                    <input type="text" class="limitationFlag mini-input" name="attr_hasLimitation" title="Limitation flag" placeholder="'1' to display, 'e' for editable" />

                    <div class="base-effect expanded-view">
                        <span class="mini-title floatLeft">Base Effect:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="baseEffectFlag" name="attr_hasBaseEffect" />
                            <span class="mini-input adaptive--text__span"  name="attr_baseEffect">Deals 3 damage and inflicts Enmity on the target. Combo: Rage of Halone.</span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_baseEffect">Deals 3 damage and inflicts Enmity on the target. Combo: Rage of Halone.</textarea>
                        </div>
                    </div>
                    <div class="direct-hit expanded-view">
                        <span class="mini-title floatLeft">Direct Hit:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="directHitFlag" name="attr_hasDirectHit" />
                            <span class="mini-input adaptive--text__span"  name="attr_directHit">Deals an additional 2d6 damage.</span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_directHit">Deals an additional 2d6 damage.</textarea>
                        </div>
                    </div>
                    <div class="limitation expanded-view">
                        <span class="mini-title floatLeft">Limitation:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="limitationFlag" name="attr_hasLimitation" />
                            <span class="mini-input adaptive--input__span"  name="attr_limitation">Once per phase.</span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_limitation" value="Once per phase." />
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>
    </details>

    <!-- Sub-abilities (Ninja jutsu) -->

    <div class="sub-abilities">
        <h3>Ninjutsu Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_ninjutsu">

        </fieldset>
    </div>

    <!-- Secondary abilities -->

    <div class="secondary-abilities">
        <h3>Secondary Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_secondary">

        </fieldset>
    </div>

    <!-- Instant abilities -->

    <div class="instant-abilities">
        <h3>Instant Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_instant">

        </fieldset>
    </div>

    <!-- Conditional abilities (Monk techniques) -->

    <div class="conditional-abilities">
        <h3>Technique Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_technique">

        </fieldset>
    </div>
</div>

<div class="override">
    <h3>Manual Override</h3>
    <p>Enables manual input for things the player would normally not mess with, primarily intended for setting up NPC sheets.</p>
    <p>Mess with at your own risk!</p>
    <input type="text" name="attr_override" placeholder="Enter 'auto' to disable manual editing" />
</div>

<!-- ---------------------------SHEET WORKERS----------------- -->

<script type="text/worker">
    // Tabs
    const buttonlist = ["character", "items", "abilities", "override"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, () => {
            setAttrs({
                sheetTab: button
            });
        });
    });
</script>

<script type="text/worker">
    // Title selection
    on("clicked:repeating_titles:select", eventInfo => {
        const rowid = eventInfo.sourceAttribute.split("_")[2]
        getAttrs([
            `repeating_titles_${rowid}_title`, 
            `repeating_titles_${rowid}_effect`
        ], values => {
            // Assign selected title
            setAttrs({
                selectedTitleId: rowid,
                selectedTitle: values[`repeating_titles_${rowid}_title`],
                selectedTitleEffect: values[`repeating_titles_${rowid}_effect`]
            })
        })
    })

    // Minion selection
    on("clicked:repeating_minions:select", eventInfo => {
        const rowid = eventInfo.sourceAttribute.split("_")[2]
        getAttrs([
            `repeating_minions_${rowid}_title`, 
            `repeating_minions_${rowid}_effect`
        ], values => {
            // Assign selected minion
            setAttrs({
                selectedMinionId: rowid,
                selectedMinion: values[`repeating_minions_${rowid}_title`],
                selectedMinionEffect: values[`repeating_minions_${rowid}_effect`]
            })
        })
    })
</script>

<script type="text/worker">
    // Ability actions
    function toggleExpandedStateInSection(eventInfo) {
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]
        getAttrs([`repeating_${section}_${rowId}_expandItem`], values => {
            // Toggle
            const value = values[`repeating_${section}_${rowId}_expandItem`]
            var attributes = {}
            var newValue = "on"
            if (value == "on") { 
                newValue = "off"
            } else if (value == "1") {
                newValue = "off"
            } else if (value == "off") {
                newValue = "on"
            } else if (value == "0") {
                newValue= "on"
            }
            attributes[`repeating_${section}_${rowId}_expandItem`] = newValue
            setAttrs(attributes)
        })
    }

    on("clicked:repeating_song:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

    on("clicked:repeating_primary:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

    on("clicked:repeating_ninjutsu:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

    on("clicked:repeating_secondary:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

    on("clicked:repeating_instant:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

    on("clicked:repeating_technique:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

</script>

<script type="text/worker">
    // Advantage management
    on("change:advantage sheet:opened", () => {
        getAttrs(["advantage"], values => {
            let numberOfAdvantageDice = Math.abs(values.advantage)
            let numberOfDice = 1 + numberOfAdvantageDice
            let keepMarker
            if (values.advantage == 0) {
                keepMarker = ""
            } else if (values.advantage > 0) {
                keepMarker = "kh1"
            } else {
                keepMarker = "kl1"
            }
            setAttrs({
                d20: numberOfDice + "d20" + keepMarker
            })
        })
    })

    // HP Max
    on("change:hitPoints", () => {
        getAttrs(["hitPoints", "hitPoints_max"], values => {
            if (values.hitPoints > values.hitPoints_max) {
                setAttrs({
                    hitPoints: values.hitPoints_max
                })
            }
        })
    })

    // MP Max
    on("change:magicPoints", () => {
        getAttrs(["magicPoints", "magicPoints_max"], values => {
            if (values.magicPoints > values.magicPoints_max) {
                console.log("Reset MP")
                setAttrs({
                    magicPoints: values.magicPoints_max
                })
            }
        })
    })

</script>

<script type="text/worker">
    // Assign override state
    on('change:override', () => {
        getAttrs(['override'], values => {
        console.log("Changed override to " + values.override)
            getSectionIDs('repeating_primary', ids => {
                const output = {}
                ids.forEach(id => output[`repeating_primary_${id}_repeatingOverride`] = values.override)
                setAttrs(output)
            })
        })
    })
</script>

