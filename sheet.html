<link rel="stylesheet" href="sheet.css" />

<!-- Character name and race -->

<div class="sticky section" spellcheck="false">
    <div class="top fancy section">
        <div class="type">
            <img name="attr_jobIcon" width="50" />
        </div>

        <div class="name content vertical tight">
            <span class="header small bold">Name</span>
            <input class="large" name="attr_character_name" type="text">
        </div>
        
        <div class="race content vertical tight">
            <span class="header small bold">Race</span>
            <input class="large" name="attr_character_race" type="text">
        </div>
    </div>

    <!-- Shortcut for HP/MP -->

    <div class="stat-shortcut fancy lowkey section">
        <!-- HP -->

        <div class="points section">
            <div class="stat-header"></div>
            <div class="hit-point section">
                <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                <span class="text header large" style="width: 1em">HP</span>
                <input class="stat" name="attr_hitPoints" type="number" min="0" value="30">
                <span>/</span>
                <input class="stat max" name="attr_hitPoints_max" type="number" min="0" value="30">
                <span class="text header large">Barrier</span>
                <input class="stat" name="attr_barrierPoints" type="number" min="0" value="0">
            </div>
        </div>
        
        <!-- MP, Resource -->

        <div class="points section">
            <div class="small header bold stat-header">
                <span>Recover</span>
                <span name="attr_mpRecovery"></span>
                <span>MP at the end of the (Adventurer Step)</span>
            </div>
            <input type="hidden" class="doubleResourceSwitch" name="attr_resource2" placeholder="placeholder" />
            <div class="resource-point single-resource">
                <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                <span class="text header large" style="width: 1em">MP</span>
                <input class="stat" name="attr_magicPoints" type="number" min="0" value="5">
                <span>/</span>
                <input class="stat max" name="attr_magicPoints_max" type="number" min="0" value="5">

                <input class="text large resourceSwitch overridable" name="attr_resource" type="text" placeholder=" "/>
                <input class="stat resource" name="attr_resourceValue" type="number" min="0">
                <span class="resource">/</span>
                <input class="stat max resource" name="attr_resourceValue_max" type="number" min="0">
            </div>
            <div class="resource-point double-resource">
                <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                <span class="text header large" style="width: 1em">MP</span>
                <input class="stat" name="attr_magicPoints" type="number" min="0" value="5">
                <span>/</span>
                <input class="stat max" name="attr_magicPoints_max" type="number" min="0" value="5">

                <input class="text large overridable" name="attr_resource" type="text" placeholder=" "/>
                <input class="stat" name="attr_resourceValue" type="number" min="0">
                <span class="">/</span>
                <input class="stat max" name="attr_resourceValue_max" type="number" min="0">

                <input class="text large overridable" name="attr_resource2" type="text" placeholder=" "/>
                <input class="stat" name="attr_resource2Value" type="number" min="0">
                <span class="">/</span>
                <input class="stat max" name="attr_resource2Value_max" type="number" min="0">
            </div>
        </div>

        <!-- Advantage -->

        <div class="points advantage" style="width: 25%;">
            <label class="header large stat-header">Advantage</label>
            <div class="horizontal">
                <button class="math-button" type="action" name="act_decreaseAdvantage">-</button>
                <div>
                    <span class="large" style="font-family: dicefontd20;">0</span>
                    <span class="large" name="attr_advantage"></span>
                </div>
                <button class="math-button" type="action" name="act_increaseAdvantage">+</button>
            </div>
            <button type="action" name="act_clearAdvantage">Clear</button>
        </div>
    </div>

    <!-- Tab buttons -->

    <div class="tab">
        <input type="hidden" class="tabstoggle" name="attr_sheetTab" value="character" />
        <button type="action" name="act_character" class="toggle sheet-button0">Character</button>
        <button type="action" name="act_abilities" class="toggle sheet-button2">Abilities</button>
        <button type="action" name="act_items" class="toggle sheet-button1">Inventory</button>

        <div class="mini-effects hidden-controls">
            <fieldset class="repeating_effects">
                <span class="sheet-tooltip">
                    <img class="icon" name="attr_icon" />
                    <span name="attr_name" class="floatLeft"></span>
                </span>
            </fieldset>
        </div>

        <button type="action" name="act_settings" class="toggle sheet-button3">y</button>
    </div>
</div>

<input type="hidden" class="tabstoggle" name="attr_sheetTab" value="character" />

<!-- Profile page -->
<div class="character" spellcheck="false">
    <div class="grid fancy lowkey fill">

        <!-- Profile page, Level and Profile -->

        <div class="left section">
            <div class="basic-info fancy horizontal tight">
                <div class="level flex horizontal tight">
                    <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                    <span class="header large bold">LV</span>
                    <input class="header large bold" name="attr_level" type="number" value="30">
                </div>
                <div class="job vertical">
                    <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                    <span class="header medium bold">Role / Job</span>
                    <input class="job-input header medium" name="attr_role" type="text">
                </div>
            </div>
        
            <div class="image-container section">
                <img class="image" name="attr_character_avatar">
                <div class="fancy overlay"></div>
            </div>

            <!-- Profile -->

            <div class="profile section list">
                <h3 class="small">Profile</h3>

                <!-- Origin  -->
                <div class="origin">
                    <span class="header medium bold">Origin:</span>
                    <input class="medium" type="text" name="attr_origin" placeholder="Ex. Survivor, Urbanite"></span>
                </div>

                <!-- Bonds  -->
                <div class="bonds list">
                    <span class="header medium bold">Bonds:</span>
                    <div class="adaptive adaptive--text floatLeft">
                        <span class="mini-input adaptive--text__span"  name="attr_bonds"></span>
                        <textarea class="mini-input adaptive--text__textarea" name="attr_bonds" placeholder="Ex. Debt, Momodi Modi"></textarea>
                    </div>
                </div>

                <hr class="small-hr" />

                <!-- Title  -->

                <div class="title">
                    <span class="header medium bold">Title:</span>
                    <span class="medium" style="margin-left: 8px;" name="attr_selectedTitle">Select a title from Inventory</span>
                </div>
                <div class="title-effect list">
                    <span class="header medium bold">Effect: </span>
                    <span class="medium" name="attr_selectedTitleEffect"></span>
                </div>

                <hr class="small-hr" />

                <!-- Minion -->
                 
                <div class="minion">
                    <span class="header medium bold">Minion:</span> 
                    <span class="medium" style="margin-left: 8px;" name="attr_selectedMinion">Select a minion from Inventory</span>
                </div>
                <div class="minion-effect list">
                    <span class="header medium bold">Effect: </span>
                    <span class="medium" name="attr_selectedMinionEffect"></span>
                </div>
            </div>

            <!-- Traits -->

            <div class="traits fancy lowkey section">
                <div style="height: 27px; padding-bottom: 4px;">
                    <span class="small colored-in floatLeft">Traits</span>
                    <button type="action" class="floatRight" name="act_expandAllTraits">Expand All</button>
                    <button type="action" class="floatRight" name="act_collapseAllTraits">Collapse All</button>
                </div>
                <fieldset class="repeating_traits">
                    <div class="trait list">
                        <input class="expand-checkbox hidden" type="checkbox" name="attr_traitsExpandItem" />
                        <div class="grid4 item-header">
                            <span class="header medium bold">Trait:</span>
                            <input class="medium" type="text" name="attr_title" placeholder="Title"></span>
                            <button type="action" class="ability-action" style="margin-left: auto;" name="act_share">q</button>
                            <button type="action" class="ability-action" name="act_info">i</button>
                        </div>
                        <div class="item-body list expanded-view">
                            <span class="header medium bold" style="margin-top: 4px;">Effect:</span>
                            <div class="adaptive adaptive--text floatLeft" style="margin-bottom: 8px;">
                                <span class="mini-input adaptive--text__span"  name="attr_effect"></span>
                                <textarea class="mini-input adaptive--text__textarea" name="attr_effect" placeholder="The trait's effects"></textarea>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>
        
        <!-- Profile page, Attributes -->

        <div class="right fancy lowkey section">
            <div class="stat section horizontal tight">

                <!-- Primary -->

                <div class="main-stat list">
                    <h3 class="medium">Primary Attributes</h3>
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <button class="medium roll" name="act_rollStr" type="action">STR</button>
                        <input class="stat" name="attr_str" type="number" value="5">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <button class="medium roll" name="act_rollDex" type="action">DEX</button>
                        <input class="stat" name="attr_dex" type="number" value="4">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <button class="medium roll" name="act_rollVit" type="action">VIT</button>
                        <input class="stat" name="attr_vit" type="number" value="3">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <button class="medium roll" name="act_rollInt" type="action">INT</button>
                        <input class="stat" name="attr_int" type="number" value="2">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <button class="medium roll" name="act_rollMnd" type="action">MND</button>
                        <input class="stat" name="attr_mnd" type="number" value="1">
                    </div>
                </div>
                
                <!-- Secondary -->

                <div class="sub-stat list">
                    <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />

                    <h3 class="medium standard">Secondary Attributes</h3>
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <span class="header medium bold oneline">Defense</span>
                        <input class="stat medium" name="attr_defense" type="number" value="15">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <span class="header medium bold oneline">Magic Defense</span>
                        <input class="stat medium" name="attr_magicDefense" type="number" value="12">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <span class="header medium bold oneline">Vigilance</span>
                        <input class="stat medium" name="attr_vigilance" type="number" value="11">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <span class="header medium bold oneline">Speed</span>
                        <input class="stat medium" name="attr_speed" type="number" value="5">
                    </div>
                </div>
            </div>

            <!-- Turn Order / Fortune -->

            <div class="misc-stat fancy lowkey">
                <div class="flex horizontal tight floatLeft">
                    <span class="header bold medium">Turn Order</span>
                    <input class="stat medium" name="attr_turnOrder" type="number" min="0" value="1">
                    <button class="turn-order" type="roll" value="&{template:roll} {{title=Turn Order}} {{roll=[[@{turnOrder} &{tracker}]]}}"></button>
                </div>

                <div class="fortune fancy lowkey flex horizontal tight floatRight">
                    <span class="header bold medium">Fortune</span>
                    <input class="stat medium" name="attr_fortune" type="number" min="0" value="3">
                </div>
            </div>

            <!-- Effects -->

            <div class="effects section">
                <h3 class="small bold colored-in">Effects</h3> 
                <fieldset class="repeating_effects">
                    <div class="horizontal semi-tight">
                        <img class="effect-icon" name="attr_icon" />
                        <input type="hidden" class="typeSwitch" name="attr_type" />
                        <input type="hidden" class="editSwitch" name="attr_editable" />
                        <input type="text" class="typeSwitchDisplayed editSwitchBlocked" name="attr_specialType" placeholder="Effect" />
                        <select class="effect-type typeSwitchHidden editSwitchBlocked" name="attr_type">
                            <option value="none">--Select--</option>
                            <option value="roll(x)">Roll Up(X)</option>
                            <option value="damage">Damage Reroll</option>
                            <option value="critical(x)">Critical Up(X)</option>
                            <option value="attribute(x)">Attribute Up(X)</option>
                            <option value="regen(x)">Regen(X)</option>
                            <option value="ready(x)">X Ready</option>
                            <option value="advantage">Advantage</option>
                            <option value="unstunnable">Stun Immunity</option>
                            <hr />
                            <option value="blind">Blind</option>
                            <option value="bound">Bound</option>
                            <option value="enmity(x)">Enmity(Penalty)</option>
                            <option value="dot(x)">DOT(X)</option>
                            <option value="heavy">Heavy</option>
                            <option value="paralyzed">Paralyzed</option>
                            <option value="petrified">Petrified</option>
                            <option value="prone">Prone</option>
                            <option value="silence">Silence</option>
                            <option value="sleep">Sleep</option>
                            <option value="slow">Slow</option>
                            <option value="stun">Stun</option>
                            <hr />
                            <option value="weak">Weak</option>
                            <option value="brink">Brink of Death</option>
                            <option value="comatose">Comatose</option>
                            <hr />
                            <option value="special">Special</option>
                        </select>
                        <input class="effect-value typeSwitchHidden editSwitchBlocked" type="text" name="attr_value" placeholder="X" />
                        <select class="effect-expiry" name="attr_expiry">
                            <option value="turn">End of turn</option>
                            <option value="turn2">End of next turn</option>
                            <option value="phase">End of phase</option>
                            <option value="encounter">End of encounter</option>
                            <option value="rest">After rest</option>
                            <option value="end">After adventure</option>
                            <option value="permanent">Permanent</option>
                            <hr />
                            <option value="use">On use</option>
                            <option value="damage">On damage</option>
                        </select>
                    </div>
                </fieldset>
            </div>

            <!-- Rest/End of phase -->

            <div class="rest-container colored-in">
                <div>
                    <span class="header medium bold">Reset</span>
                    <span class="small">your attributes and effects</span>
                </div>
                <div class="button-container">
                    <button type="action" class="phase-button" name="act_phase">End of phase</button>
                    <button type="action" class="end-button" name="act_end">End of adventure</button>
                    <button type="action" class="rest-button" name="act_rest">Long rest</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Abilities page -->

<div class="char-abilities" spellcheck="false">
    <!-- Top abilities (Bard songs) -->
    <input class="job-type" type="hidden" name="attr_job">

    <div class="ability-top">
        <button type="action" class="floatRight" name="act_expandAllAbilities">Expand All</button>
        <button type="action" class="floatRight" name="act_collapseAllAbilities">Collapse All</button>
    </div>

    <div class="top-abilities">
        <input class="expand-checkbox hidden" type="checkbox" name="attr_songHeaderExpandItem" />
        <button type="action" class="header-action" name="act_song_info">i</button>
        <h3 class="large">Song Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_song">
            <div class="ability">
                <div class="header list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="hidden" class="usesFlag" name="attr_uses_max" />
                    <input type="hidden" class="costFlag" name="attr_cost" />
                    <input type="text" class="conditionFlag hidden" name="attr_condition" placeholder="P" />
                    <input type="text" class="triggerFlag hidden" name="attr_trigger" placeholder="P" />
                    <input type="text" class="targetFlag hidden" name="attr_target" placeholder="P" />
                    <input type="text" class="checkFlag hidden" name="attr_check" placeholder="P" />
                    <input type="text" class="crFlag hidden" name="attr_cr" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_songExpandItem" />

                    <span class="mini flagTitle expanded-view floatLeft">Icon source:</span>
                    <input type="text" class="iconSource overrideContent expanded-view mini-input" name="attr_icon" title="Icon" placeholder="icon source" />

                    <div class="uses">
                        <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                        <input class="max mini-input floatRight" type="number" name="attr_uses_max" min="0" value="0" />
                        <span class="floatRight">/</span>
                        <input class="mini-input floatRight" type="number" name="attr_uses" min="0" value="0" />
                    </div>

                    <div class="header-title">
                        <img class="ability-icon" name="attr_icon" />
                        <div class="title adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="bold adaptive--text__span"  name="attr_title"></span>
                            <textarea class="adaptive--text__textarea" type="text" name="attr_title" placeholder="Paladin Combo (Fast Blade + Riot Blade)"></textarea>
                        </div>
                    </div>

                    <div class="ability-controls">
                        <button type="action" class="ability-action-trigger" name="act_trigger">t</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                        <button type="action" class="ability-action" name="act_share">q</button>
                        <button type="action" name="act_rolldamage" style="display: none;">d</button>
                        <button type="action" name="act_rolldamagewithbonus" style="display: none;">d</button>
                        <button type="action" name="act_runcombo1" style="display: none;">d</button>
                        <button type="action" name="act_runcombo2" style="display: none;">d</button>
                        <button type="action" name="act_runcombo3" style="display: none;">d</button>
                    </div>

                    <div class="type expanded-view">
                        <span class="mini-title floatLeft">Type:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input italic adaptive--text__span" name="attr_type"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_type" placeholder="Primary, Physical"></textarea>
                        </div>
                    </div>
                    <div class="cost expanded-view">
                        <span class="mini-title floatLeft">Cost:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cost"></span>
                            <input class="mini-input adaptive--input__input" type="number" name="attr_cost" placeholder="X" />
                        </div>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span"  name="attr_resource"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_resource" placeholder="Conviction" />
                        </div>
                    </div>
                    <div class="condition expanded-view">
                        <span class="mini-title floatLeft">Condition:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_condition"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_condition" placeholder="Under the effect of Fang and Claw Bared / Wheel in Motion Ready"></textarea>
                        </div>
                    </div>
                    <div class="trigger expanded-view">
                        <span class="mini-title floatLeft">Trigger:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_trigger"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_trigger" placeholder="Immediately after an ability check for an ability that targets you"></textarea>
                        </div>
                    </div>
                    <div class="target expanded-view">
                        <span class="mini-title floatLeft">Target:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_target"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_target" placeholder="Single"></textarea>
                        </div>
                    </div>
                    <div class="range expanded-view">
                        <span class="mini-title floatLeft">Range:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_range"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_range" placeholder="1 square"></textarea>
                        </div>
                    </div>
                    <div class="check expanded-view">
                        <span class="mini-title floatLeft">Check:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input bold adaptive--input__span" name="attr_check"></span>
                            <input class="mini-input bold adaptive--input__input" type="text" name="attr_check" placeholder="d20 + STR" />
                        </div>
                    </div>
                    <div class="cr expanded-view">
                        <span class="mini-title floatLeft">CR:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cr"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_cr" placeholder="Target's Defense" />
                        </div>
                    </div>
                </div>

                <div class="body list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="text" class="directHitFlag hidden" name="attr_directHit" placeholder="P" />
                    <input type="text" class="effectFlag hidden" name="attr_effectName" placeholder="P" />
                    <input type="text" class="limitationFlag hidden" name="attr_limitation" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_songExpandItem" />

                    <div class="spacer expanded-view"></div>

                    <div class="base-effect expanded-view">
                        <span class="mini-title floatLeft">Base Effect:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_baseEffect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_baseEffect" placeholder="Deals 3 damage and inflicts Enmity on the target. Combo: Rage of Halone."></textarea>
                        </div>
                    </div>
                    <div class="direct-hit expanded-view">
                        <span class="mini-title floatLeft">Direct Hit:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_directHit"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_directHit" placeholder="Deals an additional 2d6 damage"></textarea>
                        </div>
                    </div>
                    <div class="ability-effect list expanded-view">
                        <div class="adaptive adaptive--input">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-title adaptive--input__span" name="attr_effectName"></span>
                            <span class="mini-title" name="attr_effectName">:</span>
                            <input class="mini-title adaptive--input__input" type="text" name="attr_effectName" placeholder="My Effect" />
                        </div>
                        <div class="adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_effect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_effect" placeholder="Provides 1 HP Barrier"></textarea>
                        </div>
                    </div>
                    <div class="limitation expanded-view">
                        <span class="mini-title floatLeft">Limitation:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_limitation"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_limitation" placeholder="Once per phase." />
                        </div>
                    </div>

                    <span class="mini flagTitle expanded-view floatLeft">Stat for rolls (used for calculations):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_stat" title="Stat for rolls" placeholder="STR, DEX, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Hit dice type (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_hitType">
                        <option value="Hit">Hit</option>
                        <option value="Critical">Critical</option>
                        <option value="None">None</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Damage/Healing (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_damageType">
                        <option value="Damage">Damage</option>
                        <option value="Healing">Healing</option>
                        <option value="Defense">Defense</option>
                        <option value="Effect">Effect</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Hit die (used for rolls):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_hitDie" title="Hit" placeholder="1d20cs20, 1d8, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Base effect dice/value (used to calculate damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_baseValue" title="Base effect value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Direct Hit dice/value (used to calculate extra damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_dhValue" title="Direct Hit value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Restoration value (used to restore own HP/MP/resource, include space)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_restore" title="Restore value" placeholder="5 MP, 5 HP, 5 Conviction, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on self (used to automatically add effects)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectSelf" title="Effect names" placeholder="Astral Fire, Surging Tempest" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on target (used to add effect shortcut button)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectTarget" title="Effect names" placeholder="Major Arcana, Mage's Ballad" />
                    <span class="mini flagTitle expanded-view floatLeft">Combo name (used for easy chaining to next ability)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_combo" title="Combo value" placeholder="Storm's Path, Storm's Eye" />
                </div>
            </div>
        </fieldset>
        <div class="collapse-overlay collapsed-view "></div>
    </div>

    <!-- Primary abilities -->

    <div class="primary-abilities">
        <input class="expand-checkbox hidden" type="checkbox" name="attr_primaryHeaderExpandItem" />
        <div>
            <button type="action" class="header-action" name="act_primary_info">i</button>
            <h3 class="large">Primary Abilities</h3>
        </div>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_primary">
            <div class="ability">
                <div class="header list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="hidden" class="usesFlag" name="attr_uses_max" />
                    <input type="hidden" class="costFlag" name="attr_cost" />
                    <input type="text" class="conditionFlag hidden" name="attr_condition" placeholder="P" />
                    <input type="text" class="triggerFlag hidden" name="attr_trigger" placeholder="P" />
                    <input type="text" class="targetFlag hidden" name="attr_target" placeholder="P" />
                    <input type="text" class="checkFlag hidden" name="attr_check" placeholder="P" />
                    <input type="text" class="crFlag hidden" name="attr_cr" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_primaryExpandItem" />

                    <span class="mini flagTitle expanded-view floatLeft">Icon source:</span>
                    <input type="text" class="iconSource overrideContent expanded-view mini-input" name="attr_icon" title="Icon" placeholder="icon source" />

                    <div class="uses">
                        <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                        <input class="max mini-input floatRight" type="number" name="attr_uses_max" min="0" value="0" />
                        <span class="floatRight">/</span>
                        <input class="mini-input floatRight" type="number" name="attr_uses" min="0" value="0" />
                    </div>

                    <div class="header-title">
                        <img class="ability-icon" name="attr_icon" />
                        <div class="title adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="bold adaptive--text__span"  name="attr_title"></span>
                            <textarea class="adaptive--text__textarea" type="text" name="attr_title" placeholder="Paladin Combo (Fast Blade + Riot Blade)"></textarea>
                        </div>
                    </div>

                    <div class="ability-controls">
                        <button type="action" class="ability-action-trigger" name="act_trigger">t</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                        <button type="action" class="ability-action" name="act_share">q</button>
                        <button type="action" name="act_rolldamage" style="display: none;">d</button>
                        <button type="action" name="act_rolldamagewithbonus" style="display: none;">d</button>
                        <button type="action" name="act_runcombo1" style="display: none;">d</button>
                        <button type="action" name="act_runcombo2" style="display: none;">d</button>
                        <button type="action" name="act_runcombo3" style="display: none;">d</button>
                    </div>

                    <div class="type expanded-view">
                        <span class="mini-title floatLeft">Type:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input italic adaptive--text__span" name="attr_type"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_type" placeholder="Primary, Physical"></textarea>
                        </div>
                    </div>
                    <div class="cost expanded-view">
                        <span class="mini-title floatLeft">Cost:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cost"></span>
                            <input class="mini-input adaptive--input__input" type="number" name="attr_cost" placeholder="X" />
                        </div>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span"  name="attr_resource"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_resource" placeholder="Conviction" />
                        </div>
                    </div>
                    <div class="condition expanded-view">
                        <span class="mini-title floatLeft">Condition:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_condition"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_condition" placeholder="Under the effect of Fang and Claw Bared / Wheel in Motion Ready"></textarea>
                        </div>
                    </div>
                    <div class="trigger expanded-view">
                        <span class="mini-title floatLeft">Trigger:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_trigger"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_trigger" placeholder="Immediately after an ability check for an ability that targets you"></textarea>
                        </div>
                    </div>
                    <div class="target expanded-view">
                        <span class="mini-title floatLeft">Target:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_target"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_target" placeholder="Single"></textarea>
                        </div>
                    </div>
                    <div class="range expanded-view">
                        <span class="mini-title floatLeft">Range:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_range"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_range" placeholder="1 square"></textarea>
                        </div>
                    </div>
                    <div class="check expanded-view">
                        <span class="mini-title floatLeft">Check:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input bold adaptive--input__span" name="attr_check"></span>
                            <input class="mini-input bold adaptive--input__input" type="text" name="attr_check" placeholder="d20 + STR" />
                        </div>
                    </div>
                    <div class="cr expanded-view">
                        <span class="mini-title floatLeft">CR:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cr"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_cr" placeholder="Target's Defense" />
                        </div>
                    </div>
                </div>

                <div class="body list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="text" class="directHitFlag hidden" name="attr_directHit" placeholder="P" />
                    <input type="text" class="effectFlag hidden" name="attr_effectName" placeholder="P" />
                    <input type="text" class="limitationFlag hidden" name="attr_limitation" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_primaryExpandItem" />

                    <div class="spacer expanded-view"></div>

                    <div class="base-effect expanded-view">
                        <span class="mini-title floatLeft">Base Effect:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_baseEffect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_baseEffect" placeholder="Deals 3 damage and inflicts Enmity on the target. Combo: Rage of Halone."></textarea>
                        </div>
                    </div>
                    <div class="direct-hit expanded-view">
                        <span class="mini-title floatLeft">Direct Hit:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_directHit"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_directHit" placeholder="Deals an additional 2d6 damage"></textarea>
                        </div>
                    </div>
                    <div class="ability-effect list expanded-view">
                        <div class="adaptive adaptive--input">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-title adaptive--input__span" name="attr_effectName"></span>
                            <span class="mini-title" name="attr_effectName">:</span>
                            <input class="mini-title adaptive--input__input" type="text" name="attr_effectName" placeholder="My Effect" />
                        </div>
                        <div class="adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_effect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_effect" placeholder="Provides 1 HP Barrier"></textarea>
                        </div>
                    </div>
                    <div class="limitation expanded-view">
                        <span class="mini-title floatLeft">Limitation:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_limitation"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_limitation" placeholder="Once per phase." />
                        </div>
                    </div>

                    <span class="mini flagTitle expanded-view floatLeft">Stat for rolls (used for calculations):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_stat" title="Stat for rolls" placeholder="STR, DEX, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Hit dice type (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_hitType">
                        <option value="Hit">Hit</option>
                        <option value="Critical">Critical</option>
                        <option value="None">None</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Damage/Healing (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_damageType">
                        <option value="Damage">Damage</option>
                        <option value="Healing">Healing</option>
                        <option value="Defense">Defense</option>
                        <option value="Effect">Effect</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Hit die (used for rolls):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_hitDie" title="Hit" placeholder="1d20cs20, 1d8, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Base effect dice/value (used to calculate damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_baseValue" title="Base effect value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Direct Hit dice/value (used to calculate extra damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_dhValue" title="Direct Hit value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Restoration value (used to restore own HP/MP/resource, include space)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_restore" title="Restore value" placeholder="5 MP, 5 HP, 5 Conviction, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on self (used to automatically add effects)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectSelf" title="Effect names" placeholder="Astral Fire, Surging Tempest" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on target (used to add effect shortcut button)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectTarget" title="Effect names" placeholder="Major Arcana, Mage's Ballad" />
                    <span class="mini flagTitle expanded-view floatLeft">Combo name (used for easy chaining to next ability)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_combo" title="Combo value" placeholder="Storm's Path, Storm's Eye" />
                </div>
            </div>
        </fieldset>
        <div class="collapse-overlay collapsed-view "></div>
    </div>

    <!-- Sub-abilities (Ninja jutsu) -->

    <div class="sub-abilities">
        <input class="expand-checkbox hidden" type="checkbox" name="attr_ninjutsuHeaderExpandItem" />
        <button type="action" class="header-action" name="act_ninjutsu_info">i</button>
        <h3 class="large">Ninjutsu Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_ninjutsu">
            <div class="ability">
                <div class="header list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="hidden" class="usesFlag" name="attr_uses_max" />
                    <input type="hidden" class="costFlag" name="attr_cost" />
                    <input type="text" class="conditionFlag hidden" name="attr_condition" placeholder="P" />
                    <input type="text" class="triggerFlag hidden" name="attr_trigger" placeholder="P" />
                    <input type="text" class="targetFlag hidden" name="attr_target" placeholder="P" />
                    <input type="text" class="checkFlag hidden" name="attr_check" placeholder="P" />
                    <input type="text" class="crFlag hidden" name="attr_cr" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_ninjutsuExpandItem" />

                    <span class="mini flagTitle expanded-view floatLeft">Icon source:</span>
                    <input type="text" class="iconSource overrideContent expanded-view mini-input" name="attr_icon" title="Icon" placeholder="icon source" />

                    <div class="uses">
                        <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                        <input class="max mini-input floatRight" type="number" name="attr_uses_max" min="0" value="0" />
                        <span class="floatRight">/</span>
                        <input class="mini-input floatRight" type="number" name="attr_uses" min="0" value="0" />
                    </div>

                    <div class="header-title">
                        <img class="ability-icon" name="attr_icon" />
                        <div class="title adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="bold adaptive--text__span"  name="attr_title"></span>
                            <textarea class="adaptive--text__textarea" type="text" name="attr_title" placeholder="Paladin Combo (Fast Blade + Riot Blade)"></textarea>
                        </div>
                    </div>

                    <div class="ability-controls">
                        <button type="action" class="ability-action-trigger" name="act_trigger">t</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                        <button type="action" class="ability-action" name="act_share">q</button>
                        <button type="action" name="act_rolldamage" style="display: none;">d</button>
                        <button type="action" name="act_rolldamagewithbonus" style="display: none;">d</button>
                        <button type="action" name="act_runcombo1" style="display: none;">d</button>
                        <button type="action" name="act_runcombo2" style="display: none;">d</button>
                        <button type="action" name="act_runcombo3" style="display: none;">d</button>
                    </div>

                    <div class="type expanded-view">
                        <span class="mini-title floatLeft">Type:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input italic adaptive--text__span" name="attr_type"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_type" placeholder="Primary, Physical"></textarea>
                        </div>
                    </div>
                    <div class="cost expanded-view">
                        <span class="mini-title floatLeft">Cost:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cost"></span>
                            <input class="mini-input adaptive--input__input" type="number" name="attr_cost" placeholder="X" />
                        </div>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span"  name="attr_resource"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_resource" placeholder="Conviction" />
                        </div>
                    </div>
                    <div class="condition expanded-view">
                        <span class="mini-title floatLeft">Condition:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_condition"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_condition" placeholder="Under the effect of Fang and Claw Bared / Wheel in Motion Ready"></textarea>
                        </div>
                    </div>
                    <div class="trigger expanded-view">
                        <span class="mini-title floatLeft">Trigger:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_trigger"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_trigger" placeholder="Immediately after an ability check for an ability that targets you"></textarea>
                        </div>
                    </div>
                    <div class="target expanded-view">
                        <span class="mini-title floatLeft">Target:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_target"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_target" placeholder="Single"></textarea>
                        </div>
                    </div>
                    <div class="range expanded-view">
                        <span class="mini-title floatLeft">Range:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_range"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_range" placeholder="1 square"></textarea>
                        </div>
                    </div>
                    <div class="check expanded-view">
                        <span class="mini-title floatLeft">Check:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input bold adaptive--input__span" name="attr_check"></span>
                            <input class="mini-input bold adaptive--input__input" type="text" name="attr_check" placeholder="d20 + STR" />
                        </div>
                    </div>
                    <div class="cr expanded-view">
                        <span class="mini-title floatLeft">CR:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cr"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_cr" placeholder="Target's Defense" />
                        </div>
                    </div>
                </div>

                <div class="body list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="text" class="directHitFlag hidden" name="attr_directHit" placeholder="P" />
                    <input type="text" class="effectFlag hidden" name="attr_effectName" placeholder="P" />
                    <input type="text" class="limitationFlag hidden" name="attr_limitation" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_ninjutsuExpandItem" />

                    <div class="spacer expanded-view"></div>

                    <div class="base-effect expanded-view">
                        <span class="mini-title floatLeft">Base Effect:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_baseEffect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_baseEffect" placeholder="Deals 3 damage and inflicts Enmity on the target. Combo: Rage of Halone."></textarea>
                        </div>
                    </div>
                    <div class="direct-hit expanded-view">
                        <span class="mini-title floatLeft">Direct Hit:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_directHit"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_directHit" placeholder="Deals an additional 2d6 damage"></textarea>
                        </div>
                    </div>
                    <div class="ability-effect list expanded-view">
                        <div class="adaptive adaptive--input">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-title adaptive--input__span" name="attr_effectName"></span>
                            <span class="mini-title" name="attr_effectName">:</span>
                            <input class="mini-title adaptive--input__input" type="text" name="attr_effectName" placeholder="My Effect" />
                        </div>
                        <div class="adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_effect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_effect" placeholder="Provides 1 HP Barrier"></textarea>
                        </div>
                    </div>
                    <div class="limitation expanded-view">
                        <span class="mini-title floatLeft">Limitation:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_limitation"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_limitation" placeholder="Once per phase." />
                        </div>
                    </div>

                    <span class="mini flagTitle expanded-view floatLeft">Stat for rolls (used for calculations):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_stat" title="Stat for rolls" placeholder="STR, DEX, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Hit dice type (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_hitType">
                        <option value="Hit">Hit</option>
                        <option value="Critical">Critical</option>
                        <option value="None">None</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Damage/Healing (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_damageType">
                        <option value="Damage">Damage</option>
                        <option value="Healing">Healing</option>
                        <option value="Defense">Defense</option>
                        <option value="Effect">Effect</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Hit die (used for rolls):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_hitDie" title="Hit" placeholder="1d20cs20, 1d8, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Base effect dice/value (used to calculate damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_baseValue" title="Base effect value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Direct Hit dice/value (used to calculate extra damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_dhValue" title="Direct Hit value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Restoration value (used to restore own HP/MP/resource, include space)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_restore" title="Restore value" placeholder="5 MP, 5 HP, 5 Conviction, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on self (used to automatically add effects)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectSelf" title="Effect names" placeholder="Astral Fire, Surging Tempest" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on target (used to add effect shortcut button)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectTarget" title="Effect names" placeholder="Major Arcana, Mage's Ballad" />
                    <span class="mini flagTitle expanded-view floatLeft">Combo name (used for easy chaining to next ability)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_combo" title="Combo value" placeholder="Storm's Path, Storm's Eye" />
                </div>
            </div>
        </fieldset>
        <div class="collapse-overlay collapsed-view "></div>
    </div>

    <!-- Secondary abilities -->

    <div class="secondary-abilities">
        <input class="expand-checkbox hidden" type="checkbox" name="attr_secondaryHeaderExpandItem" />
        <button type="action" class="header-action" name="act_secondary_info">i</button>
        <h3 class="large">Secondary Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_secondary">
            <div class="ability">
                <div class="header list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="hidden" class="usesFlag" name="attr_uses_max" />
                    <input type="hidden" class="costFlag" name="attr_cost" />
                    <input type="text" class="conditionFlag hidden" name="attr_condition" placeholder="P" />
                    <input type="text" class="triggerFlag hidden" name="attr_trigger" placeholder="P" />
                    <input type="text" class="targetFlag hidden" name="attr_target" placeholder="P" />
                    <input type="text" class="checkFlag hidden" name="attr_check" placeholder="P" />
                    <input type="text" class="crFlag hidden" name="attr_cr" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_secondaryExpandItem" />

                    <span class="mini flagTitle expanded-view floatLeft">Icon source:</span>
                    <input type="text" class="iconSource overrideContent expanded-view mini-input" name="attr_icon" title="Icon" placeholder="icon source" />

                    <div class="uses">
                        <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                        <input class="max mini-input floatRight" type="number" name="attr_uses_max" min="0" value="0" />
                        <span class="floatRight">/</span>
                        <input class="mini-input floatRight" type="number" name="attr_uses" min="0" value="0" />
                    </div>

                    <div class="header-title">
                        <img class="ability-icon" name="attr_icon" />
                        <div class="title adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="bold adaptive--text__span"  name="attr_title"></span>
                            <textarea class="adaptive--text__textarea" type="text" name="attr_title" placeholder="Paladin Combo (Fast Blade + Riot Blade)"></textarea>
                        </div>
                    </div>

                    <div class="ability-controls">
                        <button type="action" class="ability-action-trigger" name="act_trigger">t</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                        <button type="action" class="ability-action" name="act_share">q</button>
                        <button type="action" name="act_rolldamage" style="display: none;">d</button>
                        <button type="action" name="act_rolldamagewithbonus" style="display: none;">d</button>
                        <button type="action" name="act_runcombo1" style="display: none;">d</button>
                        <button type="action" name="act_runcombo2" style="display: none;">d</button>
                        <button type="action" name="act_runcombo3" style="display: none;">d</button>
                    </div>

                    <div class="type expanded-view">
                        <span class="mini-title floatLeft">Type:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input italic adaptive--text__span" name="attr_type"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_type" placeholder="Primary, Physical"></textarea>
                        </div>
                    </div>
                    <div class="cost expanded-view">
                        <span class="mini-title floatLeft">Cost:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cost"></span>
                            <input class="mini-input adaptive--input__input" type="number" name="attr_cost" placeholder="X" />
                        </div>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span"  name="attr_resource"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_resource" placeholder="Conviction" />
                        </div>
                    </div>
                    <div class="condition expanded-view">
                        <span class="mini-title floatLeft">Condition:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_condition"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_condition" placeholder="Under the effect of Fang and Claw Bared / Wheel in Motion Ready"></textarea>
                        </div>
                    </div>
                    <div class="trigger expanded-view">
                        <span class="mini-title floatLeft">Trigger:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_trigger"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_trigger" placeholder="Immediately after an ability check for an ability that targets you"></textarea>
                        </div>
                    </div>
                    <div class="target expanded-view">
                        <span class="mini-title floatLeft">Target:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_target"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_target" placeholder="Single"></textarea>
                        </div>
                    </div>
                    <div class="range expanded-view">
                        <span class="mini-title floatLeft">Range:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_range"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_range" placeholder="1 square"></textarea>
                        </div>
                    </div>
                    <div class="check expanded-view">
                        <span class="mini-title floatLeft">Check:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input bold adaptive--input__span" name="attr_check"></span>
                            <input class="mini-input bold adaptive--input__input" type="text" name="attr_check" placeholder="d20 + STR" />
                        </div>
                    </div>
                    <div class="cr expanded-view">
                        <span class="mini-title floatLeft">CR:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cr"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_cr" placeholder="Target's Defense" />
                        </div>
                    </div>
                </div>

                <div class="body list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="text" class="directHitFlag hidden" name="attr_directHit" placeholder="P" />
                    <input type="text" class="effectFlag hidden" name="attr_effectName" placeholder="P" />
                    <input type="text" class="limitationFlag hidden" name="attr_limitation" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_secondaryExpandItem" />

                    <div class="spacer expanded-view"></div>

                    <div class="base-effect expanded-view">
                        <span class="mini-title floatLeft">Base Effect:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_baseEffect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_baseEffect" placeholder="Deals 3 damage and inflicts Enmity on the target. Combo: Rage of Halone."></textarea>
                        </div>
                    </div>
                    <div class="direct-hit expanded-view">
                        <span class="mini-title floatLeft">Direct Hit:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_directHit"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_directHit" placeholder="Deals an additional 2d6 damage"></textarea>
                        </div>
                    </div>
                    <div class="ability-effect list expanded-view">
                        <div class="adaptive adaptive--input">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-title adaptive--input__span" name="attr_effectName"></span>
                            <span class="mini-title" name="attr_effectName">:</span>
                            <input class="mini-title adaptive--input__input" type="text" name="attr_effectName" placeholder="My Effect" />
                        </div>
                        <div class="adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_effect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_effect" placeholder="Provides 1 HP Barrier"></textarea>
                        </div>
                    </div>
                    <div class="limitation expanded-view">
                        <span class="mini-title floatLeft">Limitation:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_limitation"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_limitation" placeholder="Once per phase." />
                        </div>
                    </div>

                    <span class="mini flagTitle expanded-view floatLeft">Stat for rolls (used for calculations):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_stat" title="Stat for rolls" placeholder="STR, DEX, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Hit dice type (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_hitType">
                        <option value="Hit">Hit</option>
                        <option value="Critical">Critical</option>
                        <option value="None">None</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Damage/Healing (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_damageType">
                        <option value="Damage">Damage</option>
                        <option value="Healing">Healing</option>
                        <option value="Defense">Defense</option>
                        <option value="Effect">Effect</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Hit die (used for rolls):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_hitDie" title="Hit" placeholder="1d20cs20, 1d8, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Base effect dice/value (used to calculate damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_baseValue" title="Base effect value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Direct Hit dice/value (used to calculate extra damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_dhValue" title="Direct Hit value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Restoration value (used to restore own HP/MP/resource, include space)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_restore" title="Restore value" placeholder="5 MP, 5 HP, 5 Conviction, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on self (used to automatically add effects)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectSelf" title="Effect names" placeholder="Astral Fire, Surging Tempest" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on target (used to add effect shortcut button)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectTarget" title="Effect names" placeholder="Major Arcana, Mage's Ballad" />
                    <span class="mini flagTitle expanded-view floatLeft">Combo name (used for easy chaining to next ability)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_combo" title="Combo value" placeholder="Storm's Path, Storm's Eye" />
                </div>
            </div>
        </fieldset>
        <div class="collapse-overlay collapsed-view "></div>
    </div>

    <!-- Instant abilities -->

    <div class="instant-abilities">
        <input class="expand-checkbox hidden" type="checkbox" name="attr_instantHeaderExpandItem" />
        <button type="action" class="header-action" name="act_instant_info">i</button>
        <h3 class="large">Instant Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_instant">
            <div class="ability">
                <div class="header list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="hidden" class="usesFlag" name="attr_uses_max" />
                    <input type="hidden" class="costFlag" name="attr_cost" />
                    <input type="text" class="conditionFlag hidden" name="attr_condition" placeholder="P" />
                    <input type="text" class="triggerFlag hidden" name="attr_trigger" placeholder="P" />
                    <input type="text" class="targetFlag hidden" name="attr_target" placeholder="P" />
                    <input type="text" class="checkFlag hidden" name="attr_check" placeholder="P" />
                    <input type="text" class="crFlag hidden" name="attr_cr" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_instantExpandItem" />

                    <span class="mini flagTitle expanded-view floatLeft">Icon source:</span>
                    <input type="text" class="iconSource overrideContent expanded-view mini-input" name="attr_icon" title="Icon" placeholder="icon source" />

                    <div class="uses">
                        <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                        <input class="max mini-input floatRight" type="number" name="attr_uses_max" min="0" value="0" />
                        <span class="floatRight">/</span>
                        <input class="mini-input floatRight" type="number" name="attr_uses" min="0" value="0" />
                    </div>

                    <div class="header-title">
                        <img class="ability-icon" name="attr_icon" />
                        <div class="title adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="bold adaptive--text__span"  name="attr_title"></span>
                            <textarea class="adaptive--text__textarea" type="text" name="attr_title" placeholder="Paladin Combo (Fast Blade + Riot Blade)"></textarea>
                        </div>
                    </div>

                    <div class="ability-controls">
                        <button type="action" class="ability-action-trigger" name="act_trigger">t</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                        <button type="action" class="ability-action" name="act_share">q</button>
                        <button type="action" name="act_rolldamage" style="display: none;">d</button>
                        <button type="action" name="act_rolldamagewithbonus" style="display: none;">d</button>
                        <button type="action" name="act_runcombo1" style="display: none;">d</button>
                        <button type="action" name="act_runcombo2" style="display: none;">d</button>
                        <button type="action" name="act_runcombo3" style="display: none;">d</button>
                    </div>

                    <div class="type expanded-view">
                        <span class="mini-title floatLeft">Type:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input italic adaptive--text__span" name="attr_type"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_type" placeholder="Primary, Physical"></textarea>
                        </div>
                    </div>
                    <div class="cost expanded-view">
                        <span class="mini-title floatLeft">Cost:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cost"></span>
                            <input class="mini-input adaptive--input__input" type="number" name="attr_cost" placeholder="X" />
                        </div>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span"  name="attr_resource"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_resource" placeholder="Conviction" />
                        </div>
                    </div>
                    <div class="condition expanded-view">
                        <span class="mini-title floatLeft">Condition:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_condition"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_condition" placeholder="Under the effect of Fang and Claw Bared / Wheel in Motion Ready"></textarea>
                        </div>
                    </div>
                    <div class="trigger expanded-view">
                        <span class="mini-title floatLeft">Trigger:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_trigger"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_trigger" placeholder="Immediately after an ability check for an ability that targets you"></textarea>
                        </div>
                    </div>
                    <div class="target expanded-view">
                        <span class="mini-title floatLeft">Target:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_target"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_target" placeholder="Single"></textarea>
                        </div>
                    </div>
                    <div class="range expanded-view">
                        <span class="mini-title floatLeft">Range:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_range"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_range" placeholder="1 square"></textarea>
                        </div>
                    </div>
                    <div class="check expanded-view">
                        <span class="mini-title floatLeft">Check:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input bold adaptive--input__span" name="attr_check"></span>
                            <input class="mini-input bold adaptive--input__input" type="text" name="attr_check" placeholder="d20 + STR" />
                        </div>
                    </div>
                    <div class="cr expanded-view">
                        <span class="mini-title floatLeft">CR:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cr"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_cr" placeholder="Target's Defense" />
                        </div>
                    </div>
                </div>

                <div class="body list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="text" class="directHitFlag hidden" name="attr_directHit" placeholder="P" />
                    <input type="text" class="effectFlag hidden" name="attr_effectName" placeholder="P" />
                    <input type="text" class="limitationFlag hidden" name="attr_limitation" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_instantExpandItem" />

                    <div class="spacer expanded-view"></div>

                    <div class="base-effect expanded-view">
                        <span class="mini-title floatLeft">Base Effect:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_baseEffect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_baseEffect" placeholder="Deals 3 damage and inflicts Enmity on the target. Combo: Rage of Halone."></textarea>
                        </div>
                    </div>
                    <div class="direct-hit expanded-view">
                        <span class="mini-title floatLeft">Direct Hit:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_directHit"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_directHit" placeholder="Deals an additional 2d6 damage"></textarea>
                        </div>
                    </div>
                    <div class="ability-effect list expanded-view">
                        <div class="adaptive adaptive--input">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-title adaptive--input__span" name="attr_effectName"></span>
                            <span class="mini-title" name="attr_effectName">:</span>
                            <input class="mini-title adaptive--input__input" type="text" name="attr_effectName" placeholder="My Effect" />
                        </div>
                        <div class="adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_effect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_effect" placeholder="Provides 1 HP Barrier"></textarea>
                        </div>
                    </div>
                    <div class="limitation expanded-view">
                        <span class="mini-title floatLeft">Limitation:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_limitation"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_limitation" placeholder="Once per phase." />
                        </div>
                    </div>

                    <span class="mini flagTitle expanded-view floatLeft">Stat for rolls (used for calculations):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_stat" title="Stat for rolls" placeholder="STR, DEX, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Hit dice type (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_hitType">
                        <option value="Hit">Hit</option>
                        <option value="Critical">Critical</option>
                        <option value="None">None</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Damage/Healing (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_damageType">
                        <option value="Damage">Damage</option>
                        <option value="Healing">Healing</option>
                        <option value="Defense">Defense</option>
                        <option value="Effect">Effect</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Hit die (used for rolls):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_hitDie" title="Hit" placeholder="1d20cs20, 1d8, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Base effect dice/value (used to calculate damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_baseValue" title="Base effect value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Direct Hit dice/value (used to calculate extra damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_dhValue" title="Direct Hit value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Restoration value (used to restore own HP/MP/resource, include space)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_restore" title="Restore value" placeholder="5 MP, 5 HP, 5 Conviction, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on self (used to automatically add effects)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectSelf" title="Effect names" placeholder="Astral Fire, Surging Tempest" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on target (used to add effect shortcut button)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectTarget" title="Effect names" placeholder="Major Arcana, Mage's Ballad" />
                    <span class="mini flagTitle expanded-view floatLeft">Combo name (used for easy chaining to next ability)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_combo" title="Combo value" placeholder="Storm's Path, Storm's Eye" />
                </div>
            </div>
        </fieldset>
        <div class="collapse-overlay collapsed-view "></div>
    </div>

    <!-- Conditional abilities (Monk techniques) -->

    <div class="conditional-abilities">
        <input class="expand-checkbox hidden" type="checkbox" name="attr_techniqueHeaderExpandItem" />
        <button type="action" class="header-action" name="act_technique_info">i</button>
        <h3 class="large">Technique Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_technique">
            <div class="ability">
                <div class="header list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="hidden" class="usesFlag" name="attr_uses_max" />
                    <input type="hidden" class="costFlag" name="attr_cost" />
                    <input type="text" class="conditionFlag hidden" name="attr_condition" placeholder="P" />
                    <input type="text" class="triggerFlag hidden" name="attr_trigger" placeholder="P" />
                    <input type="text" class="targetFlag hidden" name="attr_target" placeholder="P" />
                    <input type="text" class="checkFlag hidden" name="attr_check" placeholder="P" />
                    <input type="text" class="crFlag hidden" name="attr_cr" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_techniqueExpandItem" />

                    <span class="mini flagTitle expanded-view floatLeft">Icon source:</span>
                    <input type="text" class="iconSource overrideContent expanded-view mini-input" name="attr_icon" title="Icon" placeholder="icon source" />

                    <div class="uses">
                        <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                        <input class="max mini-input floatRight" type="number" name="attr_uses_max" min="0" value="0" />
                        <span class="floatRight">/</span>
                        <input class="mini-input floatRight" type="number" name="attr_uses" min="0" value="0" />
                    </div>

                    <div class="header-title">
                        <img class="ability-icon" name="attr_icon" />
                        <div class="title adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="bold adaptive--text__span"  name="attr_title"></span>
                            <textarea class="adaptive--text__textarea" type="text" name="attr_title" placeholder="Paladin Combo (Fast Blade + Riot Blade)"></textarea>
                        </div>
                    </div>

                    <div class="ability-controls">
                        <button type="action" class="ability-action-trigger" name="act_trigger">t</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                        <button type="action" class="ability-action" name="act_share">q</button>
                        <button type="action" name="act_rolldamage" style="display: none;">d</button>
                        <button type="action" name="act_rolldamagewithbonus" style="display: none;">d</button>
                        <button type="action" name="act_runcombo1" style="display: none;">d</button>
                        <button type="action" name="act_runcombo2" style="display: none;">d</button>
                        <button type="action" name="act_runcombo3" style="display: none;">d</button>
                    </div>

                    <div class="type expanded-view">
                        <span class="mini-title floatLeft">Type:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input italic adaptive--text__span" name="attr_type"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_type" placeholder="Primary, Physical"></textarea>
                        </div>
                    </div>
                    <div class="cost expanded-view">
                        <span class="mini-title floatLeft">Cost:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cost"></span>
                            <input class="mini-input adaptive--input__input" type="number" name="attr_cost" placeholder="X" />
                        </div>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span"  name="attr_resource"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_resource" placeholder="Conviction" />
                        </div>
                    </div>
                    <div class="condition expanded-view">
                        <span class="mini-title floatLeft">Condition:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_condition"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_condition" placeholder="Under the effect of Fang and Claw Bared / Wheel in Motion Ready"></textarea>
                        </div>
                    </div>
                    <div class="trigger expanded-view">
                        <span class="mini-title floatLeft">Trigger:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_trigger"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_trigger" placeholder="Immediately after an ability check for an ability that targets you"></textarea>
                        </div>
                    </div>
                    <div class="target expanded-view">
                        <span class="mini-title floatLeft">Target:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_target"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_target" placeholder="Single"></textarea>
                        </div>
                    </div>
                    <div class="range expanded-view">
                        <span class="mini-title floatLeft">Range:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_range"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_range" placeholder="1 square"></textarea>
                        </div>
                    </div>
                    <div class="check expanded-view">
                        <span class="mini-title floatLeft">Check:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input bold adaptive--input__span" name="attr_check"></span>
                            <input class="mini-input bold adaptive--input__input" type="text" name="attr_check" placeholder="d20 + STR" />
                        </div>
                    </div>
                    <div class="cr expanded-view">
                        <span class="mini-title floatLeft">CR:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cr"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_cr" placeholder="Target's Defense" />
                        </div>
                    </div>
                </div>

                <div class="body list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="text" class="directHitFlag hidden" name="attr_directHit" placeholder="P" />
                    <input type="text" class="effectFlag hidden" name="attr_effectName" placeholder="P" />
                    <input type="text" class="limitationFlag hidden" name="attr_limitation" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_techniqueExpandItem" />

                    <div class="spacer expanded-view"></div>

                    <div class="base-effect expanded-view">
                        <span class="mini-title floatLeft">Base Effect:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_baseEffect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_baseEffect" placeholder="Deals 3 damage and inflicts Enmity on the target. Combo: Rage of Halone."></textarea>
                        </div>
                    </div>
                    <div class="direct-hit expanded-view">
                        <span class="mini-title floatLeft">Direct Hit:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_directHit"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_directHit" placeholder="Deals an additional 2d6 damage"></textarea>
                        </div>
                    </div>
                    <div class="ability-effect list expanded-view">
                        <div class="adaptive adaptive--input">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-title adaptive--input__span" name="attr_effectName"></span>
                            <span class="mini-title" name="attr_effectName">:</span>
                            <input class="mini-title adaptive--input__input" type="text" name="attr_effectName" placeholder="My Effect" />
                        </div>
                        <div class="adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_effect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_effect" placeholder="Provides 1 HP Barrier"></textarea>
                        </div>
                    </div>
                    <div class="limitation expanded-view">
                        <span class="mini-title floatLeft">Limitation:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_limitation"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_limitation" placeholder="Once per phase." />
                        </div>
                    </div>

                    <span class="mini flagTitle expanded-view floatLeft">Stat for rolls (used for calculations):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_stat" title="Stat for rolls" placeholder="STR, DEX, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Hit dice type (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_hitType">
                        <option value="Hit">Hit</option>
                        <option value="Critical">Critical</option>
                        <option value="None">None</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Damage/Healing (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_damageType">
                        <option value="Damage">Damage</option>
                        <option value="Healing">Healing</option>
                        <option value="Defense">Defense</option>
                        <option value="Effect">Effect</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Hit die (used for rolls):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_hitDie" title="Hit" placeholder="1d20cs20, 1d8, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Base effect dice/value (used to calculate damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_baseValue" title="Base effect value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Direct Hit dice/value (used to calculate extra damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_dhValue" title="Direct Hit value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Restoration value (used to restore own HP/MP/resource, include space)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_restore" title="Restore value" placeholder="5 MP, 5 HP, 5 Conviction, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on self (used to automatically add effects)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectSelf" title="Effect names" placeholder="Astral Fire, Surging Tempest" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on target (used to add effect shortcut button)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectTarget" title="Effect names" placeholder="Major Arcana, Mage's Ballad" />
                    <span class="mini flagTitle expanded-view floatLeft">Combo name (used for easy chaining to next ability)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_combo" title="Combo value" placeholder="Storm's Path, Storm's Eye" />
                </div>
            </div>
        </fieldset>
        <div class="collapse-overlay collapsed-view "></div>
    </div>

    <!-- Limit Break -->

    <div class="limit">
        <h3 class="large">Limit Break</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_limit">
            <div class="ability">
                <div class="header list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="hidden" class="usesFlag" name="attr_uses_max" />
                    <input type="hidden" class="costFlag" name="attr_cost" />
                    <input type="text" class="conditionFlag hidden" name="attr_condition" placeholder="P" />
                    <input type="text" class="triggerFlag hidden" name="attr_trigger" placeholder="P" />
                    <input type="text" class="targetFlag hidden" name="attr_target" placeholder="P" />
                    <input type="text" class="checkFlag hidden" name="attr_check" placeholder="P" />
                    <input type="text" class="crFlag hidden" name="attr_cr" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_limitExpandItem" />

                    <span class="mini flagTitle expanded-view floatLeft">Icon source:</span>
                    <input type="text" class="iconSource overrideContent expanded-view mini-input" name="attr_icon" title="Icon" placeholder="icon source" />

                    <div class="uses">
                        <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                        <input class="max mini-input floatRight" type="number" name="attr_uses_max" min="0" value="0" />
                        <span class="floatRight">/</span>
                        <input class="mini-input floatRight" type="number" name="attr_uses" min="0" value="0" />
                    </div>

                    <div class="header-title">
                        <img class="ability-icon" name="attr_icon" />
                        <div class="title adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="bold adaptive--text__span"  name="attr_title"></span>
                            <textarea class="adaptive--text__textarea" type="text" name="attr_title" placeholder="Paladin Combo (Fast Blade + Riot Blade)"></textarea>
                        </div>
                    </div>

                    <div class="ability-controls">
                        <button type="action" class="ability-action-trigger" name="act_trigger">t</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                        <button type="action" class="ability-action" name="act_share">q</button>
                        <button type="action" name="act_rolldamage" style="display: none;">d</button>
                        <button type="action" name="act_rolldamagewithbonus" style="display: none;">d</button>
                        <button type="action" name="act_runcombo1" style="display: none;">d</button>
                        <button type="action" name="act_runcombo2" style="display: none;">d</button>
                        <button type="action" name="act_runcombo3" style="display: none;">d</button>
                    </div>

                    <div class="type expanded-view">
                        <span class="mini-title floatLeft">Type:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input italic adaptive--text__span" name="attr_type"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_type" placeholder="Primary, Physical"></textarea>
                        </div>
                    </div>
                    <div class="cost expanded-view">
                        <span class="mini-title floatLeft">Cost:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cost"></span>
                            <input class="mini-input adaptive--input__input" type="number" name="attr_cost" placeholder="X" />
                        </div>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span"  name="attr_resource"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_resource" placeholder="Conviction" />
                        </div>
                    </div>
                    <div class="condition expanded-view">
                        <span class="mini-title floatLeft">Condition:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_condition"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_condition" placeholder="Under the effect of Fang and Claw Bared / Wheel in Motion Ready"></textarea>
                        </div>
                    </div>
                    <div class="trigger expanded-view">
                        <span class="mini-title floatLeft">Trigger:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_trigger"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_trigger" placeholder="Immediately after an ability check for an ability that targets you"></textarea>
                        </div>
                    </div>
                    <div class="target expanded-view">
                        <span class="mini-title floatLeft">Target:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_target"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_target" placeholder="Single"></textarea>
                        </div>
                    </div>
                    <div class="range expanded-view">
                        <span class="mini-title floatLeft">Range:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_range"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_range" placeholder="1 square"></textarea>
                        </div>
                    </div>
                    <div class="check expanded-view">
                        <span class="mini-title floatLeft">Check:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input bold adaptive--input__span" name="attr_check"></span>
                            <input class="mini-input bold adaptive--input__input" type="text" name="attr_check" placeholder="d20 + STR" />
                        </div>
                    </div>
                    <div class="cr expanded-view">
                        <span class="mini-title floatLeft">CR:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_cr"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_cr" placeholder="Target's Defense" />
                        </div>
                    </div>
                </div>

                <div class="body list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input type="text" class="directHitFlag hidden" name="attr_directHit" placeholder="P" />
                    <input type="text" class="effectFlag hidden" name="attr_effectName" placeholder="P" />
                    <input type="text" class="limitationFlag hidden" name="attr_limitation" placeholder="P" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_limitExpandItem" />

                    <div class="spacer expanded-view"></div>

                    <div class="base-effect expanded-view">
                        <span class="mini-title floatLeft">Base Effect:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_baseEffect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_baseEffect" placeholder="Deals 3 damage and inflicts Enmity on the target. Combo: Rage of Halone."></textarea>
                        </div>
                    </div>
                    <div class="direct-hit expanded-view">
                        <span class="mini-title floatLeft">Direct Hit:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_directHit"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_directHit" placeholder="Deals an additional 2d6 damage"></textarea>
                        </div>
                    </div>
                    <div class="ability-effect list expanded-view">
                        <div class="adaptive adaptive--input">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-title adaptive--input__span" name="attr_effectName"></span>
                            <span class="mini-title" name="attr_effectName">:</span>
                            <input class="mini-title adaptive--input__input" type="text" name="attr_effectName" placeholder="My Effect" />
                        </div>
                        <div class="adaptive adaptive--text">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--text__span" name="attr_effect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_effect" placeholder="Provides 1 HP Barrier"></textarea>
                        </div>
                    </div>
                    <div class="limitation expanded-view">
                        <span class="mini-title floatLeft">Limitation:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                            <span class="mini-input adaptive--input__span" name="attr_limitation"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_limitation" placeholder="Once per phase." />
                        </div>
                    </div>

                    <span class="mini flagTitle expanded-view floatLeft">Stat for rolls (used for calculations):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_stat" title="Stat for rolls" placeholder="STR, DEX, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Hit dice type (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_hitType">
                        <option value="Hit">Hit</option>
                        <option value="Critical">Critical</option>
                        <option value="None">None</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Damage/Healing (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_damageType">
                        <option value="Damage">Damage</option>
                        <option value="Healing">Healing</option>
                        <option value="Defense">Defense</option>
                        <option value="Effect">Effect</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Hit die (used for rolls):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_hitDie" title="Hit" placeholder="1d20cs20, 1d8, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Base effect dice/value (used to calculate damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_baseValue" title="Base effect value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Direct Hit dice/value (used to calculate extra damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_dhValue" title="Direct Hit value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Restoration value (used to restore own HP/MP/resource, include space)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_restore" title="Restore value" placeholder="5 MP, 5 HP, 5 Conviction, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on self (used to automatically add effects)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectSelf" title="Effect names" placeholder="Astral Fire, Surging Tempest" />
                    <span class="mini flagTitle expanded-view floatLeft">Effects on target (used to add effect shortcut button)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_effectTarget" title="Effect names" placeholder="Major Arcana, Mage's Ballad" />
                    <span class="mini flagTitle expanded-view floatLeft">Combo name (used for easy chaining to next ability)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_combo" title="Combo value" placeholder="Storm's Path, Storm's Eye" />
                </div>
            </div>
        </fieldset>
    </div>
</div>

<!-- Items page -->

<div class="items" spellcheck="false">

    <div class="ability-top">
        <button type="action" class="floatRight" name="act_expandAllItems">Expand All</button>
        <button type="action" class="floatRight" name="act_collapseAllItems">Collapse All</button>
    </div>

    <div class="grid">
        <div class="left fancy lowkey section list">

            <!-- Title List -->

            <h3 class="small colored-in">Titles</h3> 
            <fieldset class="repeating_titles">
                <div class="trait list">
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_titlesExpandItem" />
                    <div class="grid3 item-header">
                        <input class="medium" type="text" name="attr_title" placeholder="Enter the title name"></span>
                        <button type="action" class="ability-action" style="margin-left: auto;" name="act_share">q</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                    </div>
                    <div class="item-body list expanded-view">
                        <span class="header medium bold" style="margin-top: 4px;">Effect:</span>
                        <div class="adaptive adaptive--text floatLeft" style="margin-bottom: 8px;">
                            <span class="mini-input adaptive--text__span"  name="attr_effect"></span>
                            <textarea class="mini-input adaptive--text__textarea" name="attr_effect" placeholder="The effect provided by the Title"></textarea>
                        </div>
                        <div class="equip-container">
                            <button type="action" class="select floatRight" name="act_select">Equip</button>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- Minion List -->

            <h3 class="small colored-in">Minions</h3>
            <fieldset class="repeating_minions">
                <div class="trait list">
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_minionsExpandItem" />
                    <div class="grid3 item-header">
                        <input class="medium" type="text" name="attr_title" placeholder="Enter the minion's name"></span>
                        <button type="action" class="ability-action" style="margin-left: auto;" name="act_share">q</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                    </div>
                    <div class="item-body list expanded-view">
                        <span class="header medium bold" style="margin-top: 4px;">Effect:</span>
                        <div class="adaptive adaptive--text floatLeft" style="margin-bottom: 8px;">
                            <span class="mini-input adaptive--text__span"  name="attr_effect"></span>
                            <textarea class="mini-input adaptive--text__textarea" name="attr_effect" placeholder="The effect provided by the Minion"></textarea>
                        </div>
                        <div class="equip-container">
                            <button type="action" class="select floatRight" name="act_select">Equip</button>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>

        <!-- Item List -->

        <div class="right fancy lowkey section list vertical-span2">
            <h3 class="small colored-in">Items</h3>
            <fieldset class="repeating_items">

                <div class="trait list">
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_itemsExpandItem" />
                    <div class="grid4 item-header">
                        <input class="medium" name="attr_title" type="text" placeholder="Item name" />
                        <input class="medium stat" name="attr_count" type="number" value="1" min="0" />
                        <button type="action" class="ability-action" style="margin-left: auto;" name="act_share">q</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                    </div>
                    <div class="item-body list expanded-view">
                        <span class="header medium bold" style="margin-top: 4px;">Effect:</span>
                        <div class="adaptive adaptive--text floatLeft" style="margin-bottom: 8px;">
                            <span class="mini-input adaptive--text__span"  name="attr_effect"></span>
                            <textarea class="mini-input adaptive--text__textarea" name="attr_effect" placeholder="The item's effect"></textarea>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>
    </div>
</div>

<div class="char-settings" spellcheck="false">
    <div class="grid">
        <div class="entry fancy lowkey">
            <h3>Character type</h3>
            <p class="medium" style="margin-top: 8px;">Determines if calculations use the selected token or the character sheet.</p>
            <select name="attr_sheet_type">
                <option value="generic">Generic</option>
                <option value="unique">Unique</option>
            </select>
        </div>

        <div class="entry fancy lowkey">
            <h3>Team</h3>
            <p class="medium" style="margin-top: 8px;">Determines at which step in turn order the character regenerates MP.</p>
            <select name="attr_team">
                <option value="">--Select--</option>
                <option value="adventurer">Adventurer</option>
                <option value="enemy">Enemy</option>
            </select>
        </div>

        <div class="entry fancy lowkey">
            <h3>Job selector</h3>
            <p class="medium" style="margin-top: 8px;">Assigns the job, with automatically added actions (only some jobs supported)</p>
            <select name="attr_job">
                <option value="">--Select--</option>
                <!--
                <option value="DRK">Dark Knight</option>
                <option value="GNB">Gunbreaker</option>
                <option value="PLD">Paladin</option>
                <option value="WAR">Warrior</option>
                <hr />
                <option value="AST">Astrologian</option>
                <option value="SGE">Sage</option>
                <option value="SCH">Scholar</option>
                <option value="WHM">White Mage</option>
                <hr />
                <option value="DRG">Dragoon</option>
                <option value="MNK">Monk</option>
                <option value="NIN">Ninja</option>
                <option value="RPR">Reaper</option>
                <option value="SAM">Samurai</option>
                <option value="VIP">Viper</option>
                <hr />
                <option value="BRD">Bard</option>
                <option value="DNC">Dancer</option>
                <option value="MCH">Machinist</option>
                <hr />
                !-->
                <option value="BLM">Black Mage</option>
                <!--
                <option value="PCT">Pictomancer</option>
                <option value="RDM">Red Mage</option>
                <option value="SMN">Summoner</option>
                <hr />
                <option value="BLU">Blue Mage</option>
                -->
            </select>
        </div>
    </div>

    <div class="override fancy lowkey">
        <h3>Manual Override</h3>
        <p class="medium" style="margin-top: 8px;">Enables manual input for things the player would normally not mess with, things used mostly during initial sheet creation.</p>
        <p class="medium">Mess with at your own risk!</p>
        <input type="text" class="large" name="attr_override" placeholder="Enter 'auto' to disable manual editing" value="" />
    </div>
</div>

<div class="attribution list">
    <span class="mini">FXIV TTRPG Character Sheet for Roll20. Fan-made, no association with Square Enix.</span>
    <span class="mini">Custom borders and icons for jobs, abilities and effects are property of Square Enix Ltd.</span>
</div>

<!-- ---------------------------SHEET WORKERS----------------- -->

<script type="text/worker">
    // Tabs
    const buttonlist = ["character", "items", "abilities", "settings"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, () => {
            setAttrs({
                sheetTab: button
            });
        });
    });

    // Initial setup
    on("sheet:opened", () => {
        getAttrs([
            "d20",
            "advantage",
            "mpRecovery",
            "mpRecoveryBlock",
            "resourceRecovery",
            "resource2Recovery",
            "resource",
            "resource2"
        ], values => {
            setAttrs({
                d20: values.d20 ?? "1d20",
                advantage: values.advantage ?? 0,
                mpRecovery: values.mpRecovery ?? 2,
                mpRecoveryBlock: values.mpRecoveryBlock ?? "off",
                resourceRecovery: values.resourceRecovery ?? 0,
                resource2Recovery: values.resource2Recovery ?? 0,
                resource: values.resource ?? "",
                resource2: values.resource2 ?? "none"
            })
        })
    })
</script>

<script type="text/worker">
    // Items
    function shareItemToChat(eventInfo) {
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]
        getAttrs([
            `repeating_${section}_${rowId}_title`,
            `repeating_${section}_${rowId}_effect`,
        ], values => {
            const title = values[`repeating_${section}_${rowId}_title`]
            const effect = values[`repeating_${section}_${rowId}_effect`]

            var type
            switch (section) {
                case "items":
                    type = "Item"
                    break
                case "titles":
                    type = "Title"
                    break
                case "minions":
                    type = "Minion"
                    break
                case "traits":
                    type = "Trait"
                    break
                default:
                    console.log("Unrecognized item type " + section)
                    return
            }

            startRoll(`&{template:item} {{title=${title}}} {{type=${type}}} {{effect=${effect}}}`, results => {
                finishRoll(results.rollId)
            })
        })
    }

    // Remove items with zero content
    on("change:repeating_items:count", eventInfo => {
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]

        let newValue = parseInt(eventInfo.newValue)
        if (isNaN(newValue)) {
            log("Cannot manage items with NaN count")
            return
        }
        if (newValue <= 0) {
            log("Removing consumed item")
            removeRepeatingRow(`repeating_${section}_${rowId}`)
        }
    })

    on("clicked:repeating_titles:share clicked:repeating_minions:share clicked:repeating_items:share clicked:repeating_traits:share", eventInfo => {
        shareItemToChat(eventInfo)
    })

    on("clicked:repeating_titles:select", eventInfo => {
        const rowid = eventInfo.sourceAttribute.split("_")[2]
        getAttrs([
            `repeating_titles_${rowid}_title`, 
            `repeating_titles_${rowid}_effect`
        ], values => {
            // Assign selected title
            setAttrs({
                selectedTitleId: rowid,
                selectedTitle: values[`repeating_titles_${rowid}_title`],
                selectedTitleEffect: values[`repeating_titles_${rowid}_effect`]
            })
        })
    })

    // Minion selection
    on("clicked:repeating_minions:select", eventInfo => {
        const rowid = eventInfo.sourceAttribute.split("_")[2]
        getAttrs([
            `repeating_minions_${rowid}_title`, 
            `repeating_minions_${rowid}_effect`
        ], values => {
            // Assign selected minion
            setAttrs({
                selectedMinionId: rowid,
                selectedMinion: values[`repeating_minions_${rowid}_title`],
                selectedMinionEffect: values[`repeating_minions_${rowid}_effect`]
            })
        })
    })
</script>

<script type="text/worker">
    // Advantage management
    function addAdvantage(change) {
        getAttrs(["advantage"], values => {
            const advantage = Math.min(Math.max(values.advantage + change, -3), 3)
            let numberOfAdvantageDice = Math.abs(advantage)
            let numberOfDice = 1 + numberOfAdvantageDice
            let keepMarker
            if (advantage == 0) {
                keepMarker = ""
            } else if (advantage > 0) {
                keepMarker = "kh1"
            } else {
                keepMarker = "kl1"
            }
            setAttrs({
                advantage: advantage,
                d20: numberOfDice + "d20" + keepMarker
            })
        })
    }

    on("clicked:increaseAdvantage", eventInfo => {
        addAdvantage(1)
    })

    on("clicked:decreaseAdvantage", eventInfo => {
        addAdvantage(-1)
    })

    on("clicked:clearAdvantage", eventInfo => {
        setAttrs({
            advantage: 0,
            d20: "1d20"
        })
    })

    // HP Max
    on("change:hitPoints", () => {
        getAttrs(["hitPoints", "hitPoints_max"], values => {
            if (values.hitPoints > values.hitPoints_max) {
                setAttrs({
                    hitPoints: values.hitPoints_max
                })
            }
        })
    })

    // MP Max
    on("change:magicPoints", () => {
        getAttrs(["magicPoints", "magicPoints_max"], values => {
            if (values.magicPoints > values.magicPoints_max) {
                console.log("Reset MP")
                setAttrs({
                    magicPoints: values.magicPoints_max
                })
            }
        })
    })

    // Resource Max
    on("change:resourceValue", () => {
        getAttrs(["resourceValue", "resourceValue_max"], values => {
            if (values.resourceValue > values.resourceValue_max) {
                console.log("Reset resource")
                setAttrs({
                    resourceValue: values.resourceValue_max
                })
            }
        })
    })

</script>

<script type="text/worker">
    // Assign override state
    on('change:override', () => {
        getAttrs(['override'], values => {
            console.log("Changed override to " + values.override)
            getSectionIDs('repeating_limit', ids => {
                const output = {}
                ids.forEach(id => output[`repeating_limit_${id}_repeatingOverride`] = values.override)
                setAttrs(output)
            })
            getSectionIDs('repeating_song', ids => {
                const output = {}
                ids.forEach(id => output[`repeating_song_${id}_repeatingOverride`] = values.override)
                setAttrs(output)
            })
            getSectionIDs('repeating_primary', ids => {
                const output = {}
                ids.forEach(id => output[`repeating_primary_${id}_repeatingOverride`] = values.override)
                setAttrs(output)
            })
            getSectionIDs('repeating_ninjutsu', ids => {
                const output = {}
                ids.forEach(id => output[`repeating_ninjutsu_${id}_repeatingOverride`] = values.override)
                setAttrs(output)
            })
            getSectionIDs('repeating_secondary', ids => {
                const output = {}
                ids.forEach(id => output[`repeating_secondary_${id}_repeatingOverride`] = values.override)
                setAttrs(output)
            })
            getSectionIDs('repeating_instant', ids => {
                const output = {}
                ids.forEach(id => output[`repeating_instant_${id}_repeatingOverride`] = values.override)
                setAttrs(output)
            })
            getSectionIDs('repeating_technique', ids => {
                const output = {}
                ids.forEach(id => output[`repeating_technique_${id}_repeatingOverride`] = values.override)
                setAttrs(output)
            })
        })
    })
</script>

<script type="text/worker">
    // Expand/collapse
    const abilitySections = ["limit", "song", "primary", "ninjutsu", "secondary", "instant", "technique"]
    const itemSections = ["titles", "minions", "items"]

    function toggleExpandedState(attributeName) {
        getAttrs([attributeName], values => {
            // Toggle
            const value = values[attributeName]
            var attributes = {}
            var newValue = "on"
            if (value == "on" || value == "1") { 
                newValue = "off"
            } else if (value == "off" || value == "0") {
                newValue = "on"
            }
            attributes[attributeName] = newValue
            setAttrs(attributes)
        })
    }
    
    function toggleExpandedStateInSection(eventInfo) {
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]
        toggleExpandedState(`repeating_${section}_${rowId}_${section}ExpandItem`)
    }

    function setExpandedStateForSection(isExpanded, section) {
        getSectionIDs(`repeating_${section}`, ids => {
            var attributes = {}
            for (let id of ids) {
                attributes[`repeating_${section}_${id}_${section}ExpandItem`] = isExpanded ? "on" : "off"
            }
            if (Object.keys(attributes).length > 0) {
                setAttrs(attributes)
            }
        })
    }

    const toggleSections = ["traits"].concat(itemSections).concat(abilitySections)
    for (let section of toggleSections) {
        on(`clicked:repeating_${section}:info`, eventInfo => {
            toggleExpandedStateInSection(eventInfo)
        })
    }

    on("clicked:song_info clicked:primary_info clicked:ninjutsu_info clicked:secondary_info clicked:instant_info clicked:technique_info", eventInfo => {
        const actionComponents = eventInfo.htmlAttributes.name.split("_")
        const section = actionComponents[1]
        toggleExpandedState(`${section}HeaderExpandItem`)
    })

    on("clicked:expandAllTraits", eventInfo => {
        setExpandedStateForSection(true, "traits")
    })

    on("clicked:collapseAllTraits", eventInfo => {
        setExpandedStateForSection(false, "traits")
    })

    on("clicked:expandAllItems", eventInfo => {
        for (let section of itemSections) {
            setExpandedStateForSection(true, section)
        }
    })

    on("clicked:collapseAllItems", eventInfo => {
        for (let section of itemSections) {
            setExpandedStateForSection(false, section)
        }
    })

    on("clicked:expandAllAbilities", eventInfo => {
        for (let section of abilitySections) {
            setExpandedStateForSection(true, section)
        }
        setAttrs({
            songHeaderExpandItem: "on",
            primaryHeaderExpandItem: "on",
            secondaryHeaderExpandItem: "on",
            instantHeaderExpandItem: "on",
            techniqueHeaderExpandItem: "on",
        })
    })

    on("clicked:collapseAllAbilities", eventInfo => {
        for (let section of abilitySections) {
            setExpandedStateForSection(false, section)
        }
        setAttrs({
            songHeaderExpandItem: "off",
            primaryHeaderExpandItem: "off",
            secondaryHeaderExpandItem: "off",
            instantHeaderExpandItem: "off",
            techniqueHeaderExpandItem: "off",
        })
    })

</script>

<script type="text/worker">
    const abilitySections = ["limit", "song", "primary", "ninjutsu", "secondary", "instant", "technique"]
    const effectData = {
        advantage: { type: "advantage", name: "Advantage", expiry: "use" },
        astral_fire: { type: "special", specialType: "Astral Fire", name: "Astral Fire", expiry: "turn2", duplicate: "block" },
        attribute: { type: "attribute(x)", name: "Attribute Up (X)", expiry: "use" },
        barrier: { type: "special", specialType: "Barrier(X)", name: "Barrier (X)", expiry: "turn", duplicate: "allow" }, 
        blind: { type: "blind", name: "Blind", expiry: "encounter", curable: true, duplicate: "block" },
        bound: { type: "bound", name: "Bound", expiry: "encounter", curable: true, duplicate: "block" },
        brink: { type: "brink", name: "Brink of Death", expiry: "rest", duplicate: "block" },
        comatose: { type: "comatose", name: "Comatose", expiry: "rest", duplicate: "block" },
        critical: { type: "critical(x)", name: "Critical Up (X)", expiry: "use" },
        damage: { type: "damage", name: "Damage Reroll", expiry: "use" },
        dot: { type: "dot(x)", name: "DOT (X)", expiry: "phase", curable: true },
        enmity: { type: "enmity(x)", name: "Enmity (X)", expiry: "turn", duplicate: "replace" },
        hawks_eye: { type: "special", specialType: "Hawk's Eye", name: "Hawk's Eye", expiry: "use", duplicate: "block" },
        heavy: { type: "heavy", name: "Heavy", expiry: "turn", curable: true, duplicate: "block" },
        major_arcana: { type: "special", specialType: "Major Arcana", name: "Major Arcana", expiry: "use", duplicate: "replace" },
        lucid_dreaming: { type: "special", specialType: "Lucid Dreaming", name: "Lucid Dreaming", expiry: "turn", duplicate: "replace" },
        paralyzed: { type: "paralyzed", name: "Paralyzed", expiry: "turn", curable: true, duplicate: "block" },
        petrified: { type: "petrified", name: "Petrified", expiry: "turn2", curable: true, duplicate: "block" },
        prone: { type: "prone", name: "Prone", expiry: "encounter", curable: true, duplicate: "block" },
        ready: { type: "ready(x)", name: "(X) Ready", expiry: "use", duplicate: "block" },
        regen: { type: "regen(x)", name: "Regen (X)", expiry: "phase" },
        roll: { type: "roll(x)", name: "Roll Up (X)", expiry: "use" },
        silence: { type: "silence", name: "Silence", expiry: "turn", curable: true, duplicate: "block" },
        sleep: { type: "sleep", name: "Sleep", expiry: "damage", curable: true, duplicate: "block" },
        slow: { type: "slow", name: "Slow", expiry: "encounter", curable: true, duplicate: "block" },
        stun: { type: "stun", name: "Stun", expiry: "turn", duplicate: "block" },
        surging_tempest: { type: "special", specialType: "Surging Tempest", name: "Surging Tempest", expiry: "encounter", duplicate: "block" },
        thunderhead_ready: { type: "special", specialType: "Thunderhead Ready", name: "Thunderhead Ready", expiry: "use", duplicate: "block" },
        unstunnable: { type: "unstunnable", name: "Unstunnable", expiry: "phase", duplicate: "block" },
        umbral_ice: { type: "special", specialType: "Umbral Ice", name: "Umbral Ice", expiry: "turn2", duplicate: "block" },
        weak: { type: "weak", name: "Weak", expiry: "rest", duplicate: "block" }
    }

    const sheets = {
        level30: {
            blm: {
                job: "BLM",
                jobIcon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Jobs/BLM.png",
                role: "DPS / Black Mage",
                level: 30,
                attributes: { str: 0, dex: 2, vit: 1, int: 5, mnd: 4, defense: 11, magicDefense: 15, vigilance: 14, hitPoints: 21, hitPoints_max: 21, magicPoints: 5, magicPoints_max: 5, resource: "", resourceValue: 0, resourceValue_max: 0, resource2: "none", resourceValue2: 0, resourceValue2_max: 0 },
                traits: [
                    { title: "Consecutive Invocation", effect: "On your turn, after resolving the effects of an ability that enables this trait, you may forgo all standard movement until the end of your turn to use a additional invoked primary ability. You may choose a new target when using this additional ability. Consecutive Invocation can only be used once per turn, and does not prevent you from using focus to perform additional secondary action." },
                    { title: "Umbral Ice", effect: "Certain effects grant you Umbral Ice. While under the effect of Umbral Ice, your ice-aspected abilities restore 5 MP each time they deal damage. Umbral Ice is removed when you are granted Astral Fire or, if the effect is not renewed, at the end of your next turn." },
                    { title: "Astral Fire", effect: "Certain effects grant you Astral Fire. While under the effect of Astral Fire your fire-aspected abilities deal an additional 1d6 damage and you do not recover MP at the end of the [Adventurer Step].\n\nAstral Fire is removed when you are granted Umbral Ice or, if the effect is not renewed, at the end of your next turn." },
                    { title: "Thunderhead Ready", effect: "Whenever you are granted Umbral Ice while not under the effect of Umbral Ice, or Astral Fire while not under the effect of Astral Fire grant Thunderhead Ready*.\n\n*You cannot use a thunder spell ability to inflict a DOT on a character already suffering from a DOT inflicted by one of your thunder spell abilities."}
                ],
                abilities: {
                    primary: [
                        { title: "Blizzard", type: "Primary, Magic, Ice-Aspected, Invoked", cost: 1, uses: 0, uses_max: 0, resource: "MP", target: "Single", range: "10 squares", check: "INT (d20 + 5)", cr: "Target's Magic Defense", baseEffect: "Deals 3 damage to the target, grants Umbral Ice, and enables Consecutive Invocation.", directHit: "Deals an additional 1d6 damage.", stat: "INT", hitType: "Hit", damageType: "Damage", hitDie: "1d20cs20", baseValue: "3", dhValue: "1d6", effectSelf: "Umbral Ice", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/BLM/blizzard.png" },
                        { title: "Fire", type: "Primary, Magic, Fire-Aspected, Invoked", cost: 2, uses: 0, uses_max: 0, resource: "MP", target: "Single", range: "10 squares", check: "INT (d20 + 5)", cr: "Target's Magic Defense", baseEffect: "Deals 3 damage to the target, grants Astral Fire, and enables Consecutive Invocation.", directHit: "Deals an additonal 1d6 damage.", stat: "INT", hitType: "Hit", damageType: "Damage", hitDie: "1d20cs20", baseValue: "3", dhValue: "1d6", effectSelf: "Astral Fire", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/BLM/fire.png" },
                        { title: "Sleep", type: "Primary, Magic, Invoked", cost: 2, resource: "MP", uses: 0, uses_max: 0, target: "All enemies within range", range: "A 5x5 area within 10 squares of this character", check: "INT (d20 + 5)", cr: "Target's Magic Defense", baseEffect: "Inflicts Sleep on all targets.", directHit: "Removes all markers generated by all targets.", stat: "INT", hitType: "Hit", damageType: "Effect", hitDie: "1d20cs20", baseValue: "", dhValue: "", effectSelf: "", effectTarget: "Sleep", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/Caster/sleep.png" },
                        { title: "Blizzard II", type: "Primary, Magic, Ice-Aspected, Invoked", cost: 2, resource: "MP", uses: 0, uses_max: 0, target: "All enemies within range", range: "A 5x5 area within 10 squares of this character", check: "INT (d20 + 5)", cr: "Target's Magic Defense", baseEffect: "Deals 3 damage to all targets and grants Umbral Ice.", directHit: "Deals an additional 1d6 damage.", stat: "INT", hitType: "Hit", damageType: "Damage", hitDie: "1d20cs20", baseValue: "3", dhValue: "1d6", effectSelf: "Umbral Ice", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/BLM/blizzard-ii.png" },
                        { title: "Fire II", type: "Primary, Magic, Fire-Aspected, Invoked", cost: 3, resource: "MP", uses: 0, uses_max: 0, target: "All enemies within range", range: "A 5x5 area within 10 squares of this character", check: "INT (d20 + 5)", cr: "Target's Magic Defense", baseEffect: "Deals 3 damage to all targets and grants Astral Fire", directHit: "Deals an additional 1d6 damage.", stat: "INT", hitType: "Hit", damageType: "Damage", hitDie: "1d20cs20", baseValue: "3", dhValue: "1d6", effectSelf: "Astral Fire", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/BLM/fire-ii.png" }
                    ],
                    secondary: [
                        { title: "Transpose", type: "Secondary", cost: 0, uses: 0, uses_max: 0, baseEffect: "Removes Umbral Ice and grants Astral Fire, or removes Astral Fire and grants Umbral Ice. Transpose can only be used once per turn.", hitType: "None", damageType: "Effect", effectSelf: "Transpose", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/BLM/transpose.png" },
                        { title: "Thunder", type: "Secondary, Magic, Lightning-Aspected, Thunder-Spell", condition: "Under the effect of Thunderhead Ready", cost: 0, uses: 0, uses_max: 0, target: "Single", range: "10 squares", baseEffect: "Deals 2 damage and inflicts a DOT (3) on the target.", hitType: "None", damageType: "Damage", baseValue: "2", effectTarget: "DOT(3)", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/BLM/thunder.png" },
                        { title: "Manafont", type: "Secondary", condition: "Under the effect of Astral Fire", cost: 0, uses: 1, uses_max: 1, baseEffect: "Fully restores MP and grants Thunderhead Ready.", limitation: "Once per phase.", hitType: "None", damageType: "Effect", restore: "5 MP", effectSelf: "Thunderhead Ready", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/BLM/manafont.png" },
                        { title: "Lucid Dreaming", type: "Secondary", cost: 0, uses: 1, uses_max: 1, baseEffect: "Recover an additional 1 MP at the end of this round's [Adventurer Step].", limitation: "Once per phase.", hitType: "None", damageType: "Effect", effectSelf: "Lucid Dreaming", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/Caster/lucid-dreaming.png" },
                        { title: "Thunder II", type: "Secondary, Magic, Lightning-Aspected, Thunder Spell", condition: "Under the effect of Thunderhead Ready", cost: 0, uses: 0, uses_max: 0, target: "All enemies within range", range: "A 5x5 area within 10 squares of this character.", baseEffect: "Inflicts a DOT (3) on all targets.", hitType: "None", damageType: "Effect", effectTarget: "DOT(3)", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/BLM/thunder-ii.png" },
                        { title: "Manaward", type: "Secondary", cost: 0, uses: 1, uses_max: 1, baseEffect: "Grants a barrier of 2 HP.", limitation: "Once per phase.", hitType: "None", damageType: "Effect", effectSelf: "Barrier(2)", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/BLM/manaward.png" },
                        { title: "Scathe", type: "Secondary, Magic", cost: 1, resource: "MP", uses: 0, uses_max: 0, target: "Single", range: "10 squares", baseEffect: "Deals 4 damage to the target.", hitType: "None", damageType: "Damage", baseValue: "4", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/BLM/scathe.png" }
                    ],
                    instant: [
                        { title: "Addle", type: "Instant", cost: 0, uses: 1, uses_max: 1, trigger: "Immediately before an ability used by an enemy is resolved.", target: "The enemy that triggered this ability.", range: "5 squares", baseEffect: "Reduces the damage dealt by the target's abilities by 2 until the end of this turn.", limitation: "Once per phase", hitType: "None", damageType: "Defense", baseValue: "2", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/Caster/addle.png" },
                        { title: "Swiftcast", type: "Instant", cost: 0, uses: 1, uses_max: 1, trigger: "When any character ends their turn", baseEffect: "Immediately use on of your magic abilities.", limitation: "Once per phase", hitType: "None", damageType: "Damage", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/Caster/swiftcast.png" }
                    ],
                    limit: [
                        { title: "Meteor", type: "Limit Break, Magic, Fire-Aspected", cost: 0, uses: 1, uses_max: 1, condition: "Limit Breaks are available", trigger: "Any time", target: "All enemies within range", range: "A 5x5 area within 10 squares of this character", baseEffect: "Deals 4d6 damage to all targets.", hitType: "None", damageType: "Damage", baseValue: "4d6", icon: "https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Abilities/General/limit-break.png" }
                    ]
                }
            }
        }
    }

    // Abilities
    function getAttrsAndEffects(bonusAttributes, completion) {
        getSectionIDs("repeating_effects", ids => {
            const attributes = ids.flatMap((element) => [
                `repeating_effects_${element}_type`,
                `repeating_effects_${element}_specialType`,
                `repeating_effects_${element}_value`,
                `repeating_effects_${element}_expiry`
            ])
            getAttrs(attributes.concat(bonusAttributes), values => {
                var sortedValues = {}
                const effectKeys = Object.keys(values).filter((key) => key.includes("repeating_effects"))
                for (let attribute of effectKeys) {
                    let components = attribute.split("_")
                    let id = components[2]
                    let attributeName = components[3]
                    if (!sortedValues[id]) {
                        sortedValues[id] = {
                            id: id,
                            fullId: `repeating_effects_${id}`
                        }
                    }
                    sortedValues[id][attributeName] = values[attribute]
                }
                const valueObjects = Object.values(sortedValues)
                completion(values, classifyEffects(valueObjects))
            })
        })
    }

    function getEffects(completion) {
        getAttrsAndEffects([], (values, effects) => {
            completion(effects)
        })
    }

    function removeEffects(names, skipId) {
        getEffects(effects => {
            let matches = effects.effects.filter(effect => {
                if (effect.id == skipId) {
                    return false
                }
                return names.includes(effect.type) || names.includes(effect.specialType.trim().toLowerCase())
            })
            for (let match of matches) {
                log(`Removing effect ${match.id} with the type ${match.specialType || match.type}`)
                removeRepeatingRow(match.fullId)
            }
        })
    }

    function classifyEffects(effects) {
        var result = {
            effects: [],
            criticalThreshold: 20
        }
        for (let effect of effects) {
            result.effects.push(effect)

            if (effect.type == "special") {
                switch (effect.specialType.trim().toLowerCase()) {
                    case "astral fire":
                        result.astralFireId = effect.fullId
                        break
                    case "hawk's eye":
                        result.hawksEyeId = effect.fullId
                        break
                    case "major arcana":
                        result.hasDamageReroll = true
                        break
                    case "surging tempest":
                        result.surgingTempestId = effect.fullId
                        break
                    case "umbral ice":
                        result.umbralIceId = effect.fullId
                        break
                }
            } else {
                switch (effect.type) {
                    case "critical(x)":
                        if (effect.value) {
                            result.criticalThreshold -= parseInt(effect.value)
                        }
                        break
                    case "damage":
                        result.hasDamageReroll = true
                        break
                }
            }
        }
        return result
    }

    function addEffectsToRoll(effects, rollMacro, rollType) {
        var penalty = 0
        var hasParalysis = false
        var criticalUp = 0
        var attributeUp = {}
        var blindPenalty = 0
        var hasHawksEye = false
        for (let effect of effects.effects) {
            var effectName = effect.type
            if (effect.type == "special") {
                effectName = effect.specialType.trim().toLowerCase()
            }
            switch (effectName) {
                case "attribute(x)":
                    const attributeDefinition = effect.value.trim()
                    var match = attributeDefinition.match(/^\-?\d+/)
                    if (!match) {
                        match = attributeDefinition.match(/\-?\d+$/)
                    }
                    if (!match) {
                        console.log("Invalid attribute declaration will not be added to roll " + attributeDefinition)
                        break
                    }
                    const value = parseInt(match[0])
                    const attribute = attributeDefinition.replace(match[0], "").trim().toLowerCase()
                    attributeUp[attribute] = value
                    break
                case "blind":
                    blindPenalty = 2
                    break
                case "brink":
                    penalty += 5
                    break
                case "critical(x)":
                    if (effect.value) {
                        criticalUp += parseInt(effect.value)
                    }
                    break
                case "hawk's eye":
                    hasHawksEye = true
                    break
                case "paralyzed":
                    if (rollType == "primary") {
                        hasParalysis = true
                    }
                    break
                case "petrified":
                    penalty += 5
                    break
                case "prone":
                    penalty += 2
                    break
                case "sleep":
                    penalty += 3
                    break
                case "slow":
                    penalty += 2
                    break
                case "stun":
                    penalty += 5
                    break
                case "weak":
                    penalty += 2
                    break
            }
        }
        var updatedMacro = rollMacro
        if (hasParalysis) {
            updatedMacro = updatedMacro.replace(/cs\>?20/, "cs>20cf<5[chance of paralysis]")
        }
        if (criticalUp > 0) {
            updatedMacro = updatedMacro.replace(/cs\>?20/, `cs>${20 - criticalUp}`)
        }
        if (!hasHawksEye) {
            // Hawk's Eye nullifies penalty from Blind
            penalty += blindPenalty
        }
        if (penalty > 0) {
            updatedMacro = `${updatedMacro} - ${penalty}[penalty]`
        }
        const matches = [...updatedMacro.matchAll(/@\{([a-z]{3})\}/g)]
        for (let match of matches) {
            const attributeName = match[1]
            const attributeValue = attributeUp[attributeName]
            if (!attributeValue) {
                continue
            }
            updatedMacro = updatedMacro.replace(
                match[0], 
                `${match[0]}[${attributeName.toUpperCase()}] + ${attributeUp[attributeName]}[${attributeName.toUpperCase()} bonus]`
            )
        }
        return updatedMacro
    }

    function addEffectsToPreDamageRolls(effects, level, type, damageRoll, directHitRoll) {
        let isFireType = type.toLowerCase().includes("fire-aspect")
        if (isFireType && effects.astralFireId) {
            let addedDamage = level >= 50 ? "2d6" : "1d6"
            let updatedDamage
            if (damageRoll) {
                updatedDamage = `${damageRoll} + ${addedDamage}[Astral Fire]`
            } else {
                updatedDamage = `${addedDamage}[Astral Fire]`
            }
            return {
                damage: updatedDamage,
                directHit: directHitRoll
            }
        }
        return {
            damage: damageRoll,
            directHit: directHitRoll
        }
    }

    function addEffectsToPostDamageRolls(effects, damageRolls) {
        var result = {}
        var summaries = []
        if (effects.hasDamageReroll && damageRolls.some(roll => roll.dice && roll.dice.length > 0)) {
            summaries.push("--Damage reroll available--")
        }

        if (effects.surgingTempestId) {
        var rolls = []
        var total = 0
        var appliedSurgingTempest = false
        for (let roll of damageRolls) {
            if (!roll || !roll.result) {
                rolls.push("")
                continue
            }

            let dice = roll.dice
            if (!dice || dice.length == 0) {
                total += roll.result
                rolls.push(roll.result)
                continue
            }
            let diceResult = dice.reduce(
                (accumulator, currentValue) => {
                    if (currentValue == 1) {
                        appliedSurgingTempest = true
                        return 2 + accumulator
                    }
                    return currentValue + accumulator
                },
                0
            )
            let rawAdditions = roll.expression.split("+").reduce(
                (accumulator, currentValue) => {
                    let trimmed = currentValue.trim()
                    if (trimmed.includes("d")) {
                        return accumulator
                    }
                    let value = parseInt(trimmed)
                    if (isNaN(value)) {
                        log(`Unexpected NaN ${trimmed} from expression ${expression}`)
                        return accumulator
                    }
                    return accumulator + parseInt(trimmed)
                },
                0
            )

            let newResult = diceResult + rawAdditions
            total += newResult
            rolls.push(newResult)
        }
        result.rolls = rolls
        result.total = total
        if (appliedSurgingTempest) {
                summaries.push("Surging Tempest proc")
            }
        } else {
            var rolls = damageRolls.map(roll => roll.result)
            let total = rolls.reduce(
                (accumulator, currentValue) => (currentValue ?? 0) + accumulator,
                0
            )
            result.rolls = rolls
            result.total = total
        }
        result.summary = summaries.join(", ")

        return result
    }

    function searchableEffectName(name) {
        return name
            .replace(/\((\w+)\)/, "")
            .replace(" ", "_")
            .trim().toLowerCase()
    }

    function consumeEffectsOnAbility(name, condition, effects) {
        var summaries = []
        log("Consuming effects for " + name + ", condition " + condition)
        for (let effect of effects.effects) {
            let normalizedName = name.toLowerCase()
            let normalizedCondition = condition.toLowerCase()
            let specialType = (effect.specialType ?? "").toLowerCase()
            let value = (effect.value ?? "").toLowerCase()
            let isReadyType = effect.type == "ready(x)"
            
            if (!isReadyType && !specialType.includes(" ready")) {
                continue
            }

            if (
                specialType.includes(normalizedName) ||
                normalizedCondition.includes(specialType) ||
                (isReadyType && value == normalizedName) ||
                (isReadyType && normalizedCondition.includes(value))
            ) {
                log("Consuming effect " + JSON.stringify(effect))
                // Consume X Ready
                removeRepeatingRow(effect.fullId)

                let effectName = effect.specialType || effectData[effect.type.replace("(x)", "")].name
                summaries.push(`Consumed ${(effectName.replace("(X)", effect.value))}`)
            }
        }
        return summaries.join(", ")
    }

    function buttonsForTargetEffects(effects, level) {
        var buttons = []

        log("Preparing target effects: " + JSON.stringify(effects))
        for (let effect of effects) {
            let adjustedEffect = searchableEffectName(effect)
            let data = effectData[adjustedEffect]
            if (!data) {
                log("Unhandled effect " + adjustedEffect)
                continue
            }

            var value = ""
            let match = effect.match(/\((\w+)\)/)
            if (match && match.length >= 2) {
                value = match[1]
            }

            let valueDefinition = value ? `--v ${value}` : ""
            let duplicateDefinition = data.duplicate ? ` --dupe ${data.duplicate}` : ""
            let effectName = data.specialType || data.type.replace("(x)", "")
            let button = `[${data.name.replace("(X)", `(${value})`)}](!ffe --${effectName} ${valueDefinition} --expire ${data.expiry} ` + 
                `--edit ${0} --curable ${data.curable ? 1 : 0}${duplicateDefinition} --l ${level})`
            buttons.push(button)
        }
        return buttons.join("\n")
    }

    // Adds the given effects. Values should contain level, barrierPoints.
    function addEffectsToSelf(values, effects, existingEffects) {
        var attributes = {}
        var summaries = []

        let existingEffectTypes = existingEffects.effects.map(effect => {
            if (effect.type == "special") {
                return effect.specialType.replace(" ", "_").toLowerCase()
            }
            return effect.type
        })

        log("Adding effects to self: " + JSON.stringify(effects))
        for (let effect of effects) {
            var adjustedEffect = searchableEffectName(effect)
            if (adjustedEffect == "transpose") {
                if (existingEffects.astralFireId) {
                    adjustedEffect = "umbral_ice"
                } else if (existingEffects.umbralIceId) {
                    adjustedEffect = "astral_fire"
                } else {
                    log("Cannot use transpose when missing both astral fire/umbral ice")
                    continue
                }
            }

            let data = effectData[adjustedEffect]
            if (!data) {
                log("Unhandled effect " + adjustedEffect)
                continue
            }


            // Manage duplicate effects
            if (data.duplicate == "block" && existingEffectTypes.includes(adjustedEffect)) {
                log("Effect " + effect.trim() + " already exists, skipping")
                continue
            }

            if (data.duplicate == "replace") {
                for (let replacable of existingEffects.effects) {
                    if (replacable.type == data.type && replacable.specialType == data.specialType) {
                        summaries.push(`Removed existing ${data.name}`)
                        removeRepeatingRow(replacable.fullId)
                    }
                }
            }

            var value = null
            let match = effect.match(/\((\w+)\)/)
            if (match && match.length >= 2) {
                value = match[1]
            }
            let initValues = {
                id: generateRowID(),
                type: data.type,
                specialType: data.specialType,
                value: value,
                expiry: data.expiry,
                curable: data.curable
            }

            // Handle special conditions for certain effects
            switch (adjustedEffect) {
                case "astral_fire":
                    // Clear MP recovery
                    attributes.mpRecoveryBlock = "on"

                    // Remove Umbral Ice
                    if (existingEffects.umbralIceId) {
                        summaries.push("Removed Umbral Ice")
                        removeRepeatingRow(existingEffects.umbralIceId)
                    }
                    summaries.push(addEffectsToSelf(values, ["Thunderhead Ready"], existingEffects))
                    break
                case "barrier":
                    // Don't add to effect list, just update the barrier
                    setAttrs({
                        barrierPoints: Math.max(values.barrierPoints ?? 0, parseInt(value))
                    })
                    summaries.push(`Granted ${value} HP barrier`)
                    continue
                case "major_arcana":
                    // Add barrier
                    let barrier = values.level >= 40 ? 2 : 1
                    attributes.barrierPoints = Math.max(values.barrierPoints ?? 0, barrier)
                    break
                case "lucid_dreaming":
                    attributes.mpRecovery = 3
                    break
                case "umbral_ice":
                    if (existingEffects.astralFireId) {
                        summaries.push("Removed Astral Fire")
                        removeRepeatingRow(existingEffects.astralFireId)

                        // Reset MP recovery
                        attributes.mpRecoveryBlock = "off"
                    }
                    summaries.push(addEffectsToSelf(values, ["Thunderhead Ready"], existingEffects))
                    break
                default:
                    break
            }
            attributes[`repeating_effects_${initValues.id}_type`] = initValues.type
            if (initValues.specialType) {
                attributes[`repeating_effects_${initValues.id}_specialType`] = initValues.specialType
            }
            if (initValues.value) {
                attributes[`repeating_effects_${initValues.id}_value`] = initValues.value
            }
            attributes[`repeating_effects_${initValues.id}_expiry`] = initValues.expiry
            attributes[`repeating_effects_${initValues.id}_curable`] = initValues.curable ? "on" : "off"
            attributes[`repeating_effects_${initValues.id}_editable`] = "off"
            attributes[`repeating_effects_${initValues.id}_origin`] = "automatic"

            summaries.push(`Activated ${data.name.replace("(X)", initValues.value)}`)
        }
        if (Object.keys(attributes).length > 0) {
            setAttrs(attributes)
        }
        return summaries.join(", ")
    }

    function templateValues(title, value) {
        if (value) {
            return [title, value]
        }
        return ["", ""]
    }

    function spendResource(isGeneric, cost, resourceType, value, value_max, attributeName) {
        if (isGeneric) {
            return [true, `Spend ${cost} ${resourceType}`]
        }

        if (cost > 0 && resourceType && value >= 0 && value_max >= 0) {
            if (value < cost) {
                return [false, `${cost} ${resourceType} - Insufficient (${value}/${value_max})`]
            } else {
                const newValue = value - cost
                var attributes = {}
                attributes[attributeName] = newValue
                setAttrs(attributes)
                const resultString = `Spent ${cost} ${resourceType} (${newValue}/${value_max})`
                console.log(resultString)
                return [true, resultString]
            }
        } else {
            return [false, `${cost} ${resourceType} - Character has no ${resourceType}!`]
        }
    }

    function restoreResource(isGeneric, restoration, resourceType, resourceNames) {
        const values = restoration.split(",")
        var attributes = []
        var summary = isGeneric ? "Restore " : "Restored "
        var didRestore = false
        for (let i = 0; i < values.length; i++) {
            var parts = values[i].trim().split(" ")
            if (parts.length < 2) {
                console.log("Invalid restore declaration " + values[i])
                continue
            }
            if (parts.length > 2) {
                // Account for resources that have spaces in the name
                parts = [parts[0], parts.slice(1).join(" ")]
            }
            const typeForValue = parts[1].toLowerCase()
            if (typeForValue == "mp") {
                didRestore = true
                attributes.push({
                    name: "magicPoints",
                    value: parts[0]
                })
                summary += `${parts[0]} MP, `
            } else if (typeForValue == "hp") {
                didRestore = true
                attributes.push({
                    name: "hitpoints",
                    value: parts[0]
                })
                summary += `${parts[0]} HP, `
            } else if (resourceType && typeForValue == resourceNames[0].toLowerCase()) {
                didRestore = true
                attributes.push({
                    name: "resourceValue",
                    value: parts[0]
                })
                summary += `${parts[0]} ${resourceType}, `
            } else if(resourceType && typeForValue == resourceNames[1].toLowerCase()) {
                didRestore = true
                attributes.push({
                    name: "resource2Value",
                    value: parts[0]
                })
                summary += `${parts[0]} ${resourceType}, `
            }
        }

        if (!didRestore) {
            return ""
        }

        if (!isGeneric) {
            const attributeNames = attributes.flatMap((element) => [element.name, element.name + "_max"])
            getAttrs(attributeNames, values => {
                var newValues = {}
                for (let attribute of attributes) {
                    const value = values[attribute.name]
                    const max = values[attribute.name + "_max"]
                    const sum = +value + +attribute.value
                    const newValue = Math.min(sum, max)
                    newValues[attribute.name] = newValue
                    console.log("Restored " + attribute.name + " to " + newValue)
                }
                setAttrs(newValues)
            })
        }

        return summary.substring(0, summary.length - 2)
    }

    function performAbilityResourceChanges(section, rowId, values, effects) {
        const type = values[`repeating_${section}_${rowId}_type`]
        const cost = values[`repeating_${section}_${rowId}_cost`]
        const resourceType = values[`repeating_${section}_${rowId}_resource`]
        const uses = values[`repeating_${section}_${rowId}_uses`]
        const usesMax = values[`repeating_${section}_${rowId}_uses_max`]
        const restoration = values[`repeating_${section}_${rowId}_restore`]
        const isGeneric = values.sheet_type != "unique"
        const resourceNames = [values.resource, values.resource2]
        
        var resourceCost = ""
        var resourceResult = false
        if (cost > 0) {
            if (resourceType.toLowerCase() == "mp") {
                let result = spendResource(
                    isGeneric,
                    cost, 
                    resourceType, 
                    values.magicPoints, 
                    values.magicPoints_max, 
                    "magicPoints"
                )
                resourceResult = result[0]
                resourceCost = result[1]
            } else if (resourceType.toLowerCase() == resourceNames[0].toLowerCase())  {
                let result = spendResource(
                    isGeneric,
                    cost,
                    resourceType,
                    values.resourceValue,
                    values.resourceValue_max,
                    "resourceValue"
                )
                resourceResult = result[0]
                resourceCost = result[1]
            } else if (resourceType.toLowerCase() == resourceNames[1].toLowerCase()) {
                let result = spendResource(
                    isGeneric,
                    cost,
                    resourceType,
                    values.resource2Value,
                    values.resource2Value_max,
                    "resource2Value"
                )
                resourceResult = result[0]
                resourceCost = result[1]
            }
        }
        if (resourceResult || cost == 0) {
            // Spend uses if there are any
            if (usesMax > 0) {
                let result = spendResource(
                    isGeneric,
                    1,
                    "uses",
                    uses,
                    usesMax,
                    `repeating_${section}_${rowId}_uses`
                )
                if (result[1]) {
                    if (resourceCost) {
                        resourceCost += `\n${result[1]}`
                    } else {
                        resourceCost = result[1]
                    }
                }
            }
        }

        var summaries = [resourceCost]
            
        // Restore resources
        if (resourceResult || cost == 0) {
            if (restoration) {
                summaries.push(restoreResource(isGeneric, restoration, resourceType, resourceNames))
            }
            let isIceType = type.toLowerCase().includes("ice-aspect")
            if (isIceType && effects.umbralIceId) {
                summaries.push(`${restoreResource(isGeneric, "5 mp", resourceType, resourceNames)} (Umbral Ice)`)
            }
        }

        return summaries.filter(element => element).join("\n")
    }

    function stringWithTitle(title, value) {
        if (value) {
            return `${title} ${value}`
        }
        return ""
    }

    function applyAdvantageToDice(advantage, dice) {
        if (advantage == 0) {
            return dice
        }
        if (!dice.includes("d")) {
            return dice
        }
        const highOrLow = advantage > 0 ? "kh" : "kl"
        const multiplier = Math.abs(advantage) + 1

        var searchString = dice
        var newDice = ""
        var index
        while ((index = searchString.indexOf("d")) >= 0) {
            let numberOfDice
            if (index == 0) {
                numberOfDice = 1
                searchString = `1${searchString}`
                index = 1
            } else {
                newDice += searchString.substring(0, index - 1)
                numberOfDice = searchString.substring(index - 1, index)
            }
            const numberOfDiceWithMultiplier = numberOfDice * multiplier

            // Find end of roll
            let match = /[\-+* \/\)]/.exec(searchString.substring(index))
            if (match) {
                const matchIndex = match.index + index
                newDice += `${numberOfDiceWithMultiplier}${searchString.substring(index, matchIndex)}${highOrLow}${numberOfDice}`
                searchString = searchString.substring(matchIndex)
            } else {
                newDice += `${numberOfDiceWithMultiplier}${searchString.substring(index).trim()}${highOrLow}${numberOfDice}`
                searchString = ""
                break
            }
        }
        newDice += searchString
        return newDice
    }

    // Roll stat
    function rollStat(stat, statName) {
        getAttrsAndEffects([
            "d20"
        ], (values, effects) => {
            var roll = `${values.d20} + @{${stat}}`
            roll = addEffectsToRoll(effects, roll, "stat")

            console.log(`Rolling stat &{template:roll} {{title=${statName}}} {{roll=[[${roll}]]}}`)
            startRoll(`&{template:roll} {{title=${statName}}} {{roll=[[${roll}]]}}`, results => {
                const rollResult = results.results.roll.result
                finishRoll(results.rollId, {
                    roll: Math.max(rollResult, 0)
                })
            })
        })
    }

    // Share ability details to chat
    function shareAbility(eventInfo) {
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]
        getAttrs([
            `repeating_${section}_${rowId}_icon`,
            `repeating_${section}_${rowId}_title`,
            `repeating_${section}_${rowId}_type`,
            `repeating_${section}_${rowId}_cost`,
            `repeating_${section}_${rowId}_resource`,
            `repeating_${section}_${rowId}_condition`,
            `repeating_${section}_${rowId}_trigger`,

            `repeating_${section}_${rowId}_target`,
            `repeating_${section}_${rowId}_range`,
            `repeating_${section}_${rowId}_check`,
            `repeating_${section}_${rowId}_cr`,

            `repeating_${section}_${rowId}_baseEffect`,
            `repeating_${section}_${rowId}_directHit`,
            `repeating_${section}_${rowId}_effectName`,
            `repeating_${section}_${rowId}_effect`,
            `repeating_${section}_${rowId}_limitation`
        ], values => {
            const icon = values[`repeating_${section}_${rowId}_icon`]
            const title = values[`repeating_${section}_${rowId}_title`]
            const type = templateValues("Type:", values[`repeating_${section}_${rowId}_type`])
            const condition = templateValues("Condition:", values[`repeating_${section}_${rowId}_condition`])
            const trigger = templateValues("Trigger:", values[`repeating_${section}_${rowId}_trigger`])
            const target = templateValues("Target:", values[`repeating_${section}_${rowId}_target`])
            const range = templateValues("Range:", values[`repeating_${section}_${rowId}_range`])
            const check = templateValues("Check:", values[`repeating_${section}_${rowId}_check`])
            const cr = templateValues("CR:", values[`repeating_${section}_${rowId}_cr`])
            const baseEffect = templateValues("Base Effect:", values[`repeating_${section}_${rowId}_baseEffect`])
            const directHit = templateValues("Direct Hit:", values[`repeating_${section}_${rowId}_directHit`])
            const effectName = values[`repeating_${section}_${rowId}_effectName`]
            const effect = values[`repeating_${section}_${rowId}_effect`]
            const limitation = templateValues("Limitation:", values[`repeating_${section}_${rowId}_limitation`])

            var cost = templateValues("Cost:", values[`repeating_${section}_${rowId}_cost`])
            var resourceType = values[`repeating_${section}_${rowId}_resource`]
            if (cost[1] <= 0) {
                cost = ["", ""]
                resourceType = ""
            }

            startRoll(`&{template:ability} {{icon=[icon](${icon})}} {{name=${title}}} {{costTitle=${cost[0]}}} {{cost=${cost[1]}}} {{resourceType=${resourceType}}}` +
            `{{typeTitle=${type[0]}}} {{type=${type[1]}}} {{conditionTitle=${condition[0]}}} {{condition=${condition[1]}}}` +
            `{{triggerTitle=${trigger[0]}}} {{trigger=${trigger[1]}}} {{targetTitle=${target[0]}}} {{target=${target[1]}}}` +
            `{{rangeTitle=${range[0]}}} {{range=${range[1]}}} {{checkTitle=${check[0]}}} {{check=${check[1]}}}` +
            `{{crTitle=${cr[0]}}} {{cr=${cr[1]}}} {{baseEffectTitle=${baseEffect[0]}}} {{baseEffect=${baseEffect[1]}}}` +
            `{{directHitTitle=${directHit[0]}}} {{directHit=${directHit[1]}}} {{effectTitle=${effectName}}} {{effect=${effect}}}` +
            `{{limitationTitle=${limitation[0]}}} {{limitation=${limitation[1]}}}`, results => {
                finishRoll(results.rollId)
            })
        })
    }

    // Roll ability
    function activateAbility(eventInfo) {
        console.log("Activate ability " + JSON.stringify(eventInfo))
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]

        getAttrsAndEffects([
            `repeating_${section}_${rowId}_icon`,
            `repeating_${section}_${rowId}_title`,
            `repeating_${section}_${rowId}_type`,
            `repeating_${section}_${rowId}_cost`,
            `repeating_${section}_${rowId}_resource`,
            `repeating_${section}_${rowId}_condition`,
            `repeating_${section}_${rowId}_trigger`,
            `repeating_${section}_${rowId}_uses`,
            `repeating_${section}_${rowId}_uses_max`,

            `repeating_${section}_${rowId}_target`,
            `repeating_${section}_${rowId}_range`,

            `repeating_${section}_${rowId}_baseEffect`,
            `repeating_${section}_${rowId}_directHit`,

            `repeating_${section}_${rowId}_effectName`,
            `repeating_${section}_${rowId}_effect`,
            `repeating_${section}_${rowId}_effectSelf`,
            `repeating_${section}_${rowId}_effectTarget`,
            
            `repeating_${section}_${rowId}_stat`,
            `repeating_${section}_${rowId}_damageType`,
            `repeating_${section}_${rowId}_hitType`,
            `repeating_${section}_${rowId}_hitDie`,
            `repeating_${section}_${rowId}_baseValue`,
            `repeating_${section}_${rowId}_cr`,
            `repeating_${section}_${rowId}_restore`,
            `repeating_${section}_${rowId}_combo`,

            "str", "dex", "vit", "int", "mnd",
            "magicPoints", "magicPoints_max", "resourceValue", "resourceValue_max",
            "advantage", "character_name"
        ], (values, effects) => {
            // Perform roll
            const title = values[`repeating_${section}_${rowId}_title`]
            const icon = values[`repeating_${section}_${rowId}_icon`]
            const usesMax = values[`repeating_${section}_${rowId}_uses_max`]

            const cost = values[`repeating_${section}_${rowId}_cost`]
            const resourceType = values[`repeating_${section}_${rowId}_resource`]

            const statType = values[`repeating_${section}_${rowId}_stat`].toLowerCase()
            const damageType = values[`repeating_${section}_${rowId}_damageType`]
            const hitType = values[`repeating_${section}_${rowId}_hitType`]
            const restoration = values[`repeating_${section}_${rowId}_restore`]
            const statValue = values[statType]
            const baseEffect = values[`repeating_${section}_${rowId}_baseEffect`]
            const baseValue = values[`repeating_${section}_${rowId}_baseValue`]
            const directHit = values[`repeating_${section}_${rowId}_directHit`]
            const effectName = values[`repeating_${section}_${rowId}_effectName`]
            const effect = values[`repeating_${section}_${rowId}_effect`]
            const effectSelf = values[`repeating_${section}_${rowId}_effectSelf`]
            const effectTarget = values[`repeating_${section}_${rowId}_effectTarget`]

            const combo = values[`repeating_${section}_${rowId}_combo`]

            setAttrs({
                currentCombo: "" // Reset combo indicators
            })
            const crString = stringWithTitle("CR:", values[`repeating_${section}_${rowId}_cr`])
            const typeString = stringWithTitle("Type:", values[`repeating_${section}_${rowId}_type`])
            const conditionString = stringWithTitle("Condition:", values[`repeating_${section}_${rowId}_condition`])
            const triggerString = stringWithTitle("Trigger:", values[`repeating_${section}_${rowId}_trigger`])

            var hitDie = values[`repeating_${section}_${rowId}_hitDie`]
            hitDie = applyAdvantageToDice(values.advantage, hitDie)

            var hitTitle = ""
            var hitDefinition = ""
            var button = ""
            if (hitDie || baseValue) {
                var bonusButton = ""
                if (hitType != "None" && hitDie) {
                    hitTitle = `${hitType}: `
                    if (statValue > 0) {
                        hitDie = `${hitDie} + @{${statType}}`
                    }
                    hitDie = addEffectsToRoll(effects, hitDie, section)
                    hitDefinition = `[[${hitDie}]]`

                    // Option to improve the hit roll
                    if (effects.effects.some((effect) => effect.type == "roll(x)")) {
                        bonusButton = ` [${damageType} + Roll Up(X)](~${values.character_name}|repeating_${section}_${rowId}_rolldamagewithbonus)`
                    }
                }
                button = `[${damageType}](~${values.character_name}|repeating_${section}_${rowId}_rolldamage)${bonusButton}`
            } else if (cost > 0 || usesMax > 0 || restoration || combo || effectSelf || effectTarget) {
                button = `[Effect](~${values.character_name}|repeating_${section}_${rowId}_rolldamage)`
            }

            var directHitTitle = ""
            if (directHit) {
                directHitTitle = "Direct Hit:"
            }

            var attributes = {}
            attributes[`repeating_${section}_${rowId}_currentRoll`] = ""
            setAttrs(attributes)

            console.log(`&{template:hit} {{icon=[icon](${icon})}} {{name=${title}}} ` +
            `{{type=${typeString}}} {{condition=${conditionString}}} {{trigger=${triggerString}}} ` +
            `{{hitTitle=${hitTitle}}} {{hit=${hitDefinition}}} {{cr=${crString}}} {{baseEffect=${baseEffect}}} ` +
            `{{directHitTitle=${directHitTitle}}} {{directHit=${directHit}}} {{effectTitle=${effectName}}} {{effect=${effect}}}` +
            `{{button=${button}}}`)
            startRoll(`&{template:hit} {{icon=[icon](${icon})}} {{name=${title}}} ` +
            `{{type=${typeString}}} {{condition=${conditionString}}} {{trigger=${triggerString}}} ` +
            `{{hitTitle=${hitTitle}}} {{hit=${hitDefinition}}} {{cr=${crString}}} {{baseEffect=${baseEffect}}} ` +
            `{{directHitTitle=${directHitTitle}}} {{directHit=${directHit}}} {{effectTitle=${effectName}}} {{effect=${effect}}}` +
            `{{button=${button}}}`, results => {
                var hitRoll = results.results.hit
                if (!hitRoll) {
                    hitRoll = {
                        result: undefined,
                        dice: undefined,
                        expression: undefined
                    }
                }
                const hitValue = hitRoll.result
                var computedValue = hitValue
                if (hitRoll.dice) {
                    var die
                    if (hitRoll.expression.includes("kl")) {
                        die = Math.min(...hitRoll.dice)
                    }
                    else {
                        die = Math.max(...hitRoll.dice)
                    }
                    attributes[`repeating_${section}_${rowId}_currentRoll`] = die
                }
                if (hitValue && parseInt(computedValue) < 0) {
                    computedValue = 0
                }

                setAttrs(attributes)

                finishRoll(results.rollId, {
                    hit: computedValue
                })
            })
        })
    }

    function rollDamage(useRollBonus, eventInfo) {
        console.log("Roll damage " + JSON.stringify(eventInfo))
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]
        getAttrsAndEffects([
            `repeating_${section}_${rowId}_title`,
            `repeating_${section}_${rowId}_type`,
            `repeating_${section}_${rowId}_damageType`,
            `repeating_${section}_${rowId}_baseValue`,
            `repeating_${section}_${rowId}_dhValue`,
            `repeating_${section}_${rowId}_combo`,
            `repeating_${section}_${rowId}_currentRoll`,

            `repeating_${section}_${rowId}_cost`,
            `repeating_${section}_${rowId}_uses`,
            `repeating_${section}_${rowId}_uses_max`,
            `repeating_${section}_${rowId}_restore`,
            `repeating_${section}_${rowId}_resource`,

            `repeating_${section}_${rowId}_effectSelf`,
            `repeating_${section}_${rowId}_effectTarget`,
            `repeating_${section}_${rowId}_condition`,

            "level", "barrierPoints",
            "magicPoints", "magicPoints_max",
            "resource", "resourceValue", "resourceValue_max",
            "resource2", "resource2Value", "resource2Value_max",
            "character_name", "sheet_type"
        ], (values, effects) => {
            const name = values[`repeating_${section}_${rowId}_title`]
            const type = values[`repeating_${section}_${rowId}_type`]
            const baseValue = values[`repeating_${section}_${rowId}_baseValue`]
            const directHitValue = values[`repeating_${section}_${rowId}_dhValue`]
            const damageType = values[`repeating_${section}_${rowId}_damageType`]
            const combo = values[`repeating_${section}_${rowId}_combo`]
            const roll = parseInt(values[`repeating_${section}_${rowId}_currentRoll`])

            const selfEffects = values[`repeating_${section}_${rowId}_effectSelf`].split(",")
            const targetEffects = values[`repeating_${section}_${rowId}_effectTarget`].split(",")
            const condition = values[`repeating_${section}_${rowId}_condition`]

            var bonusValue = 0
            if (useRollBonus) {
                bonusValue = effects.reduce(
                    (accumulator, currentValue) => {
                        if (currentValue.type != "roll(x)") {
                            return accumulator
                        }
                        if (currentValue.value) {
                            return accumulator + parseInt(currentValue.value)
                        }
                        return accumulator
                    }, 0
                )
            }

            var criticalMultiplier = 1
            if (roll) {
                criticalMultiplier = roll + bonusValue >= effects.criticalThreshold ? 2 : 1
            }

            // Add crit multiplier to other dice rolls
            var baseValueWithMultipliers = baseValue
            if (baseValue.includes("d")) {
                baseValueWithMultipliers = "[[" + criticalMultiplier + "[crit multiplier] * " + baseValue[0] + "]]" + baseValue.substring(1)
            }
            var directHitValueWithMultipliers = directHitValue
            if (directHitValue.includes("d")) {
                directHitValueWithMultipliers = "[[" + criticalMultiplier + "[crit multiplier] * " + directHitValue[0] + "]]" + directHitValue.substring(1)
            }
            let rolls = addEffectsToPreDamageRolls(effects, values.level, type, baseValueWithMultipliers, directHitValueWithMultipliers)

            var damageTitle = ""
            var damageDice = ""
            if (rolls.damage) {
                damageTitle = `${damageType}: `
                damageDice = `[[${rolls.damage}]]`
            }
            var directHitTitle = ""
            var directHitDice = ""
            var totalTitle = ""
            if (rolls.directHit) {
                directHitTitle = "Direct Hit: "
                directHitDice = `[[${rolls.directHit}]]`
            }

            var totalTitle = ""
            if (rolls.damage && rolls.directHit) {
                totalTitle = `Full ${damageTitle}`
            }

            var button = ""
            var comboTitle = ""
            if (combo) {
                setAttrs({
                    currentCombo: combo
                })
                var choices = [combo]
                comboTitle = "Combo"
                if (combo.includes(",")) {
                    choices = combo.split(",")
                }
                for (let i = 0; i < choices.length; i++) {
                    button += `[${choices[i].trim()}](~${values.character_name}|repeating_${section}_${rowId}_runcombo${i + 1})`
                }
            }

            const resourceCost = performAbilityResourceChanges(section, rowId, values, effects)

            if (!damageDice && !directHitDice && !combo && !resourceCost && !selfEffects && !targetEffects) {
                console.log("No reason to roll damage")
                return
            }

            var targetEffectTitle = ""
            let targetEffectButtons = buttonsForTargetEffects(targetEffects, values.level)
            if (targetEffectButtons) {
                targetEffectTitle = "Effects"
            }

            // Roll damage
            console.log(`&{template:damage} {{damageTitle=${damageTitle}}} {{damage=${damageDice}}} ` + 
            `{{directHitTitle=${directHitTitle}}} {{directHit=${directHitDice}}} {{totalTitle=${totalTitle}}} ` +
            `{{comboTitle=${comboTitle}}} {{button=${button}}} {{cost=${resourceCost}}} {{proc=[[0]]}} ` + 
            `{{targetEffectTitle=${targetEffectTitle}}} {{targetEffects=${targetEffectButtons}}}`)
            startRoll(`&{template:damage} {{damageTitle=${damageTitle}}} {{damage=${damageDice}}} ` + 
            `{{directHitTitle=${directHitTitle}}} {{directHit=${directHitDice}}} {{totalTitle=${totalTitle}}} {{total=[[0]]}}` +
            `{{comboTitle=${comboTitle}}} {{button=${button}}} {{cost=${resourceCost}}} {{proc=[[0]]}} ` + 
            `{{targetEffectTitle=${targetEffectTitle}}} {{targetEffects=${targetEffectButtons}}}`, results => {
                const damageRoll = results.results.damage ?? { result: 0, dice: [], expression: "" }
                const directHitRoll = results.results.directHit ?? { result: 0, dice: [], expression: "" }

                let computedResults = addEffectsToPostDamageRolls(effects, [damageRoll, directHitRoll])
                let total = computedResults.total

                let consumedEffectSummary = consumeEffectsOnAbility(name, condition, effects)

                let effectSummary = addEffectsToSelf(values, selfEffects, effects)
                let procSummary = [computedResults.summary, consumedEffectSummary, effectSummary].filter(element => element).join(", ")

                var attributes = {}
                attributes[`repeating_${section}_${rowId}_currentCriticalMultiplier`] = 1
                setAttrs(attributes)
                
                finishRoll(
                    results.rollId,
                    {
                        proc: procSummary,
                        damage: computedResults.rolls[0],
                        directHit: computedResults.rolls[1],
                        total: totalTitle ? computedResults.total : ""
                    }
                )
            })
        })
    }

    function activateCombo(eventInfo, index) {
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]
        console.log("Combo activated " + JSON.stringify(eventInfo))
        getAttrs([
            `repeating_${section}_${rowId}_combo`,
        ], values => {
            const combo = values[`repeating_${section}_${rowId}_combo`]
            var abilityName = combo.trim().toLowerCase()
            if (combo.includes(",")) {
                const choices = combo.split(",")
                if (index < choices.length) {
                    abilityName = choices[index].trim().toLowerCase()
                } else {
                    console.log(`Combo index out of bonds: selected ${index}, not in ${combo}`)
                    return
                }
            }
            getSectionIDs(`repeating_${section}`, ids => {
                const attributes = ids.map((element) => `repeating_${section}_${element}_title`)
                getAttrs(attributes, values => {
                    for (let i = 0; i < ids.length; i++) {
                        const id = ids[i]
                        const attribute = attributes[i]
                        if (values[attribute].trim().toLowerCase() == abilityName) {
                            const triggerEvent = {
                                sourceAttribute: `repeating_${section}_${id}_runcomboFrom_${rowId}`
                            }
                            console.log("Activating " + abilityName)
                            activateAbility(triggerEvent)
                            return
                        }
                    }
                    console.log("Couldn't find ability with name " + abilityName)
                })
            })
        })
    }

    function resetAbilityUses(section) {
        getSectionIDs(`repeating_${section}`, ids => {
            let attributes = ids.flatMap(id => [`repeating_${section}_${id}_uses`, `repeating_${section}_${id}_uses_max`])
            getAttrs(attributes, values => {
                var updatedAttributes = {}
                for (let id of ids) {
                    if (parseInt(values[`repeating_${section}_${id}_uses_max`]) > 0) {
                        updatedAttributes[`repeating_${section}_${id}_uses`] = values[`repeating_${section}_${id}_uses_max`]
                    }
                }
                setAttrs(updatedAttributes)
            })
        })
    }

    function resetAllAbilityUses() {
        log("Resetting ability uses")
        for (let section of abilitySections) {
            resetAbilityUses(section)
        }
    }

    const resetAttributeList = [
        "hitPoints_max",
        "magicPoints_max",
        "resourceValue_max", "resourceReset"
    ]
    
    function resetAttributes(values) {
        log("Resetting HP/MP")
        setAttrs({
            hitPoints: values.hitPoints_max,
            magicPoints: values.magicPoints_max,
            // Some jobs start encounters/phases with full job resource
            resourceValue: values.resourceReset == "full" ? values.resourceValue_max : 0,
            // No jobs start with full secondary reset
            resource2Value: 0,
            barrierPoints: 0
        })
    }

    const resetPhaseAttributeList = [
        "resourceValue_max", "resourceReset"
    ]

    function resetPhaseAttributes(values) {
        if (values.resourceReset != "full") {
            return
        }
        log("Resetting job resource")
        setAttrs({
            resourceValue: values.resourceValue_max
        })
    }

    function clearAllAbilitiesAndEffects(completion) {
        log(`Clearing abilities and effects`)
        let sections = abilitySections.concat(["traits", "effects"])
        const ThreadLessPromise = class {
            constructor(count, completion) {
                this.count = count
                this.completions = 0
                this.completion = completion
            }
            
            complete() {
                this.completions += 1
                log(`Completed cleanup ${this.completions}/${this.count}`)
                if (this.completions >= this.count) {
                    this.completion()
                }
            }
        }
        let promise = new ThreadLessPromise(sections.length, completion)

        for (let section of sections) {
            getSectionIDs(`repeating_${section}`, ids => {
                let attributes = ids.map(id => `repeating_${section}_${id}_automatic`)
                getAttrs(attributes, values => {
                    for (let id of ids) {
                        if (section == "traits") {
                            // Only remove auto-added traits
                            if (values[`repeating_${section}_${id}_automatic`] === "1") {
                                removeRepeatingRow(`repeating_${section}_${id}`)
                            }
                        } else {
                            removeRepeatingRow(`repeating_${section}_${id}`)
                        }
                    }
                    promise.complete()
                })
            })
        }
    }

    function setUpSheet(sheet) {
        clearAllAbilitiesAndEffects(() => {
            log("Clear complete; initializing sheet")
            getAttrs(["override"], values => {
                var attributes = {
                    job: sheet.job,
                    jobIcon: sheet.jobIcon,
                    level: sheet.level ?? 30,
                    role: sheet.role
                }

                log("Preparing base attributes")
                for (let entry of Object.entries(sheet.attributes)) {
                    attributes[entry[0]] = entry[1]
                }
                attributes.mpRecovery = 2
                attributes.mpRecoveryBlock = "off"

                log("Preparing traits")
                for (let trait of sheet.traits) {
                    let id = generateRowID()
                    for (let entry of Object.entries(trait)) {
                        attributes[`repeating_traits_${id}_${entry[0]}`] = entry[1]
                        attributes[`repeating_traits_${id}_automatic`] = "1"
                    }
                }

                log("Preparing abilities")
                for (let section of Object.entries(sheet.abilities)) {
                    for (let ability of section[1]) {
                        let id = generateRowID()
                        for (let entry of Object.entries(ability)) {
                            attributes[`repeating_${section[0]}_${id}_${entry[0]}`] = entry[1]
                        }
                        attributes[`repeating_${section[0]}_${id}_repeatingOverride`] = values.override
                    }
                }
                setAttrs(attributes)
            })
        })
    }

    on("change:job", eventInfo => {
        getAttrs(["level", "job"], values => {
            let job = values.job.toLowerCase()
            let level = values.level ?? 30
            log(`Setting up ${job} sheet for level ${level}`)
            let levelSheets = sheets[`level${level}`]
            if (!levelSheets) {
                log(`No sheets found for level ${level}.`)
                return
            }

            let sheet = levelSheets[job]
            if (!sheet) {
                log(`No sheet found for ${job} at level ${level}.`)
                return
            }

            setUpSheet(sheet)
        })
    })

    // Rest

    on("clicked:rest", eventInfo => {
        log("Initiating rest")
        getAttrsAndEffects(resetAttributeList, (values, effects) => {
            log("Removing effects")
            for (let effect of effects.effects) {
                if (effect.expiry == "end" || effect.expiry == "permanent") {
                    continue
                }
                removeRepeatingRow(effect.fullId)
            }
            resetAttributes(values)
        })

        resetAllAbilityUses()
    })

    on("clicked:phase", eventInfo => {
        log("Initiating phase reset")
        getAttrsAndEffects(resetPhaseAttributeList, (values, effects) => {
            console.log("Removing effects")
            for (let effect of effects.effects) {
                if (effect.expiry != "phase") {
                    continue
                }
                removeRepeatingRow(effect.fullId)
            }

            resetPhaseAttributes(values)
        })

        resetAllAbilityUses()
    })

    on("clicked:end", eventInfo => {
        log("Initiating end of adventure reset")
        getAttrsAndEffects(resetAttributeList, (values, effects) => {
            console.log("Removing effects")
            for (let effect of effects.effects) {
                if (effect.expiry == "permanent") {
                    continue
                }
                removeRepeatingRow(effect.fullId)
            }
            resetAttributes(values)
        })

        resetAllAbilityUses()
    })

    // Stat rolls

    on("clicked:rollStr", eventInfo => {
        rollStat("str", "Strength")
    })

    on("clicked:rollDex", eventInfo => {
        rollStat("dex", "Dexterity")
    })

    on("clicked:rollVit", eventInfo => {
        rollStat("vit", "Vitality")
    })

    on("clicked:rollInt", eventInfo => {
        rollStat("int", "Intelligence")
    })

    on("clicked:rollMnd", eventInfo => {
        rollStat("mnd", "Mind")
    })

    // Ability rolls

    for (let section of abilitySections) {
        on(`clicked:repeating_${section}:share`, eventInfo => {
            shareAbility(eventInfo)
        })
        on(`clicked:repeating_${section}:trigger`, eventInfo => {
            activateAbility(eventInfo)
        })
        on(`clicked:repeating_${section}:rolldamage`, eventInfo => {
            rollDamage(false, eventInfo)
        })
        on(`clicked:repeating_${section}:rolldamagewithbonus`, eventInfo => {
            rollDamage(true, eventInfo)
        })
        for (let i = 0; i < 3; i++) {
            on(`clicked:repeating_${section}:runcombo${i + 1}`, eventInfo => {
                activateCombo(eventInfo, i)
            })
        }
    }

    // Effect updates
    function getIconForEffectType(type, specialType) {
        if (type == "none") {
            return ""
        }
        if (type == "special") {
            let imageName = specialType.toLowerCase().replace("'", "").replace(" ", "-")
            return `https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Effects/${imageName}.png`
        }

        let imageName = type.replace("(x)", "-x")
        return `https://raw.githubusercontent.com/p-dahlback/roll20-ffxiv-ttrpg/refs/heads/main/Images/Effects/${imageName}.png`
    }

    // Effect icon assignment
    on("change:repeating_effects:type change:repeating_effects:specialType", eventInfo => {
        log("Change effect!")
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]

        getAttrs([`repeating_effects_${rowId}_type`, `repeating_effects_${rowId}_specialType`], values => {
            let type = values[`repeating_effects_${rowId}_type`]
            let specialType = values[`repeating_effects_${rowId}_specialType`]
            let adjustedName = searchableEffectName(specialType || type)
            let data = effectData[adjustedName]

            const iconUrl = getIconForEffectType(type, specialType)

            var attributes = {}
            attributes[`repeating_effects_${rowId}_icon`] = iconUrl
            attributes[`repeating_effects_${rowId}_name`] = data.name || specialType || type
            setAttrs(attributes)
        })

        if (eventInfo.triggerName.toLowerCase().includes("_specialtype")) {
            let effectName = eventInfo.newValue.trim().toLowerCase()
            if (["astral fire", "umbral ice"].includes(effectName)) {
                log("Removing astral/umbral to ensure a single instance of " + effectName)
                // Remove Astral Fire and Umbral Ice excepting the current instance.
                // This ensures there's only one Astral Fire or Umbral Ice active at any point.
                removeEffects(["astral fire", "umbral ice"], rowId)
                if (effectName == "umbral ice") {
                    log("Resetting MP recovery in case of Astral Fire removal")
                    setAttrs({
                        mpRecoveryBlock: "off"
                    })
                } else {
                    log("Disabling MP recovery due to Astral Fire")
                    setAttrs({
                        mpRecoveryBlock: "on"
                    })
                }
            } else {
                // Remove duplicates of special effects
                removeEffects([effectName], rowId)
            }
        }
    })

    // Reset MP recovery on Astral Fire deletion
    on("remove:repeating_effects", eventInfo => {
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]
        
        let specialType = eventInfo.removedInfo[`repeating_effects_${rowId}_specialType`]
        if (!specialType) {
            return
        }
        switch (specialType.trim().toLowerCase) {
            case "astral fire":
                log("Astral Fire removed; resetting mp recovery")
                setAttrs({
                    mpRecoveryBlock: "off"
                })
                break
            case "lucid dreaming":
                log("Lucid Dreaming removed; resetting mp recovery")
                setAttrs({
                    mpRecovery: 2
                })
                break

        }
    })
</script>

<rolltemplate class="sheet-rolltemplate-roll">
    <div class="sheet-template-container">
        <div class="sheet-header">
            <h3 class="sheet-title">{{title}}</h3>
        </div>
        <div class="sheet-body">
            <span class="sheet-subtitle">Result:</span>
            <span class="sheet-roll">{{computed::roll}}</span>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-ability">
    <div class="sheet-ability-template">
        <div class="sheet-header sheet-list">
            <div class="sheet-header-title">
                <div class="sheet-ability-icon">
                    {{icon}}
                </div>
                <div class="sheet-title">
                    <span class="sheet-bold">{{name}}</span>
                </div>
            </div>
            <div class="sheet-header-subtitle sheet-list">
                <div>
                    <span class="sheet-mini-title sheet-floatLeft">Type:</span>
                    <span class="sheet-mini-input sheet-floatLeft sheet-italic">{{type}}</span>
                </div>
                <div>
                    <span class="sheet-mini-title sheet-floatLeft">{{costTitle}}</span>
                    <span class="sheet-mini-input sheet-floatLeft">{{cost}}</span>
                    <span class="sheet-mini-input sheet-floatLeft" style="margin-left: 4px;">{{resourceType}}</span>
                </div>
                <div>
                    <span class="sheet-mini-title sheet-floatLeft">{{conditionTitle}}</span>
                    <span class="sheet-mini-input sheet-floatLeft">{{condition}}</span>
                </div>
                <div>
                    <span class="sheet-mini-title sheet-floatLeft">{{triggerTitle}}</span>
                    <span class="sheet-mini-input sheet-floatLeft">{{trigger}}</span>
                </div>
                <div>
                    <span class="sheet-mini-title sheet-floatLeft">{{targetTitle}}</span>
                    <span class="sheet-mini-input sheet-floatLeft">{{target}}</span>
                </div>
                <div>
                    <span class="sheet-mini-title sheet-floatLeft">{{rangeTitle}}</span>
                    <span class="sheet-mini-input sheet-floatLeft">{{range}}</span>
                </div>
                <div>
                    <span class="sheet-mini-title sheet-floatLeft">{{checkTitle}}</span>
                    <span class="sheet-mini-input sheet-floatLeft sheet-bold">{{check}}</span>
                </div>
                <div>
                    <span class="sheet-mini-title sheet-floatLeft">{{crTitle}}</span>
                    <span class="sheet-mini-input sheet-floatLeft">{{cr}}</span>
                </div>
            </div>
        </div>
        <div class="sheet-body">
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{baseEffectTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{baseEffect}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{directHitTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{directHit}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{effectTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{effect}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{limitationTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{limitation}}</span>
            </div>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-hit">
    <div class="sheet-ability-template">
        <div class="sheet-header">
            <div class="sheet-header-title">
                <div class="sheet-ability-icon">
                    {{icon}}
                </div>
                <div class="sheet-title">
                    <span class="sheet-bold">{{name}}</span>
                </div>
            </div>
            <div class="sheet-header-subtitle">
                <h4>{{cost}}</h4>
                <h4>{{type}}</h4>
            </div>
        </div>
        <div class="sheet-body sheet-list">
            <div>
                <span class="sheet-mini-title">Base Effect:</span>
                <span class="sheet-mini-input">{{baseEffect}}</span>
            </div>
            <div>
                <span class="sheet-mini-title">{{directHitTitle}}</span>
                <span class="sheet-mini-input">{{directHit}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{effectTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{effect}}</span>
            </div>
            <h4>{{hitTitle}}{{computed::hit}}</h4>
            <h4>{{cr}}</h4>
            <div>{{button}}</div>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-damage">
    <div class="sheet-template-container">
        <div class="sheet-header">
            <div class="sheet-list">
                <span class="sheet-mini-input">{{cost}}</span>
                <span class="sheet-mini-input sheet-hideinline">{{computed::proc}}</span>
            </div>
            <h4>{{damageTitle}}{{computed::damage}}</h4>
            <h4>{{directHitTitle}}{{computed::directHit}}</h4>
        </div>
        <div class="sheet-body">
            <h4 class="sheet-hideinline">{{totalTitle}}{{computed::total}}</h4>
            <div class="sheet-effects sheet-button-container">
                <h4>{{targetEffectTitle}}</h4>
                {{targetEffects}}
            </div>
            <div class="sheet-combo sheet-button-container">
                <h4>{{comboTitle}}</h4>
                {{button}}
            </div>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-item">
    <div class="sheet-template-container">
        <div class="sheet-header">
            <h3 class="sheet-type">{{type}}</h3>
            <h3 class="sheet-title">{{title}}</h3>
        </div>
        <div class="sheet-body">
            <span class="sheet-subtitle">Effect:</span>
            <span class="sheet-paragraph">{{effect}}</span>
        </div>
    </div>
</rolltemplate>