<link rel="stylesheet" href="sheet.css" />

<!-- Character name and race -->

<div class="sticky section">
    <div class="top section">
        <div class="type">
            <img src="Images/WAR_Symbol_Token.png" width="50" />
        </div>

        <div class="name content vertical">
            <label class="small">Name</label>
            <input class="medium" name="attr_character_name" type="text" value="Kokopoko">
        </div>
        
        <div class="race content vertical">
            <label class="small">Race</label>
            <input class="medium" name="attr_character_race" type="text" value="Lalafell">
        </div>
    </div>

    <!-- Shortcut for HP/MP -->

    <div class="stat-shortcut section">
        <!-- HP -->

        <div class="points section">
            <div class="stat-header"></div>
            <div class="hit-point section">
                <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                <span class="text large" style="width: 1em">HP</span>
                <input class="stat" name="attr_hitPoints" type="number" min="0" value="30">
                <span>/</span>
                <input class="stat max" name="attr_hitPoints_max" type="number" min="0" value="30">
                <span class="text large">Barrier</span>
                <input class="stat" name="attr_barrierPoints" type="number" min="0" value="10">
            </div>
        </div>
        
        <!-- MP, Resource -->

        <div class="points section">
            <div class="mini stat-header">
                <span>Recover</span>
                <span name="attr_mpRecovery"></span>
                <span>MP at the end of the (Adventurer Step)</span>
            </div>
            <div class="resource-point">
                <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                <input type="hidden" class="resourceSwitch" name="attr_resource" placeholder="placeholder" />
                <span class="text large" style="width: 1em">MP</span>
                <input class="stat" name="attr_magicPoints" type="number" min="0" value="5">
                <span>/</span>
                <input class="stat max" name="attr_magicPoints_max" type="number" min="0" value="5">

                <span class="text large resource" name="attr_resource"></span>
                <input class="stat resource" name="attr_resourceValue" type="number" min="0">
                <span class="resource">/</span>
                <input class="stat max resource" name="attr_resourceValue_max" type="number" min="0">
            </div>
        </div>

        <!-- Advantage -->

        <div class="points advantage" style="width: 25%;">
            <label class="large stat-header">Advantage</label>
            <div class="horizontal">
                <button class="math-button" type="action" name="act_decreaseAdvantage">-</button>
                <span class="large" name="attr_advantage"></span>
                <button class="math-button" type="action" name="act_increaseAdvantage">+</button>
            </div>
            <button type="action" name="act_clearAdvantage">Clear</button>
        </div>
    </div>

    <!-- Tab buttons -->

    <input type="hidden" class="tabstoggle" name="attr_sheetTab" value="character" />
    <div class="tab">
        <button type="action" name="act_character" class="sheet-button0">Character</button>
        <button type="action" name="act_abilities" class="sheet-button2">Abilities</button>
        <button type="action" name="act_items" class="sheet-button1">Inventory</button>
        <button type="action" name="act_override" class="sheet-button3 floatRight">...</button>
    </div>
</div>

<input type="hidden" class="tabstoggle" name="attr_sheetTab" value="character" />

<!-- Profile page -->
<div class="character fancy">
    <div class="grid">

        <!-- Profile page, Level and Profile -->

        <div class="left section">
            <div class="basic-info horizontal">
                <div class="level flex horizontal tight">
                    <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                    <label class="large">LV</label>
                    <input name="attr_level" type="number" value="30">
                </div>
                <div class="job vertical">
                    <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                    <label class="small">Role / Job</label>
                    <input class="job-input medium" name="attr_job" type="text" value="TANK / WARRIOR">
                </div>
            </div>
        
            <div class="image section">
                <img name="attr_character_avatar">
            </div>

            <!-- Profile -->

            <div class="profile section list">
                <h3 class="small">Profile</h3>

                <!-- Title  -->

                <div class="title horizontal">
                    <span class="medium bold">Title:</span>
                    <span class="medium" name="attr_selectedTitle">Select a title from Inventory</span>
                </div>
                <div class="title-effect list">
                    <span class="medium bold">Effect: </span>
                    <span class="medium" name="attr_selectedTitleEffect"></span>
                </div> 
                
                <hr />

                <!-- Minion -->
                 
                <div class="minion horizontal">
                    <span class="medium bold">Minion:</span> 
                    <span class="medium" name="attr_selectedMinion">Select a minion from Inventory</span>
                </div>
                <div class="minion-effect list">
                    <span class="medium bold">Effect: </span>
                    <span class="medium" name="attr_selectedMinionEffect"></span>
                </div>

                <hr />

                <!-- Traits -->

                <h3>Traits</h3>
                <fieldset class="repeating_traits">
                    <div class="trait list">
                        <div class="horizontal">
                            <span class="medium bold">Trait:</span>
                            <input class="medium" type="text" name="attr_title" placeholder="Title"></span>
                        </div>
                        <span class="medium bold">Effect:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <span class="mini-input adaptive--text__span"  name="attr_effect"></span>
                            <textarea class="mini-input adaptive--text__textarea" name="attr_effect" placeholder="The trait's effects"></textarea>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>
        
        <!-- Profile page, Attributes -->

        <div class="right section">
            <div class="stat section horizontal">

                <!-- Primary -->

                <div class="main-stat list">
                    <h3 class="medium">Primary Attributes</h3>
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <button class="medium roll" name="act_rollStr" type="action">STR</button>
                        <input class="stat" name="attr_str" type="number" value="5">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <button class="medium roll" name="act_rollDex" type="action">DEX</button>
                        <input class="stat" name="attr_dex" type="number" value="4">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <button class="medium roll" name="act_rollVit" type="action">VIT</button>
                        <input class="stat" name="attr_vit" type="number" value="3">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <button class="medium roll" name="act_rollInt" type="action">INT</button>
                        <input class="stat" name="attr_int" type="number" value="2">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <button class="medium roll" name="act_rollMnd" type="action">MND</button>
                        <input class="stat" name="attr_mnd" type="number" value="1">
                    </div>
                </div>
                
                <!-- Secondary -->

                <div class="sub-stat list">
                    <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />

                    <h3 class="medium standard">Secondary Attributes</h3>
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <label class="medium oneline">Defense</label>
                        <input class="stat" name="attr_defense" type="number" value="15">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <label class="medium oneline">Magic Defense</label>
                        <input class="stat" name="attr_magicDefense" type="number" value="12">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <label class="medium oneline">Vigilance</label>
                        <input class="stat" name="attr_vigilance" type="number" value="11">
                    </div>
                    
                    <div class="stat-block">
                        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
                        <label class="medium oneline">Speed</label>
                        <input class="stat" name="attr_speed" type="number" value="5">
                    </div>
                </div>
            </div> 

            <!-- Fortune -->

            <div class="fortune section">
                <div class="flex horizontal tight right-aligned">
                <label class="text large">Fortune</label>
                    <input class="stat" name="attr_fortune" type="number" min="0" value="3">
                </div>
            </div>

            <!-- Effects -->

            <div class="effects section">
                <h3 class="small">Effects</h3> 
                <fieldset class="repeating_effects">
                    <div class="horizontal semi-tight">
                        <img class="effect-icon" name="attr_icon" />
                        <select class="effect-type" name="attr_type">
                            <option value="none">--Select--</option>
                            <option value="battle(x)">Roll Up(X)</option>
                            <option value="critical(x)">Critical Up(X)</option>
                            <option value="attribute(x)">Attribute Up(X)</option>
                            <option value="regen(x)">Regen(X)</option>
                            <option value="ready(x)">X Ready</option>
                            <option value="advantage">Advantage</option>
                            <option value="unstunnable">Stun Immunity</option>
                            <hr />
                            <option value="blind">Blind</option>
                            <option value="bound">Bound</option>
                            <option value="enmity(x)">Enmity to X</option>
                            <option value="dot(x)">DOT(X)</option>
                            <option value="heavy">Heavy</option>
                            <option value="paralyzed">Paralyzed</option>
                            <option value="petrified">Petrified</option>
                            <option value="prone">Prone</option>
                            <option value="silence">Silence</option>
                            <option value="sleep">Sleep</option>
                            <option value="slow">Slow</option>
                            <option value="stun">Stun</option>
                            <hr />
                            <option value="weak">Weak</option>
                            <option value="brink">Brink of Death</option>
                            <option value="comatose">Comatose</option>
                        </select>
                        <input class="effect-value" type="text" name="attr_value" placeholder="X" />
                        <select class="effect-type" name="attr_expiry">
                            <option value="turn">End of turn</option>
                            <option value="phase">End of phase</option>
                            <option value="encounter">End of encounter</option>
                            <option value="rest">After rest</option>
                            <hr />
                            <option value="use">On use</option>
                            <option value="damage">On damage</option>
                        </select>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
</div>

<!-- Items page -->

<div class="items fancy">
    <div class="section grid">
        <div class="section list">

            <!-- Title List -->

            <h3 class="small">Titles</h3> 
            <fieldset class="repeating_titles">
                <div class="expandable-section grid">
                    <input class="mini" name="attr_title" type="text" placeholder="Enter the title name" />
                    <input class="expand-checkbox" type="checkbox" name="attr_expandItem" value="1" />
                    <div class="expanded-view span2">
                        <div class="title-effect list">
                            <label class="mini">Effect:</label>
                            <textarea class="mini" name="attr_effect" placeholder="The effect provided by your title"></textarea>
                            <button type="action" class="select" name="act_select">Set as current Title</button>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- Minion List -->

            <h3 class="small">Minions</h3>
            <fieldset class="repeating_minions">
                <div class="expandable-section grid">
                    <input class="mini" name="attr_title" type="text" placeholder="Enter the title name" />
                    <input class="expand-checkbox" type="checkbox" name="attr_expandItem" value="1" />
                    <div class="expanded-view span2">
                        <div class="title-effect list">
                            <label class="mini">Effect:</label>
                            <textarea class="mini" name="attr_effect" placeholder="The effect provided by your title"></textarea>
                            <button type="action" class="select" name="act_select">Set as current Title</button>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>

        <!-- Item List -->

        <div class="section list vertical-span2">
            <h3 class="small">Items</h3>
            <fieldset class="repeating_items">
                <div class="expandable-section grid">
                    <div class="item-input">
                        <input class="mini" name="attr_title" type="text" placeholder="Enter the title name" />
                        <input class="mini" name="attr_count" type="number" value="1" />
                    </div>
                    <input class="expand-checkbox" type="checkbox" name="attr_expandItem" value="1" />
                    <div class="expanded-view span2">
                        <div class="title-effect list">
                            <label class="mini">Effect:</label>
                            <textarea class="mini" name="attr_effect" placeholder="The effect provided by your title"></textarea>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>
    </div>
</div>

<!-- Abilities page -->

<div class="char-abilities fancy">
    <div class="top">

        <!-- Limit Break -->
        <div class="limit">
            <fieldset class="repeating_limit">

            </fieldset>
        </div>
    </div>

    <!-- Top abilities (Bard songs) -->
    <input class="job-type" type="hidden" name="attr_job">

    <div class="top-abilities">
        <h3>Song Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_song">

        </fieldset>
    </div>

    <!-- Primary abilities -->

    <div class="primary-abilities">
        <h3>Primary Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_primary">
            <div class="ability">
                <div class="header list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_expandItem" />

                    <span class="mini flagTitle expanded-view floatLeft">Title flag:</span>
                    <input type="text" class="titleFlag overrideContent expanded-view mini-input floatLeft" name="attr_hasTitle" title="Type flag" placeholder="'e' for editable" />
                    <span class="mini flagTitle expanded-view floatLeft">Type flag:</span>
                    <input type="text" class="typeFlag overrideContent expanded-view mini-input floatLeft" name="attr_hasType" title="Type flag" placeholder="'e' for editable" />
                    <span class="mini flagTitle expanded-view floatLeft">Cost flag:</span>
                    <input type="text" class="costFlag overrideContent expanded-view mini-input floatLeft" name="attr_hasCost" title="Cost flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle expanded-view floatLeft">Condition flag:</span>
                    <input type="text" class="conditionFlag overrideContent expanded-view mini-input" name="attr_hasCondition" title="Condition flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle expanded-view floatLeft">Trigger flag:</span>
                    <input type="text" class="triggerFlag overrideContent expanded-view mini-input" name="attr_hasTrigger" title="Trigger flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle expanded-view floatLeft">Target flag:</span>
                    <input type="text" class="targetFlag overrideContent expanded-view mini-input" name="attr_hasTarget" title="Target flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle expanded-view floatLeft">Check flag:</span>
                    <input type="text" class="checkFlag overrideContent expanded-view mini-input" name="attr_hasCheck" title="Check flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle expanded-view floatLeft">Uses flag:</span>
                    <input type="text" class="usesFlag overrideContent expanded-view mini-input" name="attr_hasUses" title="Uses flag" placeholder="'1' to display, 'e' for editable" />
                    <span class="mini flagTitle expanded-view floatLeft">Icon source:</span>
                    <input type="text" class="iconSource overrideContent expanded-view mini-input" name="attr_icon" title="Icon" placeholder="icon source" />

                    <div class="uses">
                        <input type="hidden" class="usesFlag" name="attr_hasUses" />
                        <input class="max mini-input floatRight" type="number" name="attr_uses_max" min="0" value="1" />
                        <span class="floatRight">/</span>
                        <input class="mini-input floatRight" type="number" name="attr_uses" min="0" value="1" />
                    </div>

                    <div class="header-title">
                        <img class="ability-icon" name="attr_icon" />
                        <div class="title adaptive adaptive--text">
                            <input type="hidden" class="titleFlag" name="attr_hasTitle" />
                            <span class="bold adaptive--text__span"  name="attr_title"></span>
                            <textarea class="adaptive--text__textarea" type="text" name="attr_title" placeholder="Paladin Combo (Fast Blade + Riot Blade)"></textarea>
                        </div>
                    </div>

                    <div class="ability-controls">
                        <button type="action" class="ability-action-trigger" name="act_trigger">t</button>
                        <button type="action" class="ability-action" name="act_info">i</button>
                        <button type="action" class="ability-action" name="act_share">q</button>
                        <button type="action" name="act_rolldamage" style="display: none;">d</button>
                        <button type="action" name="act_rollbattlelitany" style="display: none;">d</button>
                        <button type="action" name="act_runcombo2" style="display: none;">d</button>
                        <button type="action" name="act_runcombo1" style="display: none;">d</button>
                        <button type="action" name="act_runcombo2" style="display: none;">d</button>
                    </div>

                    <div class="type expanded-view">
                        <span class="mini-title floatLeft">Type:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="typeFlag" name="attr_hasType" />
                            <span class="mini-input italic adaptive--input__span"  name="attr_type"></span>
                            <input class="mini-input italic adaptive--input__input" type="text" name="attr_type" placeholder="Primary, Physical" />
                        </div>
                    </div>
                    <div class="cost expanded-view">
                        <span class="mini-title floatLeft">Cost:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="costFlag" name="attr_hasCost" />
                            <span class="mini-input adaptive--input__span"  name="attr_cost"></span>
                            <input class="mini-input adaptive--input__input" type="number" name="attr_cost" placeholder="2" />
                        </div>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="costFlag" name="attr_hasCost" />
                            <span class="mini-input adaptive--input__span"  name="attr_resource"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_resource" placeholder="Conviction" />
                        </div>
                    </div>
                    <div class="condition expanded-view">
                        <span class="mini-title floatLeft">Condition:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="conditionFlag" name="attr_hasCondition" />
                            <span class="mini-input adaptive--text__span"  name="attr_condition"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_condition" placeholder="Under the effect of Fang and Claw Bared / Wheel in Motion Ready"></textarea>
                        </div>
                    </div>
                    <div class="trigger expanded-view">
                        <span class="mini-title floatLeft">Trigger:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="triggerFlag" name="attr_hasTrigger" />
                            <span class="mini-input adaptive--text__span"  name="attr_trigger"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_trigger" placeholder="Immediately after an ability check for an ability that targets you"></textarea>
                        </div>
                    </div>
                    <div class="target expanded-view">
                        <span class="mini-title floatLeft">Target:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="targetFlag" name="attr_hasTarget" />
                            <span class="mini-input adaptive--text__span"  name="attr_target"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_target" placeholder="Single"></textarea>
                        </div>
                    </div>
                    <div class="range expanded-view">
                        <span class="mini-title floatLeft">Range:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="targetFlag" name="attr_hasTarget" />
                            <span class="mini-input adaptive--text__span"  name="attr_range"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_range" placeholder="1 square"></textarea>
                        </div>
                    </div>
                    <div class="check expanded-view">
                        <span class="mini-title floatLeft">Check:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="checkFlag" name="attr_hasCheck" />
                            <span class="mini-input bold adaptive--input__span"  name="attr_check"></span>
                            <input class="mini-input bold adaptive--input__input" type="text" name="attr_check" placeholder="d20 + STR" />
                        </div>
                    </div>
                    <div class="cr expanded-view">
                        <span class="mini-title floatLeft">CR:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="checkFlag" name="attr_hasCheck" />
                            <span class="mini-input adaptive--input__span"  name="attr_cr"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_cr" placeholder="Target's Defense" />
                        </div>
                    </div>
                </div>

                <div class="body list">
                    <input type="hidden" class="overrideSwitch" name="attr_repeatingOverride" />
                    <input class="expand-checkbox hidden" type="checkbox" name="attr_expandItem" />

                    <span class="mini flagTitle expanded-view floatLeft">Base effect flag:</span>
                    <input type="text" class="baseEffectFlag overrideContent expanded-view mini-input" name="attr_hasBaseEffect" title="Base effect flag" placeholder="'e' for editable"/>
                    <span class="mini flagTitle expanded-view floatLeft">Direct hit flag:</span>
                    <input type="text" class="directHitFlag overrideContent expanded-view mini-input" name="attr_hasDirectHit" title="Direct hit flag" placeholder="'1' to display, 'e' for editable"/>
                    <span class="mini flagTitle expanded-view floatLeft">Limitation flag:</span>
                    <input type="text" class="limitationFlag overrideContent expanded-view mini-input" name="attr_hasLimitation" title="Limitation flag" placeholder="'1' to display, 'e' for editable" />

                    <div class="base-effect expanded-view">
                        <span class="mini-title floatLeft">Base Effect:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="baseEffectFlag" name="attr_hasBaseEffect" />
                            <span class="mini-input adaptive--text__span"  name="attr_baseEffect"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_baseEffect" placeholder="Deals 3 damage and inflicts Enmity on the target. Combo: Rage of Halone."></textarea>
                        </div>
                    </div>
                    <div class="direct-hit expanded-view">
                        <span class="mini-title floatLeft">Direct Hit:</span>
                        <div class="adaptive adaptive--text floatLeft">
                            <input type="hidden" class="directHitFlag" name="attr_hasDirectHit" />
                            <span class="mini-input adaptive--text__span"  name="attr_directHit"></span>
                            <textarea class="mini-input adaptive--text__textarea" type="text" name="attr_directHit" placeholder="Deals an additional 2d6 damage"></textarea>
                        </div>
                    </div>
                    <div class="limitation expanded-view">
                        <span class="mini-title floatLeft">Limitation:</span>
                        <div class="adaptive adaptive--input floatLeft">
                            <input type="hidden" class="limitationFlag" name="attr_hasLimitation" />
                            <span class="mini-input adaptive--input__span"  name="attr_limitation"></span>
                            <input class="mini-input adaptive--input__input" type="text" name="attr_limitation" value="Once per phase." placeholder="Once per phase." />
                        </div>
                    </div>

                    <span class="mini flagTitle expanded-view floatLeft">Stat for rolls (used for calculations):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_stat" title="Stat for rolls" placeholder="STR, DEX, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Hit dice type (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_hitType">
                        <option value="Hit">Hit</option>
                        <option value="Critical">Critical</option>
                        <option value="None">None</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Damage/Healing (used for display on rolls):</span>
                    <select class="overrideContent expanded-view mini-input" name="attr_damageType">
                        <option value="Damage">Damage</option>
                        <option value="Healing">Healing</option>
                        <option value="Defense">Defense</option>
                    </select>
                    <span class="mini flagTitle expanded-view floatLeft">Hit die (used for rolls):</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_hitDie" title="Hit" placeholder="1d20cs20, 1d8, etc"/>
                    <span class="mini flagTitle expanded-view floatLeft">Base effect dice/value (used to calculate damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_baseValue" title="Base effect value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Direct Hit dice/value (used to calculate extra damage)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_dhValue" title="Direct Hit value" placeholder="5, 1d20 + 2, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Restoration value (used to restore own HP/MP/resource, include space)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_restore" title="Restore value" placeholder="5 MP, 5 HP, 5 Conviction, etc" />
                    <span class="mini flagTitle expanded-view floatLeft">Combo name (used for easy chaining to next ability)</span>
                    <input type="text" class="overrideContent expanded-view mini-input" name="attr_combo" title="Combo value" placeholder="Storm's Path|Storm's Eye" />
                </div>
            </div>
        </fieldset>
    </div>

    <!-- Sub-abilities (Ninja jutsu) -->

    <div class="sub-abilities">
        <h3>Ninjutsu Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_ninjutsu">

        </fieldset>
    </div>

    <!-- Secondary abilities -->

    <div class="secondary-abilities">
        <h3>Secondary Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_secondary">

        </fieldset>
    </div>

    <!-- Instant abilities -->

    <div class="instant-abilities">
        <h3>Instant Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_instant">

        </fieldset>
    </div>

    <!-- Conditional abilities (Monk techniques) -->

    <div class="conditional-abilities">
        <h3>Technique Abilities</h3>
        <input type="hidden" class="overrideSwitch" name="attr_override" placeholder="placeholder" />
        <fieldset class="repeating_technique">

        </fieldset>
    </div>
</div>

<div class="override fancy">
    <h3>Manual Override</h3>
    <p>Enables manual input for things the player would normally not mess with, primarily intended for setting up NPC sheets.</p>
    <p>Mess with at your own risk!</p>
    <input type="text" name="attr_override" placeholder="Enter 'auto' to disable manual editing" />
</div>

<!-- ---------------------------SHEET WORKERS----------------- -->

<script type="text/worker">
    // Tabs
    const buttonlist = ["character", "items", "abilities", "override"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, () => {
            setAttrs({
                sheetTab: button
            });
        });
    });

    // Initial setup
    on("sheet:opened", () => {
        getAttrs(["d20"], values => {
            if (values.d20) {
                return
            }
            setAttrs({
                d20: "1d20"
            })
        })
    })
</script>

<script type="text/worker">
    // Title selection
    on("clicked:repeating_titles:select", eventInfo => {
        const rowid = eventInfo.sourceAttribute.split("_")[2]
        getAttrs([
            `repeating_titles_${rowid}_title`, 
            `repeating_titles_${rowid}_effect`
        ], values => {
            // Assign selected title
            setAttrs({
                selectedTitleId: rowid,
                selectedTitle: values[`repeating_titles_${rowid}_title`],
                selectedTitleEffect: values[`repeating_titles_${rowid}_effect`]
            })
        })
    })

    // Minion selection
    on("clicked:repeating_minions:select", eventInfo => {
        const rowid = eventInfo.sourceAttribute.split("_")[2]
        getAttrs([
            `repeating_minions_${rowid}_title`, 
            `repeating_minions_${rowid}_effect`
        ], values => {
            // Assign selected minion
            setAttrs({
                selectedMinionId: rowid,
                selectedMinion: values[`repeating_minions_${rowid}_title`],
                selectedMinionEffect: values[`repeating_minions_${rowid}_effect`]
            })
        })
    })
</script>

<script type="text/worker">
    // Advantage management
    function addAdvantage(change) {
        getAttrs(["advantage"], values => {
            const advantage = Math.min(Math.max(values.advantage + change, -3), 3)
            let numberOfAdvantageDice = Math.abs(advantage)
            let numberOfDice = 1 + numberOfAdvantageDice
            let keepMarker
            if (advantage == 0) {
                keepMarker = ""
            } else if (advantage > 0) {
                keepMarker = "kh1"
            } else {
                keepMarker = "kl1"
            }
            setAttrs({
                advantage: advantage,
                d20: numberOfDice + "d20" + keepMarker
            })
        })
    }

    on("clicked:increaseAdvantage", eventInfo => {
        addAdvantage(1)
    })

    on("clicked:decreaseAdvantage", eventInfo => {
        addAdvantage(-1)
    })

    on("clicked:clearAdvantage", eventInfo => {
        setAttrs({
            advantage: 0,
            d20: "1d20"
        })
    })

    // HP Max
    on("change:hitPoints", () => {
        getAttrs(["hitPoints", "hitPoints_max"], values => {
            if (values.hitPoints > values.hitPoints_max) {
                setAttrs({
                    hitPoints: values.hitPoints_max
                })
            }
        })
    })

    // MP Max
    on("change:magicPoints", () => {
        getAttrs(["magicPoints", "magicPoints_max"], values => {
            if (values.magicPoints > values.magicPoints_max) {
                console.log("Reset MP")
                setAttrs({
                    magicPoints: values.magicPoints_max
                })
            }
        })
    })

    // Resource Max
    on("change:resourceValue", () => {
        getAttrs(["resourceValue", "resourceValue_max"], values => {
            if (values.resourceValue > values.resourceValue_max) {
                console.log("Reset resource")
                setAttrs({
                    resourceValue: values.resourceValue_max
                })
            }
        })
    })

</script>

<script type="text/worker">
    // Assign override state
    on('change:override', () => {
        getAttrs(['override'], values => {
        console.log("Changed override to " + values.override)
            getSectionIDs('repeating_primary', ids => {
                const output = {}
                ids.forEach(id => output[`repeating_primary_${id}_repeatingOverride`] = values.override)
                setAttrs(output)
            })
        })
    })
</script>

<script type="text/worker">
    // Ability info
    function toggleExpandedStateInSection(eventInfo) {
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]
        getAttrs([`repeating_${section}_${rowId}_expandItem`], values => {
            // Toggle
            const value = values[`repeating_${section}_${rowId}_expandItem`]
            var attributes = {}
            var newValue = "on"
            if (value == "on" || value == "1") { 
                newValue = "off"
            } else if (value == "off" || value == "0") {
                newValue = "on"
            }
            attributes[`repeating_${section}_${rowId}_expandItem`] = newValue
            setAttrs(attributes)
        })
    }

    on("clicked:repeating_limit:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

    on("clicked:repeating_song:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

    on("clicked:repeating_primary:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

    on("clicked:repeating_ninjutsu:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

    on("clicked:repeating_secondary:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

    on("clicked:repeating_instant:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

    on("clicked:repeating_technique:info", eventInfo => {
        toggleExpandedStateInSection(eventInfo)
    })

</script>

<script type="text/worker">

    function getAttrsAndEffects(bonusAttributes, completion) {
        getSectionIDs("repeating_effects", ids => {
            const attributes = ids.flatMap((element) => [
                `repeating_effects_${element}_type`,
                `repeating_effects_${element}_value`,
                `repeating_effects_${element}_expiry`
            ])
            getAttrs(attributes.concat(bonusAttributes), values => {
                var sortedValues = {}
                const effectKeys = Object.keys(values).filter((key) => key.includes("repeating_effects"))
                for (let attribute of effectKeys) {
                    let components = attribute.split("_")
                    let id = components[2]
                    let attributeName = components[3]
                    if (!sortedValues[id]) {
                        sortedValues[id] = {}
                    }
                    sortedValues[id][attributeName] = values[attribute]
                }
                const valueObjects = Object.values(sortedValues)
                completion(values, valueObjects)
            })
        })
    }

    function getEffects(completion) {
        getAttrsAndEffects([], (values, effects) => {
            completion(effects)
        })
    }

    function getCriticalThreshold(effects) {
        let criticalUp = effects.find((effect) => effect.type == "critical(x)")
        if (criticalUp && criticalUp.value) {
            return 20 - parseInt(criticalUp.value)
        }
        return 20
    }

    function addEffectsToRoll(effects, rollMacro, rollType) {
        var penalty = 0
        var hasParalysis = false
        var criticalUp = 0
        var attributeUp = {}
        for (let effect of effects) {
            switch (effect.type) {
                case "attribute(x)":
                    const attributeDefinition = effect.value.trim()
                    var match = attributeDefinition.match(/^\-?\d+/)
                    if (!match) {
                        match = attributeDefinition.match(/\-?\d+$/)
                    }
                    if (!match) {
                        console.log("Invalid attribute declaration will not be added to roll " + attributeDefinition)
                        break
                    }
                    const value = parseInt(match[0])
                    const attribute = attributeDefinition.replace(match[0], "").trim().toLowerCase()
                    attributeUp[attribute] = value
                    break
                case "blind":
                    penalty += 2
                    break
                case "brink":
                    penalty += 5
                    break
                case "critical(x)":
                    if (effect.value) {
                        criticalUp += parseInt(effect.value)
                    }
                    break
                case "paralyzed":
                    if (rollType == "primary") {
                        hasParalysis = true
                    }
                    break
                case "petrified":
                    penalty += 5
                    break
                case "prone":
                    penalty += 2
                    break
                case "sleep":
                    penalty += 3
                    break
                case "slow":
                    penalty += 2
                    break
                case "stun":
                    penalty += 5
                    break
                case "weak":
                    penalty += 2
                    break
            }
        }
        var updatedMacro = rollMacro
        if (hasParalysis) {
            updatedMacro = updatedMacro.replace(/cs\>?20/, "cs>20cf<5[chance of paralysis]")
        }
        if (criticalUp > 0) {
            updatedMacro = updatedMacro.replace(/cs\>?20/, `cs>${20 - criticalUp}`)
        }
        if (penalty > 0) {
            updatedMacro = `${updatedMacro} - ${penalty}[penalty]`
        }
        const matches = [...updatedMacro.matchAll(/@\{([a-z]{3})\}/g)]
        for (let match of matches) {
            const attributeName = match[1]
            const attributeValue = attributeUp[attributeName]
            if (!attributeValue) {
                continue
            }
            updatedMacro = updatedMacro.replace(
                match[0], 
                `${match[0]}[${attributeName.toUpperCase()}] + ${attributeUp[attributeName]}[${attributeName.toUpperCase()} bonus]`
            )
        }
        return updatedMacro
    }

    function templateValues(title, value) {
        if (value) {
            return [title, value]
        }
        return ["", ""]
    }

    function spendResource(cost, resourceType, value, value_max, attributeName) {
        if (cost > 0 && resourceType && value >= 0 && value_max >= 0) {
            if (value < cost) {
                return [false, `${cost} ${resourceType} - Insufficient (${value}/${value_max})`]
            } else {
                const newValue = value - cost
                var attributes = {}
                attributes[attributeName] = newValue
                setAttrs(attributes)
                const resultString = `Spent ${cost} ${resourceType} (${newValue}/${value_max})`
                console.log(resultString)
                return [true, resultString]
            }
        } else {
            return [false, `${cost} ${resourceType} - Character has no ${resourceType}!`]
        }
    }

    function restoreResource(restoration, resourceType) {
        const values = restoration.split(",")
        var attributes = []
        var summary = "Restored "
        var didRestore = false
        for (let i = 0; i < values.length; i++) {
            const parts = values[i].trim().split(" ")
            if (parts.length != 2) {
                console.log("Invalid restore declaration " + values[i])
                continue
            }
            const typeForValue = parts[1].toLowerCase()
            if (typeForValue == "mp") {
                didRestore = true
                attributes.push({
                    name: "magicPoints",
                    value: parts[0]
                })
                summary += `${parts[0]} MP, `
            } else if (typeForValue == "hp") {
                didRestore = true
                attributes.push({
                    name: "hitpoints",
                    value: parts[0]
                })
                summary += `${parts[0]} HP, `
            } else if (resourceType && typeForValue == resourceType.toLowerCase()) {
                didRestore = true
                attributes.push({
                    name: "resourceValue",
                    value: parts[0]
                })
                summary += `${parts[0]} ${resourceType}, `
            }
        }

        if (!didRestore) {
            return ""
        }

        const attributeNames = attributes.flatMap((element) => [element.name, element.name + "_max"])
        getAttrs(attributeNames, values => {
            var newValues = {}
            for (let attribute of attributes) {
                const value = values[attribute.name]
                const max = values[attribute.name + "_max"]
                const sum = +value + +attribute.value
                const newValue = Math.min(sum, max)
                newValues[attribute.name] = newValue
                console.log("Restored " + attribute.name + " to " + newValue)
            }
            setAttrs(newValues)
        })

        return summary.substring(0, summary.length - 2)
    }

    function performAbilityResourceChanges(section, rowId, values) {
        const cost = values[`repeating_${section}_${rowId}_cost`]
        const resourceType = values[`repeating_${section}_${rowId}_resource`]
        const uses = values[`repeating_${section}_${rowId}_uses`]
        const usesMax = values[`repeating_${section}_${rowId}_uses_max`]
        const restoration = values[`repeating_${section}_${rowId}_restore`]
        
        var resourceCost = ""
        var resourceResult = false
        if (cost > 0) {
            if (resourceType.toLowerCase() == "mp") {
                let result = spendResource(
                    cost, 
                    resourceType, 
                    values.magicPoints, 
                    values.magicPoints_max, 
                    "magicPoints"
                )
                resourceResult = result[0]
                resourceCost = result[1]
            } else {
                let result = spendResource(
                    cost,
                    resourceType,
                    values.resourceValue,
                    values.resourceValue_max,
                    "resourceValue"
                )
                resourceResult = result[0]
                resourceCost = result[1]
            }
        }
        if (resourceResult) {
            // Spend uses if there are any
            if (usesMax > 0) {
                let result = spendResource(
                    1,
                    "uses",
                    uses,
                    usesMax,
                    `repeating_${section}_${rowId}_uses`
                )
                if (result[1]) {
                    resourceCost += `\n${result[1]}`
                }
            }
        }

        // Restore resources
        if (restoration && (resourceResult || cost == 0)) {
            const restorationSummary = restoreResource(restoration, resourceType)
            if (resourceCost) {
                resourceCost += `\n${restorationSummary}`
            } else {
                resourceCost = restorationSummary
            }
        }

        return resourceCost
    }

    function stringWithTitle(title, value) {
        if (value) {
            return `${title} ${value}`
        }
        return ""
    }

    function applyAdvantageToDice(advantage, dice) {
        if (advantage == 0) {
            return dice
        }
        if (!dice.includes("d")) {
            return dice
        }
        const highOrLow = advantage > 0 ? "kh" : "kl"
        const multiplier = Math.abs(advantage) + 1

        var searchString = dice
        var newDice = ""
        var index
        while ((index = searchString.indexOf("d")) >= 0) {
            let numberOfDice
            if (index == 0) {
                numberOfDice = 1
                searchString = `1${searchString}`
                index = 1
            } else {
                newDice += searchString.substring(0, index - 1)
                numberOfDice = searchString.substring(index - 1, index)
            }
            const numberOfDiceWithMultiplier = numberOfDice * multiplier

            // Find end of roll
            let match = /[\-+* \/\)]/.exec(searchString.substring(index))
            if (match) {
                const matchIndex = match.index + index
                newDice += `${numberOfDiceWithMultiplier}${searchString.substring(index, matchIndex)}${highOrLow}${numberOfDice}`
                searchString = searchString.substring(matchIndex)
            } else {
                newDice += `${numberOfDiceWithMultiplier}${searchString.substring(index).trim()}${highOrLow}${numberOfDice}`
                searchString = ""
                break
            }
        }
        newDice += searchString
        return newDice
    }

    // Roll stat
    function rollStat(stat, statName) {
        getAttrsAndEffects([
            "d20"
        ], (values, effects) => {
            var roll = `${values.d20} + @{${stat}}`
            roll = addEffectsToRoll(effects, roll, "stat")

            startRoll(`&{template:default} {{name=${statName}}} {{Result=[[${roll}]]}}`, results => {
                finishRoll(results.rollId)
            })
        })
    }

    // Share ability details to chat
    function shareAbility(eventInfo) {
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]
        getAttrs([
            `repeating_${section}_${rowId}_icon`,
            `repeating_${section}_${rowId}_title`,
            `repeating_${section}_${rowId}_type`,
            `repeating_${section}_${rowId}_cost`,
            `repeating_${section}_${rowId}_resource`,
            `repeating_${section}_${rowId}_condition`,
            `repeating_${section}_${rowId}_trigger`,

            `repeating_${section}_${rowId}_target`,
            `repeating_${section}_${rowId}_range`,
            `repeating_${section}_${rowId}_check`,
            `repeating_${section}_${rowId}_cr`,

            `repeating_${section}_${rowId}_baseEffect`,
            `repeating_${section}_${rowId}_directHit`,
            `repeating_${section}_${rowId}_limitation`
        ], values => {
            const icon = values[`repeating_${section}_${rowId}_icon`]
            const title = values[`repeating_${section}_${rowId}_title`]
            const type = templateValues("Type:", values[`repeating_${section}_${rowId}_type`])
            const condition = templateValues("Condition:", values[`repeating_${section}_${rowId}_condition`])
            const trigger = templateValues("Trigger:", values[`repeating_${section}_${rowId}_trigger`])
            const target = templateValues("Target:", values[`repeating_${section}_${rowId}_target`])
            const range = templateValues("Range:", values[`repeating_${section}_${rowId}_range`])
            const check = templateValues("Check:", values[`repeating_${section}_${rowId}_check`])
            const cr = templateValues("CR:", values[`repeating_${section}_${rowId}_cr`])
            const baseEffect = templateValues("Base Effect:", values[`repeating_${section}_${rowId}_baseEffect`])
            const directHit = templateValues("Direct Hit:", values[`repeating_${section}_${rowId}_directHit`])
            const limitation = templateValues("Limitation:", values[`repeating_${section}_${rowId}_limitation`])

            var cost = templateValues("Cost:", values[`repeating_${section}_${rowId}_cost`])
            var resourceType = values[`repeating_${section}_${rowId}_resource`]
            if (cost[1] <= 0) {
                cost = ["", ""]
                resourceType = ""
            }

            startRoll(`&{template:ability} {{icon=[icon](${icon})}} {{name=${title}}} {{costTitle=${cost[0]}}} {{cost=${cost[1]}}} {{resourceType=${resourceType}}}` +
            `{{typeTitle=${type[0]}}} {{type=${type[1]}}} {{conditionTitle=${condition[0]}}} {{condition=${condition[1]}}}` +
            `{{triggeTitle=${trigger[0]}}} {{trigger=${trigger[1]}}} {{targetTitle=${target[0]}}} {{target=${target[1]}}}` +
            `{{rangeTitle=${range[0]}}} {{range=${range[1]}}} {{checkTitle=${check[0]}}} {{check=${check[1]}}}` +
            `{{crTitle=${cr[0]}}} {{cr=${cr[1]}}} {{baseEffectTitle=${baseEffect[0]}}} {{baseEffect=${baseEffect[1]}}}` +
            `{{directHitTitle=${directHit[0]}}} {{directHit=${directHit[1]}}} {{limitationTitle=${limitation[0]}}} {{limitation=${limitation[1]}}}`, results => {
                finishRoll(results.rollId)
            })
        })
    }

    // Roll ability
    function activateAbility(eventInfo) {
        console.log("Activate ability " + JSON.stringify(eventInfo))
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]

        getAttrsAndEffects([
            `repeating_${section}_${rowId}_icon`,
            `repeating_${section}_${rowId}_title`,
            `repeating_${section}_${rowId}_type`,
            `repeating_${section}_${rowId}_cost`,
            `repeating_${section}_${rowId}_resource`,
            `repeating_${section}_${rowId}_condition`,
            `repeating_${section}_${rowId}_trigger`,
            `repeating_${section}_${rowId}_uses`,
            `repeating_${section}_${rowId}_uses_max`,

            `repeating_${section}_${rowId}_target`,
            `repeating_${section}_${rowId}_range`,

            `repeating_${section}_${rowId}_baseEffect`,
            `repeating_${section}_${rowId}_directHit`,

            `repeating_${section}_${rowId}_stat`,
            `repeating_${section}_${rowId}_damageType`,
            `repeating_${section}_${rowId}_hitType`,
            `repeating_${section}_${rowId}_hitDie`,
            `repeating_${section}_${rowId}_cr`,
            `repeating_${section}_${rowId}_restore`,
            `repeating_${section}_${rowId}_combo`,

            "str", "dex", "vit", "int", "mnd",
            "magicPoints", "magicPoints_max", "resourceValue", "resourceValue_max",
            "advantage", "character_name"
        ], (values, effects) => {
            // Perform roll
            const title = values[`repeating_${section}_${rowId}_title`]
            const icon = values[`repeating_${section}_${rowId}_icon`]
            const usesMax = values[`repeating_${section}_${rowId}_uses_max`]

            const cost = values[`repeating_${section}_${rowId}_cost`]
            const resourceType = values[`repeating_${section}_${rowId}_resource`]

            const statType = values[`repeating_${section}_${rowId}_stat`].toLowerCase()
            const damageType = values[`repeating_${section}_${rowId}_damageType`]
            const hitType = values[`repeating_${section}_${rowId}_hitType`]
            const restoration = values[`repeating_${section}_${rowId}_restore`]
            const statValue = values[statType]
            const baseEffect = values[`repeating_${section}_${rowId}_baseEffect`]
            const directHit = values[`repeating_${section}_${rowId}_directHit`]

            const combo = values[`repeating_${section}_${rowId}_combo`]

            setAttrs({
                currentCombo: "" // Reset combo indicators
            })
            const crString = stringWithTitle("CR:", values[`repeating_${section}_${rowId}_cr`])
            const typeString = stringWithTitle("Type:", values[`repeating_${section}_${rowId}_type`])
            const conditionString = stringWithTitle("Condition:", values[`repeating_${section}_${rowId}_condition`])
            const triggerString = stringWithTitle("Trigger:", values[`repeating_${section}_${rowId}_trigger`])

            var hitDie = values[`repeating_${section}_${rowId}_hitDie`]
            hitDie = applyAdvantageToDice(values.advantage, hitDie)

            var hitTitle = ""
            var hitDefinition = ""
            var button = ""
            if (hitType != "None" && hitDie) {
                hitTitle = `${hitType}: `
                if (statValue > 0) {
                    hitDie = `${hitDie} + @{${statType}}`
                }
                hitDie = addEffectsToRoll(effects, hitDie, section)
                hitDefinition = `[[${hitDie}]]`

                var battleButton = ""
                if (effects.some((effect) => effect.type == "battle(x)")) {
                    battleButton = ` [${damageType} + Roll Up(X)](~${values.character_name}|repeating_${section}_${rowId}_rollbattlelitany)`
                }
                button = `[${damageType}](~${values.character_name}|repeating_${section}_${rowId}_rolldamage)${battleButton}`
                console.log(button)
            } else if (cost > 0 || usesMax > 0 || restoration || combo) {
                button = `[Effect](~${values.character_name}|repeating_${section}_${rowId}_rolldamage)`
            }

            var directHitTitle = ""
            if (directHit) {
                directHitTitle = "Direct Hit:"
            }

            var attributes = {}
            attributes[`repeating_${section}_${rowId}_currentRoll`] = ""
            setAttrs(attributes)

            console.log(`&{template:hit} {{icon=[icon](${icon})}} {{name=${title}}} ` +
            `{{type=${typeString}}} {{condition=${conditionString}}} {{trigger=${triggerString}}} ` +
            `{{hitTitle=${hitTitle}}} {{hit=${hitDefinition}}} {{cr=${crString}}} {{baseEffect=${baseEffect}}} ` +
            `{{directHitTitle=${directHitTitle}}} {{directHit=${directHit}}} {{button=${button}}}`)
            startRoll(`&{template:hit} {{icon=[icon](${icon})}} {{name=${title}}} ` +
            `{{type=${typeString}}} {{condition=${conditionString}}} {{trigger=${triggerString}}} ` +
            `{{hitTitle=${hitTitle}}} {{hit=${hitDefinition}}} {{cr=${crString}}} {{baseEffect=${baseEffect}}} ` +
            `{{directHitTitle=${directHitTitle}}} {{directHit=${directHit}}} {{button=${button}}}`, results => {
                var hitRoll = results.results.hit
                if (!hitRoll) {
                    hitRoll = {
                        result: undefined,
                        dice: undefined,
                        expression: undefined
                    }
                }
                const hitValue = hitRoll.result
                if (hitRoll.dice) {
                    var die
                    if (hitRoll.expression.includes("kl")) {
                        die = Math.min(...hitRoll.dice)
                    }
                    else {
                        die = Math.max(...hitRoll.dice)
                    }
                    attributes[`repeating_${section}_${rowId}_currentRoll`] = die
                }
                setAttrs(attributes)

                finishRoll(results.rollId)
            })
        })
    }

    function rollDamage(useLitany, eventInfo) {
        console.log("Roll damage " + JSON.stringify(eventInfo))
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]
        getAttrsAndEffects([
            `repeating_${section}_${rowId}_damageType`,
            `repeating_${section}_${rowId}_baseValue`,
            `repeating_${section}_${rowId}_dhValue`,
            `repeating_${section}_${rowId}_combo`,
            `repeating_${section}_${rowId}_currentRoll`,

            `repeating_${section}_${rowId}_cost`,
            `repeating_${section}_${rowId}_uses`,
            `repeating_${section}_${rowId}_uses_max`,
            `repeating_${section}_${rowId}_restore`,
            `repeating_${section}_${rowId}_resource`,

            "magicPoints", "magicPoints_max", "resourceValue", "resourceValue_max",
            "character_name"
        ], (values, effects) => {
            const baseValue = values[`repeating_${section}_${rowId}_baseValue`]
            const directHitValue = values[`repeating_${section}_${rowId}_dhValue`]
            const damageType = values[`repeating_${section}_${rowId}_damageType`]
            const combo = values[`repeating_${section}_${rowId}_combo`]
            const roll = parseInt(values[`repeating_${section}_${rowId}_currentRoll`])

            var litanyValue = 0
            if (useLitany) {
                litanyValue = effects.reduce(
                    (accumulator, currentValue) => {
                        if (currentValue.type != "battle(x)") {
                            return accumulator
                        }
                        if (currentValue.value) {
                            return accumulator + parseInt(currentValue.value)
                        }
                        return accumulator
                    }, 0
                )
            }

            var criticalMultiplier = 1
            if (roll) {
                const criticalThreshold = getCriticalThreshold(effects)
                criticalMultiplier = roll + litanyValue >= criticalThreshold ? 2 : 1
            }

            // Add crit multiplier to other dice rolls
            var baseValueWithMultipliers = baseValue
            if (baseValue.includes("d")) {
                baseValueWithMultipliers = "[[" + criticalMultiplier + "[crit multiplier] * " + baseValue[0] + "]]" + baseValue.substring(1)
            }
            var directHitValueWithMultipliers = directHitValue
            if (directHitValue.includes("d")) {
                directHitValueWithMultipliers = "[[" + criticalMultiplier + "[crit multiplier] * " + directHitValue[0] + "]]" + directHitValue.substring(1)
            }

            var damageTitle = ""
            var damageDice = ""
            if (baseValueWithMultipliers) {
                damageTitle = `${damageType}: `
                damageDice = `[[${baseValueWithMultipliers}]]`
            }
            var directHitTitle = ""
            var directHitDice = ""
            var totalTitle = ""
            if (directHitValueWithMultipliers) {
                directHitTitle = "Direct Hit: "
                directHitDice = `[[${directHitValueWithMultipliers}]]`
            }

            var totalTitle = ""
            if (directHitValueWithMultipliers && baseValueWithMultipliers) {
                totalTitle = `Full ${damageTitle}`
            }

            var button = ""
            var comboTitle = ""
            if (combo) {
                setAttrs({
                    currentCombo: combo
                })
                var choices = [combo]
                comboTitle = "Combo:"
                if (combo.includes("|")) {
                    choices = combo.split("|")
                }
                for (let i = 0; i < choices.length; i++) {
                    button += `[${choices[i].trim()}](~${values.character_name}|repeating_${section}_${rowId}_runcombo${i + 1})`
                }
            }

            const resourceCost = performAbilityResourceChanges(section, rowId, values)

            if (!damageDice && !directHitDice && !combo && !resourceCost) {
                console.log("No reason to roll damage")
                return
            }

            // Roll damage
            console.log(`&{template:damage} {{damageTitle=${damageTitle}}} {{damage=${damageDice}}} ` + 
            `{{directHitTitle=${directHitTitle}}} {{directHit=${directHitDice}}} {{totalTitle=${totalTitle}}}` +
            `{{comboTitle=${comboTitle}}} {{button=${button}}} {{cost=${resourceCost}}}`)
            startRoll(`&{template:damage} {{damageTitle=${damageTitle}}} {{damage=${damageDice}}} ` + 
            `{{directHitTitle=${directHitTitle}}} {{directHit=${directHitDice}}} {{totalTitle=${totalTitle}}}` +
            `{{comboTitle=${comboTitle}}} {{button=${button}}} {{cost=${resourceCost}}}`, results => {
                const damageRoll = results.results.damage
                const directHitRoll = results.results.directHit
                var total = ""
                if (damageRoll) {
                    total = damageRoll.result
                }
                if (damageRoll && directHitRoll) {
                    total = damageRoll.result + directHitRoll.result
                }
                var attributes = {}
                attributes[`repeating_${section}_${rowId}_currentCriticalMultiplier`] = 1
                setAttrs(attributes)
                
                finishRoll(
                    results.rollId,
                    {
                        damage: total
                    }
                )
            })
        })
    }

    function activateCombo(eventInfo, index) {
        const sourceAttributes = eventInfo.sourceAttribute.split("_")
        const section = sourceAttributes[1]
        const rowId = sourceAttributes[2]
        console.log("Combo activated " + JSON.stringify(eventInfo))
        getAttrs([
            `repeating_${section}_${rowId}_combo`,
        ], values => {
            const combo = values[`repeating_${section}_${rowId}_combo`]
            var abilityName = combo.trim().toLowerCase()
            if (combo.includes("|")) {
                const choices = combo.split("|")
                if (index < choices.length) {
                    abilityName = choices[index].trim().toLowerCase()
                } else {
                    console.log(`Combo index out of bonds: selected ${index}, not in ${combo}`)
                    return
                }
            }
            getSectionIDs(`repeating_${section}`, ids => {
                const attributes = ids.map((element) => `repeating_${section}_${element}_title`)
                getAttrs(attributes, values => {
                    for (let i = 0; i < ids.length; i++) {
                        const id = ids[i]
                        const attribute = attributes[i]
                        if (values[attribute].trim().toLowerCase() == abilityName) {
                            const triggerEvent = {
                                sourceAttribute: `repeating_${section}_${id}_runcomboFrom_${rowId}`
                            }
                            console.log("Activating " + abilityName)
                            activateAbility(triggerEvent)
                            return
                        }
                    }
                    console.log("Couldn't find ability with name " + abilityName)
                })
            })
        })
    }

    on("clicked:rollStr", eventInfo => {
        rollStat("str", "Strength")
    })

    on("clicked:rollDex", eventInfo => {
        console.log("rolled dex")
        rollStat("dex", "Dexterity")
    })

    on("clicked:rollVit", eventInfo => {
        rollStat("vit", "Vitality")
    })

    on("clicked:rollInt", eventInfo => {
        rollStat("int", "Intelligence")
    })

    on("clicked:rollMnd", eventInfo => {
        rollStat("mnd", "Mind")
    })

    on("clicked:repeating_limit:share", eventInfo => {
        shareAbility(eventInfo)
    })

    on("clicked:repeating_song:share", eventInfo => {
        shareAbility(eventInfo)
    })

    on("clicked:repeating_primary:share", eventInfo => {
        shareAbility(eventInfo)
    })

    on("clicked:repeating_ninjutsu:share", eventInfo => {
        shareAbility(eventInfo)
    })

    on("clicked:repeating_secondary:share", eventInfo => {
        shareAbility(eventInfo)
    })

    on("clicked:repeating_instant:share", eventInfo => {
        shareAbility(eventInfo)
    })

    on("clicked:repeating_technique:share", eventInfo => {
        shareAbility(eventInfo)
    })

    on("clicked:repeating_limit:trigger", eventInfo => {
        activateAbility(eventInfo)
    })

    on("clicked:repeating_song:trigger", eventInfo => {
        activateAbility(eventInfo)
    })

    on("clicked:repeating_primary:trigger", eventInfo => {
        activateAbility(eventInfo)
    })

    on("clicked:repeating_ninjutsu:trigger", eventInfo => {
        activateAbility(eventInfo)
    })

    on("clicked:repeating_secondary:trigger", eventInfo => {
        activateAbility(eventInfo)
    })

    on("clicked:repeating_instant:trigger", eventInfo => {
        activateAbility(eventInfo)
    })

    on("clicked:repeating_technique:trigger", eventInfo => {
        activateAbility(eventInfo)
    })

    on("clicked:repeating_limit:rolldamage", eventInfo => {
        rollDamage(false, eventInfo)
    })

    on("clicked:repeating_song:rolldamage", eventInfo => {
        rollDamage(false, eventInfo)
    })

    on("clicked:repeating_primary:rolldamage", eventInfo => {
        rollDamage(false, eventInfo)
    })

    on("clicked:repeating_ninjutsu:rolldamage", eventInfo => {
        rollDamage(false, eventInfo)
    })

    on("clicked:repeating_secondary:rolldamage", eventInfo => {
        rollDamage(false, eventInfo)
    })

    on("clicked:repeating_instant:rolldamage", eventInfo => {
        rollDamage(false, eventInfo)
    })

    on("clicked:repeating_technique:rolldamage", eventInfo => {
        rollDamage(false, eventInfo)
    })

    on("clicked:repeating_limit:rollbattlelitany", eventInfo => {
        rollDamage(true, eventInfo)
    })

    on("clicked:repeating_song:rollbattlelitany", eventInfo => {
        rollDamage(true, eventInfo)
    })

    on("clicked:repeating_primary:rollbattlelitany", eventInfo => {
        rollDamage(true, eventInfo)
    })

    on("clicked:repeating_ninjutsu:rollbattlelitany", eventInfo => {
        rollDamage(true, eventInfo)
    })

    on("clicked:repeating_secondary:rollbattlelitany", eventInfo => {
        rollDamage(true, eventInfo)
    })

    on("clicked:repeating_instant:rollbattlelitany", eventInfo => {
        rollDamage(true, eventInfo)
    })

    on("clicked:repeating_technique:rollbattlelitany", eventInfo => {
        rollDamage(true, eventInfo)
    })

    on("clicked:repeating_limit:runcombo1", eventInfo => {
        activateCombo(eventInfo, 0)
    })

    on("clicked:repeating_song:runcombo1", eventInfo => {
        activateCombo(eventInfo, 0)
    })

    on("clicked:repeating_primary:runcombo1", eventInfo => {
        activateCombo(eventInfo, 0)
    })

    on("clicked:repeating_ninjutsu:runcombo1", eventInfo => {
        activateCombo(eventInfo, 0)
    })

    on("clicked:repeating_secondary:runcombo1", eventInfo => {
        activateCombo(eventInfo, 0)
    })

    on("clicked:repeating_instant:runcombo1", eventInfo => {
        activateCombo(eventInfo, 0)
    })

    on("clicked:repeating_technique:runcombo1", eventInfo => {
        activateCombo(eventInfo, 0)
    })

    on("clicked:repeating_limit:runcombo2", eventInfo => {
        activateCombo(eventInfo, 1)
    })

    on("clicked:repeating_song:runcombo2", eventInfo => {
        activateCombo(eventInfo, 1)
    })

    on("clicked:repeating_primary:runcombo2", eventInfo => {
        activateCombo(eventInfo, 1)
    })

    on("clicked:repeating_ninjutsu:runcombo2", eventInfo => {
        activateCombo(eventInfo, 1)
    })

    on("clicked:repeating_secondary:runcombo2", eventInfo => {
        activateCombo(eventInfo, 1)
    })

    on("clicked:repeating_instant:runcombo2", eventInfo => {
        activateCombo(eventInfo, 1)
    })

    on("clicked:repeating_technique:runcombo2", eventInfo => {
        activateCombo(eventInfo, 1)
    })

</script>

<script type="text/worker">
    function getIconForEffectType(type) {
        switch (type) {
            case "advantage": return "https://xivapi.com/i/215000/215711.png"
            case "attribute(x)": return "https://xivapi.com/i/215000/215075.png"
            case "battle(x)": return "https://xivapi.com/i/215000/215612.png"
            case "blind": return "https://xivapi.com/i/215000/215012.png"
            case "bound": return "https://xivapi.com/i/215000/215003.png"
            case "brink": return "https://xivapi.com/i/215000/215011.png"
            case "comatose": return "https://xivapi.com/i/215000/215559.png"
            case "critical(x)": return "https://xivapi.com/i/215000/215952.png"
            case "dot(x)": return "https://xivapi.com/i/215000/215530.png"
            case "enmity(x)": return "https://xivapi.com/i/214000/214155.png"
            case "heavy": return "https://xivapi.com/i/215000/215002.png"
            case "paralyzed": return "https://xivapi.com/i/215000/215006.png"
            case "petrified": return "https://xivapi.com/i/215000/215001.png"
            case "prone": return "https://xivapi.com/i/215000/215724.png"
            case "ready(x)": return "https://xivapi.com/i/216000/216002.png"
            case "regen(x)": return "https://xivapi.com/i/212000/212626.png"
            case "silence": return "https://xivapi.com/i/215000/215005.png"
            case "sleep": return "https://xivapi.com/i/215000/215013.png"
            case "slow": return "https://xivapi.com/i/215000/215009.png"
            case "stun": return "https://xivapi.com/i/215000/215004.png"
            case "unstunnable": return "https://xivapi.com/i/215000/215540.png"
            case "weak": return "https://xivapi.com/i/215000/215010.png"
            default: return ""
        }
    }

    // Effect icon assignment
    on("change:repeating_effects:type", () => {
        getAttrs(["repeating_effects_type"], values => {
            const iconUrl = getIconForEffectType(values.repeating_effects_type)
            setAttrs({
                repeating_effects_icon: iconUrl
            })
        })
    })
</script>

<rolltemplate class="sheet-rolltemplate-ability">
    <div class="sheet-ability-template">
        <div class="sheet-header sheet-list">
            <div class="sheet-header-title">
                <div class="sheet-ability-icon">
                    {{icon}}
                </div>
                <div class="sheet-title">
                    <span class="sheet-bold">{{name}}</span>
                </div>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">Type:</span>
                <span class="sheet-mini-input sheet-floatLeft sheet-italic">{{type}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{costTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{cost}}</span>
                <span class="sheet-mini-input sheet-floatLeft" style="margin-left: 4px;">{{resourceType}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{conditionTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{condition}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{triggerTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{trigger}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{targetTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{target}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{rangeTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{range}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{checkTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft sheet-bold">{{check}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{crTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{cr}}</span>
            </div>
        </div>
        <div class="sheet-body">
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{baseEffectTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{baseEffect}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{directHitTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{directHit}}</span>
            </div>
            <div>
                <span class="sheet-mini-title sheet-floatLeft">{{limitationTitle}}</span>
                <span class="sheet-mini-input sheet-floatLeft">{{limitation}}</span>
            </div>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-hit">
    <div class="sheet-ability-template">
        <div class="sheet-header">
            <div class="sheet-header-title">
                <div class="sheet-ability-icon">
                    {{icon}}
                </div>
                <div class="sheet-title">
                    <span class="sheet-bold">{{name}}</span>
                </div>
            </div>
            <h4>{{cost}}</h4>
            <h4>{{type}}</h4>
        </div>
        <div class="sheet-body">
            <div>
                <span class="sheet-mini-title">Base Effect:</span>
                <span class="sheet-mini-input">{{baseEffect}}</span>
            </div>
            <div>
                <span class="sheet-mini-title">{{directHitTitle}}</span>
                <span class="sheet-mini-input">{{directHit}}</span>
            </div>
            <h4>{{hitTitle}}{{hit}}</h4>
            <h4>{{cr}}</h4>
            <div>{{button}}</div>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-damage">
    <div class="sheet-template-container">
        <div class="sheet-header">
            <div>
                <span class="sheet-mini-input sheet-floatLeft">{{cost}}</span>
            </div>
            <h4>{{damageTitle}}{{damage}}</h4>
            <h4>{{directHitTitle}}{{directHit}}</h4>
        </div>
        <div class="sheet-body">
            <h4>{{totalTitle}}{{computed::damage}}</h4>
            <div class="sheet-button-container">
                {{button}}
            </div>
        </div>
    </div>
</rolltemplate>
